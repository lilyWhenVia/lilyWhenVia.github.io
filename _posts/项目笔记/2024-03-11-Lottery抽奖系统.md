---
layout: Â  Â  post
title: Â  Â  Â 2024-06-11-LotteryæŠ½å¥–ç³»ç»Ÿ
subtitle: Â  2024-06-11-LotteryæŠ½å¥–ç³»ç»Ÿ
date: Â  Â  Â  2024-06-11 05:53
author: Â  Â  lily
header-img: img/é¡¹ç›®ç¬”è®°.jpg
catalog: Â  Â true
tags:
Â  Â  - é¡¹ç›®ç¬”è®°
---
# æŠ½å¥–é¡¹ç›®ç®€ä»‹

å‚è€ƒæ–‡ç« ï¼š
1. [xfgåšå®¢å›­](https://www.cnblogs.com/xiaofuge/p/17897727.html)
2. [æŠ½å¥–ç³»ç»Ÿè®¾è®¡](https://www.woshipm.com/operate/735517.html)

ä¸€ä¸ªæŠ½å¥–ï¼Œæƒ³è®©ç”¨æˆ·åˆç†çš„åˆ«ä¸­å¥–ï¼ˆå“ç‰Œæ–¹ä¸èƒ½äºæŸï¼‰ï¼Œåˆè¦èƒ½è¾¾åˆ°æ‹‰æ–°ä¿ƒæ´»çš„æ•ˆæœã€æé«˜å¹³å°æ›å…‰é‡çš„éœ€æ±‚ï¼ˆkeepä¹‹å‰å°±æœ‰ä¸€ä¸ªè·‘æ­¥æŠ½å¥–çš„æ´»åŠ¨å¾ˆå‡ºåœˆï¼‰ï¼Œå¹¶ä¸”æŠ½å¥–ç»†èŠ‚ä»å…¶è®¾è®¡åˆ°è½åœ°å®ç°éƒ½æ˜¯éœ€è¦ç²¾ç»†åŒ–æ§åˆ¶æˆæœ¬çš„ã€‚

ç°åœ¨å„ä¸ªäº’è”ç½‘äº§å“åœºæ™¯ä¸­ï¼Œéƒ½æœ‰æŠ½å¥–æ¨¡å—æ¥æ‹‰æ–°ä¿ƒæ´»ï¼Œå¦‚ï¼›å¹³å°ç­¾åˆ°ç§¯åˆ†æŠ½å¥–ã€å•†åŸæ”¯ä»˜å®ŒæˆæŠ½å¥–ã€æ‰“è½¦ä¼˜æƒ å‘åˆ¸æŠ½å¥–éƒ½éœ€ä¾èµ–æŠ½å¥–æ¨¡å—

> 	"ä½ ä»¥ä¸ºä½ ç©çš„æ˜¯æŠ½å¥–ï¼Œä½†å…¶å®ç©çš„æ˜¯ä½ å¯¹äººæ€§çš„ç†è§£ï¼è¿™ä¹Ÿæ˜¯è¥é”€ä¸­æœ€å¤æ‚çš„äº§å“è¿è¥è®¾å®šï¼Œæ—¢è¦è®©ç”¨æˆ·ç©çš„å¼€å¿ƒï¼Œåˆæœ‰è®©å¹³å°æœ‰çš„èµšã€‚æ‰€ä»¥çºµæ¨ªäº¤é”™é€»è¾‘åŠŸèƒ½å®ç°çš„è¥é”€ç»„ä¹Ÿæ˜¯å„ä¸ªäº’è”ç½‘å…¬å¸ä¸­ä»£ç å®ç°åº¦æœ€å¤æ‚çš„ç»„ã€‚"
> 						----xgf

å±•ç¤ºç»™ä½ çš„æ˜¯æŠ½å¥–ï¼Œæ²¡å±•ç¤ºç»™ä½ çš„å…¨æ˜¯æ‰‹æ®µï¼

- é¦–æ¬¡ï¼Œå…è´¹æŠ½å¥–ï¼Œå¯è®¾å®šæŠ½å¥–èŒƒå›´ã€‚è®©ä½ ç¬¬ä¸€æ¬¡æŠ½å¥–è¶…è¿‡62.9%ï¼Œç”šè‡³è¾¾åˆ°99%å…¨æ˜¯éšæœºç§¯åˆ†ï¼Œè€Œè¿™ä¸ªéšæœºçš„ç§¯åˆ†æœ‰æ—¶å€™æ°å¥½å¤Ÿä½ æ¶ˆè€—æ‰€å‰©ç§¯åˆ†å®Œæˆä¸€æ¬¡æŠ½å¥–ã€‚
- è€Œåï¼Œéšæœºç§¯åˆ†ï¼Œä¹Ÿæ˜¯è¿œå°äºæ‰€éœ€æŠ½å¥–çš„ç§¯åˆ†ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†æ¶ˆè€—ä½ çš„ç§¯åˆ†å€¼ã€‚100ç§¯åˆ†ï¼Œæœ€åå¾—åˆ°20ç§¯åˆ†ã€‚ç±»ä¼¼æ–—åœ°ä¸»æ¯æŠŠéƒ½æœ‰å…¥åœºè´¹ã€‚
- å†æœ‰ï¼Œå¢åŠ çš„å¤§å¥–æŠ½å¥–ï¼Œå¿…é¡»ç”¨æˆ·æŠ½å¥–næ¬¡åè§£é”ã€‚éƒ½æŠ½å¥–1æ¬¡äº†ï¼Œå†æ¥2æ¬¡å°±è§£é”äº†ã€‚è¿™ä¸ªæ—¶å€™ä½ å°±å¿˜è®°äº†è‡ªå·±è¦èµç§¯åˆ†ï¼ŒæŒ‡å‘ç‚¹ä¸‹10è¿æŠ½ã€‚
- æœ€åï¼Œå†æœ‰ä¸€ä¸ª6000ç§¯åˆ†æ¶ˆè€—å¿…ä¸­å¥–ç­–ç•¥ï¼Œè®©ç”¨æˆ·çŸ¥é“åæ­£æœ€åä¼šå¾—åˆ°ä¸€æ¬¡éç§¯åˆ†çš„å¥–å“ï¼Œèµ¶ç´§æ¢­å“ˆï¼

è¿™äº›ï¼Œè¿˜åªæ˜¯ä½ è¡¨é¢èƒ½çœ‹è§äº†çš„ï¼Œçœ‹ä¸è§çš„è¿˜æœ‰ä¸€äº›é…ç½®çš„æ‰‹æ®µã€‚æ¯”å¦‚ä½ æ˜¯ä¸ªè€ç¾Šæ¯›ç”¨æˆ·ï¼Œé‚£ä¹ˆä½ çš„æŠ½å¥–æ ¹æœ¬å°±æ˜¯ä¸ªæ‘†è®¾ï¼Œä½ èƒ½å¾—åˆ°çš„å¥–å“éƒ½æ˜¯é£æ§å…œåº•ï¼Œæ¯”å¦‚100ç§¯åˆ†ï¼ŒæŠ½åˆ°1ç§¯åˆ†ã€‚

è¿™æ ·çš„å¤æ‚ç³»ç»Ÿéå¸¸é€‚åˆä½¿ç”¨ DDD è¿›è¡Œé¢†åŸŸå»ºæ¨¡è®¾è®¡ï¼Œé€šè¿‡é¢†åŸŸçš„æ‹†è§£åˆ†æå¾—åˆ°æ‰€éœ€å¼€å‘çš„å„é¡¹åŠŸèƒ½é¢†åŸŸã€‚é€šè¿‡è¿™æ ·çš„æ‰‹æ®µï¼Œä¹Ÿèƒ½æ›´å¥½çš„ç®¡ç†åç»­éœ€æ±‚çš„è¿­ä»£
# DDDåˆ†å±‚åŸºç¡€

æœ¬é¡¹ç›®æ˜¯åŸºäºDDDæ¶æ„æ­å»ºçš„å¾®æœåŠ¡åˆ†å¸ƒå¼é¡¹ç›®ï¼Œ
DDDåˆ†å±‚æ˜¯é¡¹ç›®åŸºç¡€æ¶æ„è®¾è®¡çš„ä¸€ç§æ¨¡å¼ï¼Œç±»ä¼¼äºwebå¼€å‘ä¸­çš„MVCæ¶æ„ï¼Œæˆ‘è§‰å¾—å°†DDDåˆ†å±‚æ¶æ„ä¸æ›¾ç»å­¦ä¹ è¿‡çš„spring clould Alibabaå¾®æœåŠ¡æ¶æ„ç±»æ¯”ä¼šæ›´ç›¸ä¼¼äº›ã€‚

![[Pasted image 20241120092421.png]]

### ä¸ºä»€ä¹ˆç”¨DDD

DDDç»“æ„å®ƒæ˜¯ä¸€ç§å……è¡€æ¨¡å‹ç»“æ„ï¼Œæ‰€æœ‰çš„æœåŠ¡å®ç°éƒ½ä»¥é¢†åŸŸä¸ºæ ¸å¿ƒï¼Œ
åº”ç”¨å±‚å®šä¹‰æ¥å£ï¼Œé¢†åŸŸå±‚ï¼ˆdomianï¼‰å®ç°æ¥å£ï¼Œ
é¢†åŸŸå±‚ï¼ˆdomianï¼‰å®šä¹‰æ•°æ®ä»“å‚¨ï¼ŒåŸºç¡€å±‚å®ç°æ•°æ®ä»“å‚¨ä¸­å…³äº**DAOå’ŒRedisçš„æ“ä½œ**ï¼Œ
ä½†åŒæ—¶å‡ æ–¹åˆæœ‰äº’ç›¸çš„ä¾èµ–ã€‚

å¦‚æœæŒ‰ç…§æ¨¡å—åŒ–æ‹†åˆ†ï¼Œé‚£ä¹ˆä¼šéœ€è¦åšä¸€äº›å¤„ç†ï¼ŒåŒ…æ‹¬ï¼š

1. åº”ç”¨å±‚ï¼Œä¸å†ç»™é¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼Œè€Œæ˜¯è‡ªè¡Œå¤„ç†å¯¹é¢†åŸŸå±‚æ¥å£çš„åŒ…è£…ã€‚å¦åˆ™é¢†åŸŸå±‚æ—¢å¼•å…¥äº†åº”ç”¨å±‚çš„Jarï¼Œåº”ç”¨å±‚ä¹Ÿå¼•å…¥äº†é¢†åŸŸå±‚çš„Jarï¼Œå°±ä¼šå‡ºç°å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚
2. åŸºç¡€å±‚ä¸­çš„æ•°æ®ä»“å‚¨çš„å®šä¹‰ä¹Ÿéœ€è¦ä»é¢†åŸŸå±‚å‰¥ç¦»ï¼Œå¦åˆ™ä¹Ÿä¼šå‡ºç°å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚
3. RPC å±‚å®šä¹‰æ¥å£æè¿°ï¼ŒåŒ…æ‹¬ï¼šå…¥å‚Reqã€å‡ºå‚Resã€DTOå¯¹è±¡ï¼Œæ¥å£ä¿¡æ¯ï¼Œè¿™äº›å†…å®¹å®šä¹‰å‡ºæ¥çš„Jarç»™æ¥å£å±‚ä½¿ç”¨ï¼Œä¹Ÿç»™å¤–éƒ¨è°ƒç”¨æ–¹ä½¿ç”¨ã€‚

å¦‚ä¸Šï¼Œæ–¹ä¾¿é¡¹ç›®ç®¡ç†å’Œè¿­ä»£...
1. [DDDæ¶æ„å®ç°è§†é¢‘](https://wx.zsxq.com/group/48411118851818/topic/818885581588152)
2. [æŠ½å¥–DDDæ¶æ„æ–‡ç« ](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91/%E7%AC%AC02%E8%8A%82%EF%BC%9A%E6%90%AD%E5%BB%BADDD%E5%9B%9B%E5%B1%82%E6%9E%B6%E6%9E%84)
3. 
## é¡¹ç›®åŸºç¡€æ‰‹è„šæ¶

#### åº”ç”¨å±‚
application
**é€»è¾‘åŒ…è£…ï¼Œå¯¹äºæŠ½å¥–æµç¨‹ç¼–æ’ã€å…¶ä¸­åŒ…æ‹¬æ¯”å¦‚å®šæ—¶ä»»åŠ¡çš„ç¼–æ’ã€é¢†åŸŸäº‹ä»¶çš„æ¶ˆæ¯å‘å¸ƒå’Œè®¢é˜…**
#### é¢†åŸŸå±‚
domian
**å°è£…å…·ä½“çš„ä¸šåŠ¡é¢†åŸŸåŠŸèƒ½å®ç°**ï¼Œæ˜¯èšåˆçš„ï¼Œå……è¡€çš„ã€‚
é¢†åŸŸæ¨¡å‹æœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¨¡å—ã€‚**æ— è®ºæ€ä¹ˆåšDDDçš„åˆ†å±‚æ¶æ„ï¼Œdomain éƒ½æ˜¯è‚¯å®šå­˜åœ¨çš„**ã€‚åœ¨ä¸€å±‚ä¸­ä¼šæœ‰ä¸€ä¸ªä¸ªç»†åˆ†çš„é¢†åŸŸæœåŠ¡ï¼Œåœ¨æ¯ä¸ªæœåŠ¡åŒ…ä¸­ä¼šæœ‰ã€æ¨¡å‹ã€ä»“åº“ã€æœåŠ¡ã€‘è¿™æ ·3éƒ¨åˆ†ã€‚

- ä¸ºéšè—é¢†åŸŸå±‚çš„ä¸šåŠ¡é€»è¾‘å®ç°ï¼Œæ‰€æœ‰é¢†åŸŸæ–¹æ³•å’ŒæœåŠ¡ç­‰å‡é¡»é€šè¿‡é¢†åŸŸæœåŠ¡å¯¹å¤–æš´éœ²ã€‚
- ä¸ºå®ç°å¾®æœåŠ¡å†…èšåˆä¹‹é—´çš„è§£è€¦ï¼ŒåŸåˆ™ä¸Šç¦æ­¢è·¨èšåˆçš„é¢†åŸŸæœåŠ¡è°ƒç”¨å’Œè·¨èšåˆçš„æ•°æ®ç›¸äº’å…³è”ã€‚
    
- service æœåŠ¡è®¾è®¡ï¼›æŠŠä¸€äº›**é‡æ ¸å¿ƒä¸šåŠ¡æ–¹åˆ° service é‡Œå®ç°**ã€‚

#### åŸºç¡€å±‚
infrastructure
åŸºç¡€å±‚ä¾èµ–äº domain é¢†åŸŸå±‚ï¼Œå› ä¸ºåœ¨ domain å±‚å®šä¹‰äº† **ã€mapperã€‘ä»“å‚¨æ¥å£éœ€è¦åœ¨åŸºç¡€å±‚å®ç°**ã€‚
æœ¬èº«é¢†åŸŸå±‚çš„ä¸šåŠ¡å®ç°æ˜¯éœ€è¦ä¾èµ–ï¼Œè¿™æ˜¯ä¾èµ–å€’ç½®çš„ä¸€ç§è®¾è®¡æ–¹å¼ã€‚
**æä¾›åŸºç¡€çš„åŠŸèƒ½å’ŒæœåŠ¡ï¼ŒåŒ…æ‹¬ï¼šæä¾›äº†ä¸æ•°æ®åº“äº¤äº’çš„æŒä¹…å±‚ä»£ç ï¼ŒRediså·¥å…·ç±»ï¼Œä¸€äº›æŒä¹…å±‚å¯¹è±¡ï¼ˆPOå¯¹è±¡ï¼‰ã€‚**

- repository ä»“å‚¨æœåŠ¡ï¼›ä»æ•°æ®åº“ç­‰æ•°æ®æºä¸­è·å–æ•°æ®ï¼Œä¼ é€’çš„å¯¹è±¡å¯ä»¥æ˜¯èšåˆå¯¹è±¡ã€å®ä½“å¯¹è±¡ï¼Œè¿”å›çš„ç»“æœå¯ä»¥æ˜¯ï¼›å®ä½“å¯¹è±¡ã€å€¼å¯¹è±¡ã€‚å› ä¸ºä»“å‚¨æœåŠ¡æ˜¯ç”±**åŸºç¡€å±‚(infrastructure) å¼•ç”¨é¢†åŸŸå±‚(domain)ï¼Œæ˜¯ä¸€ç§ä¾èµ–å€’ç½®çš„ç»“æ„ï¼Œä½†å®ƒå¯ä»¥å¤©ç„¶çš„éš”ç¦»POæ•°æ®åº“æŒä¹…åŒ–å¯¹è±¡è¢«å¼•ç”¨ã€‚**

#### æ¥å£å±‚
interfaces
**ç”¨äºå¤„ç†ç”¨æˆ·å‘é€çš„Restfulè¯·æ±‚å’Œè§£æç”¨æˆ·è¾“å…¥çš„é…ç½®æ–‡ä»¶ç­‰ã€‚**
æš´éœ²å¯¹å¤–æä¾›æŠ½å¥–çš„æ¥å£ï¼ŒæŠ½å¥–çš„å…·ä½“æµç¨‹æ˜¯åœ¨åº”ç”¨å±‚ä¸­ç¼–æ’çš„ï¼Œæ‰€ä»¥æ¥å£å±‚ä¼šä¾èµ–åº”ç”¨å±‚ï¼Œä¼šè°ƒç”¨åº”ç”¨å±‚ä¸­å…·ä½“çš„æ¥å£å®ç°ã€‚
å¾®æœåŠ¡ä¸­å¼•ç”¨çš„ RPC éœ€è¦å¯¹å¤–æä¾›æ¥å£çš„æè¿°ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ–¹åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦å¼•å…¥ Jar åŒ…ï¼Œè®©è°ƒç”¨æ–¹å¥½èƒ½ä¾èµ–æ¥å£çš„å®šä¹‰åšä»£ç†ã€‚
**å®ç°rpcçš„æ¥å£å®šä¹‰**ï¼Œå¼•å…¥åº”ç”¨å±‚æœåŠ¡ï¼Œå°è£…å…·ä½“çš„æ¥å£ã€‚ï¼ˆå„ä¸ªæ¨¡å—çš„æ¥å£ï¼‰
* ä¾èµ–å…³ç³»ï¼š
* lottery-infrastructure
* lottery-rpc
* lottery-domain
* lottery-application

#### RPCå±‚
-trigger ï¼ˆrpcå±‚ï¼‰
å› ä¸ºä½¿ç”¨ RPC æ¡†æ¶çš„æ—¶å€™ï¼Œéœ€è¦å¯¹å¤–æä¾›æè¿°æ¥å£ä¿¡æ¯çš„ Jar è®©å¤–éƒ¨è°ƒç”¨æ–¹å¼•å…¥æ‰å¯ä»¥é€šè¿‡åå°„è°ƒç”¨åˆ°å…·ä½“çš„æ–¹æ³•æä¾›è€…ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼ŒRPC éœ€è¦æš´éœ²å‡ºæ¥ã€‚
è§¦å‘å™¨å±‚ï¼Œä¸€èˆ¬ä¹Ÿè¢«å«åš adapter é€‚é…å™¨å±‚ã€‚**ç”¨äºæä¾›RPCæ¥å£å®ç°ã€æ¶ˆæ¯æ¥æ”¶ã€ä»»åŠ¡æ‰§è¡Œç­‰**ã€‚æ‰€ä»¥å¯¹äºè¿™æ ·çš„æ“ä½œï¼ŒæŠŠå®ƒå«åšè§¦å‘å™¨å±‚ã€‚
æè¿°RPCæ¥å£æ–‡ä»¶ï¼Œç”¨äºæ‰“åŒ…åå¤–éƒ¨å¼•å…¥POMé…ç½®ã€‚ï¼ˆå†…éƒ¨äº’ç›¸è°ƒç”¨çš„æ¥å£ï¼‰

#### é€šç”¨å±‚
common
é€šç”¨ç±»å‹å®šä¹‰å±‚ï¼Œåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿå¼€å‘ä¸­ï¼Œä¼šæœ‰å¾ˆå¤šç±»å‹çš„å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼›åŸºæœ¬çš„ **Responseã€Constants å’Œæšä¸¾**ã€‚å®ƒä¼šè¢«å…¶ä»–çš„å±‚è¿›è¡Œå¼•ç”¨ä½¿ç”¨ã€‚

### ä»£ç ç»“æ„

é¦–å…ˆæ˜¯domianæ¨¡å—ä¸­æŠ½å¥–æ¨¡å—çš„å®ç°
æŠ½å¥–ç³»ç»Ÿå·¥ç¨‹é‡‡ç”¨DDDæ¶æ„ + Moduleæ¨¡å—æ–¹å¼æ­å»ºï¼Œlottery-domain æ˜¯ä¸“é—¨ç”¨äºå¼€å‘é¢†åŸŸæœåŠ¡çš„æ¨¡å—ï¼Œä¸é™äºç›®å‰çš„æŠ½å¥–ç­–ç•¥åœ¨æ­¤æ¨¡å—ä¸‹å®ç°è¿˜æœ‰**æ´»åŠ¨é¢†åŸŸã€è§„åˆ™å¼•æ“ã€ç”¨æˆ·æœåŠ¡**ç­‰ã€‚

strategy æ˜¯ç¬¬1ä¸ªåœ¨ domain ä¸‹å®ç°çš„æŠ½å¥–ç­–ç•¥é¢†åŸŸï¼Œåœ¨é¢†åŸŸåŠŸèƒ½å¼€å‘çš„æœåŠ¡ä¸‹ä¸»è¦å«æœ‰modelã€repositoryã€serviceä¸‰å—åŒºåŸŸï¼Œå…¶ä¸­ï¼š
- modelï¼Œç”¨äºæä¾›voã€reqã€res å’Œ aggregates èšåˆå¯¹è±¡ã€‚
- repositoryï¼Œæä¾›ä»“å‚¨æœåŠ¡ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å¯¹Mysqlã€Redisç­‰æ•°æ®çš„ç»Ÿä¸€åŒ…è£…ã€‚
- serviceï¼Œæ˜¯å…·ä½“çš„ä¸šåŠ¡é¢†åŸŸé€»è¾‘å®ç°å±‚ï¼Œåœ¨è¿™ä¸ªåŒ…ä¸‹å®šä¹‰äº†algorithmæŠ½å¥–ç®—æ³•å®ç°å’Œå…·ä½“çš„æŠ½å¥–ç­–ç•¥åŒ…è£… draw å±‚ï¼Œå¯¹å¤–æä¾›æŠ½å¥–æ¥å£ `IDrawExec::doDrawExec()`
todo...


## åˆ†å±‚å…³ç³»å›¾

![[Pasted image 20240612133022.png]]
# RPCæ¡†æ¶çš„è·‘é€š

#### ä¸ºä»€ä¹ˆä½¿ç”¨dubboï¼Ÿ
dubboæ˜¯ä¸€æ¬¾é˜¿é‡Œè‡ªç ”çš„RPCæ¡†æ¶
1. å› ä¸ºdubboåº•å±‚é€šä¿¡æ˜¯**Socket**è€Œä¸æ˜¯httpæ‰€ä»¥é€šä¿¡æ•ˆç‡ä¼šæ›´é«˜
2. dubboæœ‰**åˆ†å¸ƒå¼é«˜å¯ç”¨çš„è®¾è®¡**ï¼Œåœ¨æŸç»„æœåŠ¡å®•æœºåä¼šè¢«ä»æ³¨å†Œä¸­å¿ƒæ‘˜é™¤ï¼Œä¹‹åæµé‡ä¼šæ‰“åˆ°å…¶ä»–çš„æœåŠ¡ä¸Š
ç±»æ¯”äºopenfeign
```
OpenFeignæ˜¯ä¸€ä¸ªåŸºäºRESTçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ï¼Œå®ƒå¯å¸®åŠ©å¼€å‘äººå‘˜å‘èµ·HTTPè¯·æ±‚å¹¶è°ƒç”¨è¿œç¨‹æœåŠ¡ã€‚å®ƒå¯ä»¥ç®€åŒ–ä¸è¿œç¨‹æœåŠ¡çš„é€šä¿¡ï¼Œå¹¶æä¾›äº†ä¸€ç§å£°æ˜æ€§çš„æ–¹å¼æ¥å®šä¹‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„äº¤äº’ã€‚
```
### dubboå¦‚ä½•ä½¿ç”¨
**dubboç‰ˆæœ¬æ›´æ–°**
**æ³¨æ„ï¼š
ç›®å‰é¡¹ç›®ä½¿ç”¨dubboç‰ˆæœ¬ä¸º2.7.15
å› ä¸ºåŸç‰ˆæœ¬dubboé¡¹ç›®ç‰ˆæœ¬å·²ç»ä¸å†ç»´æŠ¤@serviceæ³¨è§£ï¼Œæ­¤æ—¶å†ä½¿ç”¨å¹¿æ’­ç›´è¿æ¨¡å¼ä¼šæ‰¾ä¸åˆ°æœåŠ¡ç«¯
ï¼ˆåŸä»£ç ä¸­@Serviceè¢«æ ‡è®°å·²è¿‡æ—¶ï¼‰ä»è€ŒæŠ¥é”™**

dubboçš„ä½¿ç”¨åˆ†ä¸ºæ¥å£è°ƒç”¨æ–¹ä»¥åŠæ¥å£æä¾›æ–¹

##### æ¥å£æä¾›æ–¹
æä¾›æ¥å£çš„æè¿°ä¿¡æ¯ï¼šæ¥å£å®šä¹‰ä»¥åŠå†…éƒ¨æ–¹æ³•çš„å®šä¹‰
ä¸€èˆ¬åœ¨DDDç»“æ„ä¸­å®šä¹‰ä¸º
**apiï¼šDubboæ¥å£å®šä¹‰æ¨¡å—**ã€‚åªå®šä¹‰æ¥å£ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åŒ…å«ä¸€äº›å®šä¹‰ä¼ è¾“çš„dtoï¼Œè¿”å›ã€æ¥æ”¶ç±»å‹ç±»ï¼ˆTypesï¼‰ã€‚è¿™éƒ¨åˆ†ç»“æ„éœ€è¦å¯¹å¤–æä¾›jaråŒ…ï¼Œä¹Ÿå°±æ˜¯æ¥å£çš„æè¿°ä¿¡æ¯ï¼ˆåœ¨å¦ä¸€æ–¹è°ƒç”¨ä¹‹å‰éœ€è¦å…ˆinstallåˆ°æœ¬åœ°ä¸­å¤®ä»“åº“å»ï¼‰ã€‚
**ä½†æ˜¯éœ€è¦æ³¨æ„ï¼š**
```
- æ‰€æœ‰çš„ Dubbo æ¥å£ï¼Œå‡ºå…¥å‚ï¼Œé»˜è®¤éƒ½éœ€è¦ç»§æ‰¿ Serializable æ¥å£ã€‚ä¹Ÿå°±æ˜¯ UserReqDTOã€UserResDTOã€Response è¿™3ä¸ªç±»ï¼Œéƒ½å¾—ç»§æ‰¿ Serializable åºåˆ—åŒ–æ¥å£ã€‚
```
**appï¼šåº”ç”¨ç¨‹åºå¯åŠ¨æ¨¡å—ã€‚** springbootçš„é¡¹ç›®å¯åŠ¨å…¥å£
**triggerï¼šæ¥å£å®ç°æ¨¡å—ã€‚** æ­¤å¤„çš„æ¥å£å¯ç”¨æ˜¯å®é™…è°ƒç”¨çš„å‡½æ•°/ä»£ç çš„åœ°æ–¹ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ç°ä»£ç ï¼Œç±»æ¯”äºserviceå±‚çš„å®ç°
```java
@Slf4j
@DubboService(version = "1.0.0")
public class UserService implements IUserService {

    @Override
    public Response<UserResDTO> queryUserInfo(UserReqDTO reqDTO) {
        log.info("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ userId: {} reqStr: {}", reqDTO.getUserId(), JSON.toJSONString(reqDTO));
        try {
            // 1. æ¨¡æ‹ŸæŸ¥è¯¢ã€ä½ å¯ä»¥ä»æ•°æ®åº“æˆ–è€…Redisç¼“å­˜è·å–æ•°æ®ã€‘
            UserResDTO resDTO = UserResDTO.builder()
                    .userId(reqDTO.getUserId())
                    .userName("å°å‚…å“¥")
                    .userAge(20)
                    .build();

            // 2. è¿”å›ç»“æœ
            return Response.<UserResDTO>builder()
                    .code(Constants.ResponseCode.SUCCESS.getCode())
                    .info(Constants.ResponseCode.SUCCESS.getInfo())
                    .data(resDTO).build();
        } catch (Exception e) {
            log.error("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥ userId: {} reqStr: {}", reqDTO.getUserId(), JSON.toJSONString(reqDTO), e);
            return Response.<UserResDTO>builder()
                    .code(Constants.ResponseCode.UN_ERROR.getCode())
                    .info(Constants.ResponseCode.UN_ERROR.getInfo())
                    .build();
        }
    }

}
```

ä½†æ­¤æ—¶ä¸ºRPCè°ƒç”¨æ‰€ä»¥serviceéœ€è¦ä½¿ç”¨Dubboè‡ªå®šä¹‰çš„æ³¨è§£

##### å·¥ç¨‹é…ç½®yml
application.ymlï¼ˆä¸»å¯åŠ¨ç±»ä¸­çš„springbooté…ç½®æ–¹å¼ï¼‰
é¡¹ç›®ä½¿ç”¨dubboçš„é…ç½®ï¼š
1. å…¶ä¸­æœåŠ¡æ³¨å†Œå‘ç°ä½¿ç”¨zookeeperçš„ç›´è¿æµ‹è¯•æ¨¡å¼
2. åŒ…æ‰«æè¦æ‰«æåˆ°å¯¹å¤–æä¾›æœåŠ¡çš„jaråŒ…æ¥å£å®šä¹‰å¤„
```yml
dubbo:
  application:
    name: xfg-dev-tech-dubbo
    version: 1.0.0
  registry:
    address: zookeeper://127.0.0.1:2181 # N/A - æ— zookeeperå¯é…ç½® N/A èµ°ç›´è¿æ¨¡å¼æµ‹è¯•
  protocol:
    name: dubbo
    port: 20881
  scan:
    base-packages: cn.bugstack.dev.tech.dubbo.api

```
æˆ–è€…æ˜¯æ¶ˆè´¹è€…å’ŒæœåŠ¡ç«¯éƒ½ä½¿ç”¨æ— æ³¨å†Œä¸­å¿ƒçš„å¹¿æ’­æ¨¡å¼
```yml
# Dubbo å¹¿æ’­æ–¹å¼é…ç½®  
dubbo:  
  application:  
    name: Lottery  
    version: 1.0.0  
  registry:  
    address: N/A #multicast://224.5.6.7:1234  
  protocol:  
    name: dubbo  
    port: 8101  
  scan:  
    base-packages: com.lily.lottery.rpc
```
**æ³¨æ„**ï¼š
* base-packagesé…ç½®çš„æ˜¯springçº¦å®šæ‰«æçš„åŒ…ï¼Œdubboçš„æ¥å£æ¨¡å—è¦æƒ³è¢«æ‰«æåˆ°ï¼Œä¸»é¡¹ç›®çš„pomä¸­åº”è¯¥è¦**é—´æ¥æˆ–ç›´æ¥**çš„ä¾èµ–æ¥å£æ¨¡å—ã€‚

* springè®²ç©¶çº¦å®šå¤§äºé…ç½®ï¼ŒApplicationçš„åº”ç”¨çš„åŒ…ååº”è¯¥è¦æ¶µç›–è¦†ç›–åˆ°å…¶ä»–çš„åŒ…åã€‚ä¾‹å¦‚Applicationæ‰€åœ¨åŒ…åä¸º `com.lily.dev.dubbo` é‚£ä¹ˆapiæ¥å£çš„åŒ…åå±‚çº§åº”è¯¥æ¯”è¯¥å±‚çº§å¤šä¸€å±‚æˆ–è€…åŒå±‚çº§æ‰å¯æ‰«åˆ°`com.lily.dev.dubbo.api`ã€‚å¦‚æœæ­¤æ—¶Applicationæ‰€åœ¨åŒ…åä¸º `com.lily.dev.dubbo.a.b.c` é‚£ä¹ˆapiæ¥å£çš„åŒ…åå°†ä¸èƒ½å¤Ÿè¢«æ‰«æåˆ°ã€‚

* addressï¼šå¦‚æœé…ç½®çš„æ˜¯ N/A å°±æ˜¯ä¸èµ°ä»»ä½•æ³¨å†Œä¸­å¿ƒï¼Œå°±æ˜¯ä¸ªç›´è¿ï¼Œä¸»è¦ç”¨äºæœ¬åœ°éªŒè¯çš„ã€‚å¦‚æœä½ é…ç½®äº† zookeeper://127.0.0.1:2181 å°±éœ€è¦å…ˆå®‰è£…ä¸€ä¸ª zookeeper ã€‚å¦å¤–ï¼Œå³ä½¿é…ç½®äº†æ³¨å†Œä¸­å¿ƒçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ç›´è¿æµ‹è¯•ã€‚
#### åº”ç”¨æ„å»º
æ•´ä¸ªé¡¹ç›®æ‰§è¡Œinstallï¼ŒjaråŒ…å°±ä¼šè¿›å…¥æœ¬åœ°çš„Mavenä»“åº“ï¼Œæœ¬åœ°è°ƒç”¨å¯ä»¥ä½¿ç”¨è¯¥jaråŒ…ï¼›å…¶æ¬¡å°±å¯ä»¥é€šè¿‡deployå°†æœ¬åœ°çš„jaråŒ…å‘å¸ƒåˆ°ä¸­å¤®ä»“åº“ï¼Œå³ä½¿ä¸åœ¨æœ¬åœ°ç¯å¢ƒä¹Ÿå¯ä»¥ä½¿ç”¨
#### æœåŠ¡ä½¿ç”¨æ–¹
1. pomå¼•å…¥
```xml
<dependency>
    <groupId>com.lily</groupId>
    <artifactId>xxx-dubbo-api</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```
2. æ¶ˆè´¹é…ç½®
ä½¿ç”¨æ–¹ä¹Ÿéœ€è¦é…ç½®å¯¹åº”çš„dubboå±æ€§
```yml
dubbo:
  application:
    name: xfg-dev-tech-dubbo
    version: 1.0.0
  registry:
     address: zookeeper://127.0.0.1:2181
#    address: N/A
  protocol:
    name: dubbo
    port: 20881
```

3. ä»£ç è°ƒç”¨
```java
// ç›´è¿æ¨¡å¼ï¼›@DubboReference(interfaceClass = IUserService.class, url = "dubbo://127.0.0.1:20881", version = "1.0.0")
@DubboReference(interfaceClass = IUserService.class, version = "1.0.0")
private IUserService userService;

@Test
public void test_userService() {
    UserReqDTO reqDTO = UserReqDTO.builder().userId("10001").build();
    Response<UserResDTO> resDTO = userService.queryUserInfo(reqDTO);
    log.info("æµ‹è¯•ç»“æœ req: {} res: {}", JSON.toJSONString(reqDTO), JSON.toJSONString(resDTO));
}
```

- é…ç½®äº† zookeeper å°±ç”¨ç¬¬ä¸€ä¸ªï¼Œä»£ç ä¸­å¯¹åº”Â `@DubboReference(interfaceClass = IUserService.class, version = "1.0.0")`
- é…ç½®äº† N/A å°±ç”¨ç¬¬äºŒä¸ªï¼Œä»£ç ä¸­å¿…é¡»æŒ‡å®šç›´è¿ã€‚`@DubboReference(interfaceClass = IUserService.class, url = "dubbo://127.0.0.1:20881", version = "1.0.0")`

# æŠ½å¥–æ•´ä½“ä¸šåŠ¡è®¾è®¡

## ä¸šåŠ¡æµç¨‹
#### æµç¨‹ç¼–æ’
[æŠ½å¥–æµç¨‹ç¼–æ’](https://gitcode.net/KnowledgePlanet/Lottery/-/wikis/%E7%AC%AC-2-%E9%83%A8%E5%88%86-%E9%A2%86%E5%9F%9F%E5%BC%80%E5%8F%91//%E7%AC%AC12%E8%8A%82%EF%BC%9A%E5%9C%A8%E5%BA%94%E7%94%A8%E5%B1%82%E7%BC%96%E6%8E%92%E6%8A%BD%E5%A5%96%E8%BF%87%E7%A8%8B)
- æŠ½å¥–æ•´ä¸ªæ´»åŠ¨è¿‡ç¨‹çš„æµç¨‹ç¼–æ’ï¼Œä¸»è¦åŒ…æ‹¬ï¼š**ç”¨æˆ·å¯¹æ´»åŠ¨çš„å‚ä¸ï¼ˆé¢†å–ï¼‰ã€å¯¹æŠ½å¥–çš„æ“ä½œã€å¯¹ä¸­å¥–ç»“æœçš„å­˜æ”¾ï¼Œä»¥åŠå¦‚ä½•å¤„ç†å‘å¥–ï¼Œå¯¹äºå‘å¥–æµç¨‹æˆ‘ä»¬è®¾è®¡ä¸ºMQè§¦å‘ã€‚**
- å¯¹äºæ¯ä¸€ä¸ªæµç¨‹èŠ‚ç‚¹ç¼–æ’çš„å†…å®¹ï¼Œéƒ½æ˜¯åœ¨é¢†åŸŸå±‚å¼€å‘å®Œæˆçš„ï¼Œè€Œåº”ç”¨å±‚åªæ˜¯åšæœ€ä¸ºç®€å•çš„ä¸”å¾ˆè–„çš„ä¸€å±‚ã€‚_å…¶å®è¿™å—ä¹Ÿå¾ˆç¬¦åˆç›®å‰å¾ˆå¤šä½ä»£ç çš„ä½¿ç”¨åœºæ™¯ï¼Œé€šè¿‡ç•Œé¢å¯è§†åŒ–æ§åˆ¶æµç¨‹ç¼–æ’ï¼Œç”Ÿæˆä»£ç _

ä¸šåŠ¡æµç¨‹å›¾ï¼š
![[Pasted image 20241012212947.png]]

#### å¤šè¡¨æ•°æ®å¹‚ç­‰æ€§è€ƒè™‘

è¡¨ç»“æ„:
1. åˆ†åˆ«åœ¨ä¸¤ä¸ªåˆ†åº“çš„è¡¨ lottery_01.user_take_activityï¼ˆç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•è¡¨ï¼‰ã€lottery_02.user_take_activity ä¸­æ·»åŠ  **state**`ã€æ´»åŠ¨å•ä½¿ç”¨çŠ¶æ€ 0æœªä½¿ç”¨ã€1å·²ä½¿ç”¨ã€‘` çŠ¶æ€å­—æ®µï¼Œ**è¿™ä¸ªçŠ¶æ€å­—æ®µç”¨äºå†™å…¥ä¸­å¥–ä¿¡æ¯åˆ° user_strategy_export_000~003 ï¼ˆç”¨æˆ·ä¸­å¥–è®¢å•è¡¨ï¼‰è¡¨ä¸­æ—¶å€™ï¼Œä¸¤ç§è¡¨å¯ä»¥åšä¸€ä¸ªå¹‚ç­‰æ€§çš„äº‹åŠ¡**ã€‚
2. åŒæ—¶è¿˜éœ€è¦åŠ å…¥ strategy_id ç­–ç•¥IDå­—æ®µï¼Œç”¨äº**å¤„ç†é¢†å–äº†æ´»åŠ¨å•ä½†æ‰§è¡ŒæŠ½å¥–å¤±è´¥æ—¶ï¼Œå¯ä»¥ç»§ç»­è·å–åˆ°æ­¤æŠ½å¥–å•ç»§ç»­æ‰§è¡ŒæŠ½å¥–ï¼Œè€Œä¸éœ€è¦é‡æ–°é¢†å–æ´»åŠ¨**ã€‚_å…¶å®é¢†å–æ´»åŠ¨å°±åƒæ˜¯ä¸€ç§æ´»åŠ¨é•œåƒä¿¡æ¯ï¼Œå¯ä»¥åœ¨æ§åˆ¶å¹‚ç­‰åå¤ä½¿ç”¨_

ä»£ç å±‚é¢ï¼š
1. `this.grabActivity()` **æ–¹æ³•ã€ç”¨æˆ·å‚ä¸æ´»åŠ¨æ–¹æ³•ï¼šåŒ…æ‹¬ä¿®æ”¹`user_take_activity,user_take_activity_count`ä¸¤è¡¨æ•°æ®ã€‘**ï¼Œç”¨æˆ·é¢†å–æ´»åŠ¨æ—¶å€™ï¼Œæ–°å¢è®°å½•ï¼šstrategy_idã€state ä¸¤ä¸ªå­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µå°±æ˜¯ä¸ºäº†å¤„ç†ç”¨æˆ·å¯¹é¢†å–é•œåƒè®°å½•çš„äºŒæ¬¡å¤„ç†æœªæ‰§è¡ŒæŠ½å¥–çš„é¢†å–å•ï¼Œä»¥åŠstateçŠ¶æ€æ§åˆ¶äº‹åŠ¡æ“ä½œçš„å¹‚ç­‰æ€§ã€‚
## æŠ½å¥–ç­–ç•¥ç®—æ³•

**å•ä½“æ¦‚ç‡ã€æ€»ä½“æ¦‚ç‡ä¸¤ç§**æŠ½å¥–ç®—æ³•æè¿°ï¼š
åœºæ™¯A20%ã€B30%ã€C50%
- **æ€»ä½“æ¦‚ç‡**ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCå¥–å“çš„æ¦‚ç‡æŒ‰ç…§ `3:5` å‡åˆ†ï¼Œç›¸å½“äºBå¥–å“ä¸­å¥–æ¦‚ç‡ç”± `0.3` å‡ä¸º `0.375`ã€‚
	- æ˜¯åŸºäºæŠ½å¥–æ¦‚ç‡åœ¨æ”¹å˜çš„ä¸­å¥–æ–¹å¼ï¼Œä¸ºäº†ä¿è¯æ‰€æœ‰å‚ä¸æŠ½å¥–çš„ç”¨æˆ·æŠ½å–å¥–å“çš„æ¦‚ç‡éƒ½ç›¸ç­‰ï¼Œè€Œä¸æ˜¯æ ¹æ®ç§’æ€é€Ÿåº¦å†³å®šçš„ï¼Œéœ€è¦å®æ—¶æ”¹å˜ã€**å¥–å“æ¦‚ç‡åˆ†å¸ƒçš„hashæ•°ç»„**ã€‘ï¼Œä¿è¯æ‰€æœ‰å‰©ä¸‹çš„å¥–å“ä¸­å¥–æ¦‚ç‡å’Œç»´æŒåœ¨100%ã€‚
- **å•é¡¹æ¦‚ç‡**ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCä¿æŒç›®å‰ä¸­å¥–æ¦‚ç‡ï¼Œç”¨æˆ·æŠ½å¥–æ‰”æœ‰20%ä¸­ä¸ºAï¼Œå› Aåº“å­˜æŠ½ç©ºåˆ™ç»“æœå±•ç¤ºä¸ºæœªä¸­å¥–ã€‚ä¸ºäº†è¿è¥æˆæœ¬ï¼Œé€šå¸¸è¿™ç§æƒ…å†µçš„ä½¿ç”¨çš„æ¯”è¾ƒå¤šã€‚
	- æ˜¯åŸºäºå¥–å“è·å¥–æ¦‚ç‡ä¸å˜çš„æŠ½å¥–æ–¹å¼ï¼Œæ‰€æœ‰å¥–å“çš„ä¸­å¥–æ¦‚ç‡ï¼Œå¥–å“æ¦‚ç‡åˆ†å¸ƒçš„hashæ•°ç»„ä¸å˜ï¼ŒåŸºäºç§’æ€ç‰¹æ€§å†³å®šï¼Œæ‰€æœ‰ç”¨æˆ·åŒæ—¶å¹¶å‘æŠ½å¥–ã€‚

### æ–æ³¢é‚£å¥‘ç®—æ³•
ç”¨äºåˆå§‹åŒ–ä¸­å¥–hashæ•°ç»„
todo
### æ€»ä½“æ¦‚ç‡æŠ½å¥–
- é¦–å…ˆè¦ä»æ€»çš„ä¸­å¥–åˆ—è¡¨ä¸­æ’é™¤æ‰é‚£äº›è¢«æ’é™¤æ‰çš„å¥–å“ï¼Œè¿™äº›å¥–å“ä¼šæ¶‰åŠåˆ°æ¦‚ç‡çš„å€¼é‡æ–°è®¡ç®—ã€‚
- å¦‚æœæ’é™¤åå‰©ä¸‹çš„å¥–å“åˆ—è¡¨å°äºç­‰äº1ï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å›å¯¹åº”ä¿¡æ¯
- æ¥ä¸‹æ¥å°±ä½¿ç”¨éšæœºæ•°å·¥å…·ç”Ÿäº§ä¸€ä¸ª100å†…çš„éšå€¼ä¸å¥–å“åˆ—è¡¨ä¸­çš„å€¼è¿›è¡Œå¾ªç¯æ¯”å¯¹ï¼Œç®—æ³•æ—¶é—´å¤æ‚åº¦O(n)
ä»£ç 
```java
@Component("defaultRandomDrawAlgorithm")  
public class DefaultRandomDrawAlgorithm extends BaseAlgorithm {  
    //  
    /**  
     * éšæœºæŠ½å¥–  
     * çˆ¶ç±»ä¸­æœªå®ç°çš„æŠ½è±¡æ–¹æ³•  
     * @param strategyId ç­–ç•¥ID  
     * @param excludeAwardIds å·²ç»è¢«æŠ½å®Œçš„å¥–å“IDåˆ—è¡¨  
     *                        ä¸ç”¨äºæ„å»ºæ¦‚ç‡å…ƒç»„çš„å¥–å“ä¿¡æ¯  
     * @return å¥–å“ID  
     */    @Override  
    public String randomDraw(Long strategyId, List<String> excludeAwardIds) {  
  
        /**  
         * æ’é™¤å·²ç»è¢«æŠ½å®Œçš„å¥–å“IDï¼Œä¿å­˜å‰©ä¸‹çš„è¿˜å¯ä»¥æŠ½å¥–çš„ID  
         * è‹¥å…¨éƒ¨å¥–å“éƒ½è¢«æŠ½å®Œäº†ï¼Œåˆ™ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜æ²¡æœ‰è·å¥–  
         * å¦‚æœåªå‰©ä¸‹ä¸€ä¸ªå¥–å“äº†ï¼Œé‚£ä¹ˆä¹‹é—´è·å¾—è¯¥å¥–å“  
         * è‹¥æœ‰å¤šä¸ªæ’é™¤å¥–å“ï¼Œåˆ™æ–°å»ºæŠ½å¥–è§„åˆ™éšæœºæŠ½å–ä¸€ä¸ªå¥–å“  
         * todo: ä¼˜åŒ–  
         */  
        // åˆå§‹åŒ–å·®å¼‚åˆ†æ¯  
        BigDecimal differenceDenominator = BigDecimal.ZERO;  
        // åˆå§‹åŒ–éæŠ½å¥–å¥–å“åˆ—è¡¨  
        List<AwardRateInfo> differenceAwardRateList = new ArrayList<>();  
        // è·å–æ¦‚ç‡å…ƒç»„ä¸­æ‰€æœ‰çš„å¥–å“ç§ç±»  
        List<AwardRateInfo> awardRateInfos = awardRateInfoMap.get(strategyId);  
        // éå†æ‰€æœ‰å¥–å“ç§ç±»  
        for (AwardRateInfo awardRateInfo : awardRateInfos) {  
            // è·å–å¥–å“ID  
            String awardId = awardRateInfo.getAwardId();  
            // å¦‚æœå¥–å“è¿˜æ²¡æœ‰è¢«æŠ½å®Œåˆ™åŠ å…¥å·®å¼‚å¥–å“åˆ—è¡¨  
            if (!excludeAwardIds.contains(awardId)) {  
                differenceAwardRateList.add(awardRateInfo);  
                differenceDenominator = differenceDenominator.add(awardRateInfo.getAwardRate());  
            }  
        }  
        // å¦‚æœå·®å¼‚å¥–å“åˆ—è¡¨ä¸ºç©ºåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²  
        if (differenceAwardRateList.isEmpty()) return "";  
        // å¦‚æœå·®å¼‚å¥–å“åˆ—è¡¨åªæœ‰ä¸€ä¸ªåˆ™è¿”å›è¯¥å¥–å“ID  
        if (differenceAwardRateList.size() == 1) return differenceAwardRateList.get(0).getAwardId();  
        /**  
         * æ–°å»ºè§„åˆ™é‡æ–°åˆ†é…æ¦‚ç‡æŠ½å¥–  
         * ä»å·®å¼‚å¥–å“åˆ—è¡¨ä¸­éšæœºæŠ½å–å¥–å“  
         */  
        // è·å–éšæœºæ¦‚ç‡å€¼ä¸º0-100çš„éšæœºæ•°  
        SecureRandom secureRandom = new SecureRandom();  
        int randomVal = secureRandom.nextInt(100) + 1;  
        // å¾ªç¯è·å–å¥–å“  
        String awardId = "";  
        int cursorVal = 0;  
        for (AwardRateInfo awardRateInfo : differenceAwardRateList) {  
            // è®¡ç®—å¥–å“æ¦‚ç‡å€¼  
            // Divide the award rate by the difference denominator, multiply by 100, and round up to the nearest integer  
            int rateVal = awardRateInfo.getAwardRate().divide(differenceDenominator, 2, BigDecimal.ROUND_UP).multiply(new BigDecimal(100)).intValue();  
            // å¦‚æœéšæœºæ•°å°äºç­‰äºå½“å‰å¥–å“æ¦‚ç‡å€¼åˆ™è¿”å›è¯¥å¥–å“ID  
            if (randomVal <= (cursorVal + rateVal)) {  
                awardId = awardRateInfo.getAwardId();  
                break;  
            }  
            cursorVal += rateVal;  
        }  
        // æŠ½ä¸­å½“å‰å¥–å“ID  
        return awardId;  
    }  
}****
```


### å•é¡¹æ¦‚ç‡æŠ½å¥–

**ç®—æ³•æè¿°**ï¼šå•é¡¹æ¦‚ç‡ç®—æ³•ä¸æ¶‰åŠå¥–å“æ¦‚ç‡é‡æ–°è®¡ç®—çš„é—®é¢˜ï¼Œåˆ†é…å¥½çš„æ¦‚ç‡ç»“æœæ˜¯å¯ä»¥å›ºå®šä¸‹æ¥çš„
ä¸»è¦æ˜¯ç›´æ¥è·å–å’ŒæŸ¥è¯¢ä¹‹å‰çš„æ¦‚ç‡å…ƒç»„

```java
/**  
 * Created by lily via on 2024/6/15 14:59 * å•æ¬¡æŠ½å¥–éšæœºæŠ½å¥–ç®—æ³•å®ç°  
 * ç­–ç•¥æ¨¡å¼ä¸å·¥å‚æ¨¡å¼ç»“åˆ  
 *  
 * åœºæ™¯A20%ã€B30%ã€C50%  
 * æ€»ä½“æ¦‚ç‡ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCå¥–å“çš„æ¦‚ç‡æŒ‰ç…§ 3:5 å‡åˆ†ï¼Œ  
 * ç›¸å½“äºBå¥–å“ä¸­å¥–æ¦‚ç‡ç”± 0.3 å‡ä¸º 0.375  
 */@Component("singleRateRandomDrawAlgorithm")  
//@Primary  
public class SingleRateRandomDrawAlgorithm extends BaseAlgorithm {  
  
    /**  
     * @description: å•é¡¹éšæœºæ¦‚ç‡æŠ½å¥–  
     * @author Lily Via  
     * @date 2024/6/15 17:38  
     * @version 1.0  
     */    @Override  
    public String randomDraw(Long strategyId, List<String> excludeAwardIds) {  
        // è·å–ç­–ç•¥å¯¹åº”çš„å…ƒç¥–  
        String[] rateTuple = rateTupleMap.get(strategyId);  
        // todo: æ ¡éªŒrateTupleä¸ä¸ºç©º  
        assert rateTuple != null;  
        // ç”Ÿæˆéšæœºç´¢å¼•  
        int randomVal = new SecureRandom().nextInt(100) + 1;  
        // è½¬æ¢ä¸ºæ–æ³¢é‚£å¥‘æ•£åˆ—ç´¢å¼•  
        int idx = hashIdx(randomVal);  
        // æŸ¥è¯¢æ˜¯å¦ä¸­å¥–  
        String awardId = rateTuple[idx];  
        // å¦‚æœæŠ½ä¸­å¥–å“åœ¨æ’é™¤å¥–å“åˆ—è¡¨ä¸­åˆ™è¿”å›æœªä¸­å¥–ï¼ˆè¯´æ˜è¿™ä¸ªå¥–å“å·²ç»æŠ½å®Œï¼‰  
        if (excludeAwardIds.contains(awardId)) {  
            return "æœªä¸­å¥–";  
        }  
        return awardId;  
    }  
}
```


# é¡¹ç›®å®Œå–„

### å­æ¨¡å—ä¾èµ–é…ç½®
---

ç°æœ‰å·¥ç¨‹æ¨¡å—ä¾èµ–å…³ç³»ï¼š
- lottery-applicationï¼Œåº”ç”¨å±‚ï¼Œå¼•ç”¨ï¼š`domain`
- lottery-commonï¼Œé€šç”¨åŒ…ï¼Œå¼•ç”¨ï¼š`æ— `
- lottery-domainï¼Œé¢†åŸŸå±‚ï¼Œå¼•ç”¨ï¼š`infrastructure`
- lottery-infrastructureï¼ŒåŸºç¡€å±‚ï¼Œå¼•ç”¨ï¼š`æ— `
- lottery-interfacesï¼Œæ¥å£å±‚ï¼Œå¼•ç”¨ï¼š`application`ã€`rpc`
- lottery-rpcï¼ŒRPCæ¥å£å®šä¹‰å±‚ï¼Œå¼•ç”¨ï¼š`common`
---

æ­¤æ—¶é¡¹ç›®ç€é‡é…ç½®ä»¥ä¸‹ä¸‰ä¸ªæ¨¡å—
- lottery-infrastructure
- lottery-interfaces
- lottery-rpc
#### interfacesæ¥å£æ¨¡å—
##### æ¨¡å—ç»“æ„
å®šä¹‰äº†ä¸»å¯åŠ¨ç±»ï¼Œç”±äºè¯¥æ¨¡å—æ˜¯æ•´ä¸ªé¡¹ç›®çš„å‡ºå£ã€‚
- è¯¥æ¨¡å—å®ç°äº†RPCå±‚å®šä¹‰çš„æ¥å£
- åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰mybatisé…ç½®ï¼ˆåœ¨æ¥å£å®ç°ç±»ä¸­ä¼šé€šè¿‡mybatisè®¿é—®æ•°æ®ä»“ï¼‰ï¼Œé¡¹ç›®å¯åŠ¨ç«¯å£å·ï¼Œä»¥åŠdubboå¯¹åº”é…ç½®
- å¯¹åº”çš„éœ€è¦mybatisçš„ mapperé…ç½®æ–‡ä»¶
![[Pasted image 20240613210022.png]]
dubboå¯¹åº”çš„ymlé…ç½®
```yml
# Dubbo å¹¿æ’­æ–¹å¼é…ç½®
dubbo:
  application:
    name: Lottery
    version: 1.0.0
  registry:
    address: N/A #multicast://224.5.6.7:1234
  protocol:
    name: dubbo
    port: 20880
  scan:
    base-packages: com.lily.lottery.rpc
```
- å¹¿æ’­æ¨¡å¼çš„é…ç½®å”¯ä¸€åŒºåˆ«åœ¨äºæ³¨å†Œåœ°å€ï¼Œ`registry.address = multicast://224.5.6.7:1234`(æ­¤æ—¶ä¸ºæ³¨å†Œåœ°å€)ï¼ŒæœåŠ¡æä¾›è€…å’ŒæœåŠ¡è°ƒç”¨è€…éƒ½éœ€è¦é…ç½®ç›¸åŒçš„ğŸ“¢å¹¿æ’­åœ°å€ã€‚æˆ–è€…é…ç½®ä¸º N/A ç”¨äºç›´è¿æ¨¡å¼ä½¿ç”¨
- applicationï¼Œé…ç½®åº”ç”¨åç§°å’Œç‰ˆæœ¬
- protocolï¼Œé…ç½®çš„é€šä¿¡åè®®å’Œç«¯å£
- scanï¼Œç›¸å½“äº Spring ä¸­è‡ªåŠ¨æ‰«æåŒ…çš„åœ°å€ï¼Œå¯ä»¥æŠŠæ­¤åŒ…ä¸‹çš„æ‰€æœ‰ rpc æ¥å£éƒ½æ³¨å†Œåˆ°æœåŠ¡ä¸­
##### pomæ–‡ä»¶
`lottery-interfaces` ä½œä¸ºç³»ç»Ÿçš„ war åŒ…å·¥ç¨‹ï¼Œåœ¨æ„å»ºå·¥ç¨‹æ—¶å€™éœ€è¦ä¾èµ–äº POM ä¸­é…ç½®çš„ç›¸å…³ä¿¡æ¯ã€‚é‚£è¿™é‡Œå°±éœ€è¦æ³¨æ„ä¸‹ï¼Œä½œä¸º Lottery å·¥ç¨‹ä¸‹çš„ä¸» pom.xml éœ€è¦å®Œæˆå¯¹ SpringBoot çˆ¶æ–‡ä»¶çš„ä¾èµ–ï¼Œæ­¤å¤–è¿˜éœ€è¦å®šä¹‰ä¸€äº›ç”¨äºå…¶ä»–æ¨¡å—å¯ä»¥å¼•å…¥çš„é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼šjdkç‰ˆæœ¬ã€ç¼–ç æ–¹å¼ç­‰ã€‚è€Œå…¶ä»–å±‚åœ¨ä¾èµ–äºå·¥ç¨‹æ€» pom.xml åè¿˜éœ€è¦é…ç½®è‡ªå·±çš„ä¿¡æ¯ã€‚
- lottery-interfaces æ˜¯æ•´ä¸ªç¨‹åºçš„å‡ºå£ï¼Œä¹Ÿæ˜¯ç”¨äºæ„å»º War åŒ…çš„å·¥ç¨‹æ¨¡å—ï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°ä¸€ä¸ª `<packaging>war</packaging>` çš„é…ç½®ã€‚
- åœ¨ dependencies ä¼šåŒ…å«æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„ SpringBoot é…ç½®ï¼Œä¹Ÿä¼šåŒ…æ‹¬å¯¹å…¶ä»–å„ä¸ªæ¨¡å—çš„å¼•å…¥ã€‚
- åœ¨ build æ„å»ºé…ç½®ä¸Šè¿˜ä¼šçœ‹åˆ°ä¸€äº›å…³äºæµ‹è¯•åŒ…çš„å¤„ç†ï¼Œæ¯”å¦‚è¿™é‡ŒåŒ…æ‹¬äº†èµ„æºçš„å¼•å…¥ä¹Ÿå¯ä»¥åŒ…æ‹¬æ„å»ºæ—¶å€™è·³è¿‡æµ‹è¯•åŒ…çš„é…ç½®ã€‚
```xml
<artifactId>lottery-interfaces</artifactId>
<packaging>war</packaging>
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    ...
</dependencies>
<build>
    <finalName>Lottery</finalName>
    <resources>
        <resource>
            <directory>src/main/resources</directory>
            <filtering>true</filtering>
            <includes>
                <include>**/**</include>
            </includes>
        </resource>
    </resources>
    <testResources>
        <testResource>
            <directory>src/test/resources</directory>
            <filtering>true</filtering>
            <includes>
                <include>**/**</include>
            </includes>
        </testResource>
    </testResources>
    <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
        </plugin>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <source>8</source>
                <target>8</target>
            </configuration>
        </plugin>
    </plugins>
</build>
```
#### RPCæ¨¡å—
##### æ¨¡å—ç»“æ„
è¯¥æ¨¡å—æ˜¯æ¶ˆè´¹è€…è°ƒç”¨éœ€è¦ä¾èµ–çš„æ¨¡å—ï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªæ´»åŠ¨ç±»æ¥å£ä»¥åŠå¯¹åº”çš„ä¼ è¾“æ—¶çš„åŒ…è£…ç±»
æ¨¡å—.é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š
![[Pasted image 20240613205636.png]]
##### pomæ–‡ä»¶
```xml
<parent>
    <artifactId>Lottery</artifactId>
    <groupId>cn.itedus.lottery</groupId>
    <version>1.0-SNAPSHOT</version>
</parent>
<modelVersion>4.0.0</modelVersion>
<artifactId>lottery-rpc</artifactId>
<packaging>jar</packaging>
<dependencies>
    <dependency>
        <groupId>cn.itedus.lottery</groupId>
        <artifactId>lottery-common</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
<build>
    <finalName>lottery-rpc</finalName>
    <plugins>
        <!-- ç¼–è¯‘plugin -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <source>${jdk.version}</source>
                <target>${jdk.version}</target>
                <compilerVersion>1.8</compilerVersion>
            </configuration>
        </plugin>
    </plugins>
</build>
```

### å®šä¹‰å¼€å‘ RPC æ¥å£
**å¼€å‘æ¥å£**
```java
@DubboService
public class ActivityBooth implements IActivityBooth {

    @Resource
    private IActivityDao activityDao;

    @Override
    public ActivityRes queryActivityById(ActivityReq req) {

        Activity activity = activityDao.queryActivityById(req.getActivityId());

        ActivityDto activityDto = new ActivityDto();
        activityDto.setActivityId(activity.getActivityId());
        activityDto.setActivityName(activity.getActivityName());
        activityDto.setActivityDesc(activity.getActivityDesc());
        activityDto.setBeginDateTime(activity.getBeginDateTime());
        activityDto.setEndDateTime(activity.getEndDateTime());
        activityDto.setStockAllTotal(activity.getStockAllTotal());
        activityDto.setStockDayTotal(activity.getStockDayTotal());
        activityDto.setTakeAllCount(activity.getStockAllTotal());
        activityDto.setTakeDayCount(activity.getStockDayTotal());

        return new ActivityRes(new Result(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo()), activityDto);
    }

}
```

- ç”¨äºå®ç° RPC æ¥å£çš„å®ç°ç±» ActivityBooth ä¸Šæœ‰ä¸€ä¸ªæ³¨è§£ @DubboServiceï¼Œè¿™ä¸ªæ³¨è§£æ˜¯æ¥è‡ªäº Dubbo çš„ `org.apache.dubbo.config.annotation.Service`ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªåŒ…ä¸‹å«æœ‰æ­¤æ³¨è§£é…ç½®çš„ç±»å¯ä»¥è¢« Dubbo ç®¡ç†ã€‚
- åœ¨ queryActivityById åŠŸèƒ½å®ç°ä¸­ç›®å‰è¿˜æ¯”è¾ƒç²—ç³™ï¼Œä½†å¤§ä½“å¯ä»¥çœ‹å‡ºè¿™æ˜¯å¯¹æ•°æ®åº“çš„æ“ä½œä»¥åŠå¯¹ç»“æœçš„å°è£…ï¼Œæä¾› DTO çš„å¯¹è±¡å¹¶è¿”å› Res ç»“æœã€‚_ç›®å‰dtoçš„åˆ›å»ºåç»­å¯ä»¥ä½¿ç”¨é—¨é¢æ¨¡å¼å’Œå·¥å…·ç±»è¿›è¡Œå¤„ç†_
# æŠ½å¥–æ´»åŠ¨åº“è¡¨è®¾è®¡

### éœ€è¦å“ªäº›åº“è¡¨ï¼Ÿ
- æ´»åŠ¨é…ç½®ï¼Œactivityï¼šæä¾›æ´»åŠ¨çš„åŸºæœ¬é…ç½®
- ç­–ç•¥é…ç½®ï¼Œstrategyï¼šç”¨äºé…ç½®æŠ½å¥–ç­–ç•¥ï¼Œæ¦‚ç‡ã€ç©æ³•ã€åº“å­˜ã€å¥–å“
- ç­–ç•¥æ˜ç»†ï¼Œstrategy_detailï¼šæŠ½å¥–ç­–ç•¥çš„å…·ä½“æ˜ç»†é…ç½®
- å¥–å“é…ç½®ï¼Œawardï¼šç”¨äºé…ç½®å…·ä½“å¯ä»¥å¾—åˆ°çš„å¥–å“
- ç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•è¡¨ï¼Œuser_take_activityï¼šæ¯ä¸ªç”¨æˆ·å‚ä¸æ´»åŠ¨éƒ½ä¼šè®°å½•ä¸‹ä»–çš„å‚ä¸ä¿¡æ¯ï¼Œæ—¶é—´ã€æ¬¡æ•°
- ç”¨æˆ·æ´»åŠ¨å‚ä¸æ¬¡æ•°è¡¨ï¼Œuser_take_activity_countï¼šç”¨äºè®°å½•å½“å‰å‚ä¸äº†å¤šå°‘æ¬¡
- ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨ï¼Œuser_strategy_export_001~004ï¼šæœ€ç»ˆç­–ç•¥ç»“æœçš„ä¸€ä¸ªè®°å½•ï¼Œä¹Ÿå°±æ˜¯å¥–å“ä¸­å¥–ä¿¡æ¯çš„å†…å®¹

### æŠ½å¥–æ´»åŠ¨è¡¨
ç”¨äºæµ‹è¯•ç®€å•çš„rpcæµç¨‹, ä½†æ˜¯æ³¨æ„ï¼Œæ’å…¥æ•°æ®æ—¶ä¼šå‘ç”Ÿä¹±ç é—®é¢˜ã€‚
æ´»åŠ¨è¡¨ï¼šæ˜¯ä¸€ä¸ªç”¨äºé…ç½®æŠ½å¥–æ´»åŠ¨çš„æ€»è¡¨ï¼Œç”¨äºå­˜æ”¾æ´»åŠ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šIDã€åç§°ã€æè¿°ã€æ—¶é—´ã€åº“å­˜ã€å‚ä¸æ¬¡æ•°ç­‰ã€‚
```sql
CREATE TABLE `activity` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
  `activity_id` bigint(20) NOT NULL COMMENT 'æ´»åŠ¨ID',
  `activity_name` varchar(64) CHARACTER SET utf8mb4 DEFAULT NULL COMMENT 'æ´»åŠ¨åç§°',
  `activity_desc` varchar(128) CHARACTER SET utf8mb4 DEFAULT NULL COMMENT 'æ´»åŠ¨æè¿°',
  `begin_date_time` datetime DEFAULT NULL COMMENT 'å¼€å§‹æ—¶é—´',
  `end_date_time` datetime DEFAULT NULL COMMENT 'ç»“æŸæ—¶é—´',
  `stock_count` int(11) DEFAULT NULL COMMENT 'åº“å­˜',
  `take_count` int(11) DEFAULT NULL COMMENT 'æ¯äººå¯å‚ä¸æ¬¡æ•°',
  `state` tinyint(2) DEFAULT NULL COMMENT 'æ´»åŠ¨çŠ¶æ€ï¼š1ç¼–è¾‘ã€2æå®¡ã€3æ’¤å®¡ã€4é€šè¿‡ã€5è¿è¡Œ(å®¡æ ¸é€šè¿‡åworkeræ‰«æçŠ¶æ€)ã€6æ‹’ç»ã€7å…³é—­ã€8å¼€å¯',
  `creator` varchar(64) CHARACTER SET utf8mb4 DEFAULT NULL COMMENT 'åˆ›å»ºäºº',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_activity_id` (`activity_id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='æ´»åŠ¨é…ç½®';
```

### 1. lottery.sql

#### æ´»åŠ¨ä¿¡æ¯è¡¨
æ´»åŠ¨åº“å­˜å¯ä»¥ç†è§£ä¸ºé£æ§çš„åº“å­˜ï¼Œä¹Ÿå°±æ˜¯å‚ä¸æ­¤æ¬¡æŠ½å¥–é¡¹ç›®èƒ½å¤Ÿæä¾›çš„æ‰€æœ‰å¥–å“çš„æ•°é‡ã€‚
```sql
create database lottery;

-- auto-generated definition
create table activity
(
    id            bigint auto_increment comment 'è‡ªå¢ID',
    activityId    bigint       null comment 'æ´»åŠ¨ID',
    activityName  varchar(64)  not null comment 'æ´»åŠ¨åç§°',
    activityDesc  varchar(128) null comment 'æ´»åŠ¨æè¿°',
    beginDateTime datetime     not null comment 'å¼€å§‹æ—¶é—´',
    endDateTime   datetime     not null comment 'ç»“æŸæ—¶é—´',
    stockCount    int          not null comment 'åº“å­˜',
    takeCount     int          null comment 'æ¯äººå¯å‚ä¸æ¬¡æ•°',
    state         int          null comment 'æ´»åŠ¨çŠ¶æ€ï¼šç¼–è¾‘ã€æå®¡ã€æ’¤å®¡ã€é€šè¿‡ã€è¿è¡Œã€æ‹’ç»ã€å…³é—­ã€å¼€å¯',
    creator       varchar(64)  not null comment 'åˆ›å»ºäºº',
    createTime    datetime     not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime    datetime     not null comment 'ä¿®æ”¹æ—¶é—´',
    constraint activity_id_uindex
        unique (id)
)
    comment 'æ´»åŠ¨é…ç½®';

alter table activity
    add primary key (id);

```

#### å¥–å“ä¿¡æ¯è¡¨
```sql
-- auto-generated definition
create table award
(
    id           bigint(11) auto_increment comment 'è‡ªå¢ID'
        primary key,
    awardId      bigint                             null comment 'å¥–å“ID',
    awardType    int(4)                             null comment 'å¥–å“ç±»å‹ï¼ˆæ–‡å­—æè¿°ã€å…‘æ¢ç ã€ä¼˜æƒ åˆ¸ã€å®ç‰©å¥–å“æš‚æ— ï¼‰',
    awardCount   int                                null comment 'å¥–å“æ•°é‡',
    awardName    varchar(64)                        null comment 'å¥–å“åç§°',
    awardContent varchar(128)                       null comment 'å¥–å“å†…å®¹ã€Œæ–‡å­—æè¿°ã€Keyã€ç ã€',
    createTime   datetime default CURRENT_TIMESTAMP null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime default CURRENT_TIMESTAMP null comment 'updateTime'
)
    comment 'å¥–å“é…ç½®';
```

#### é…ç½®ç­–ç•¥è¡¨
æŠ½å¥–æ´»åŠ¨çš„å…·ä½“ç»†èŠ‚é…ç½®ï¼Œç»†èŠ‚idï¼Œæ­¤æ¬¡æŠ½å¥–ä½¿ç”¨å“ªä¸€ç§ç®—æ³•ï¼ŒæŠ½å¥–ã€å‘å¥–æ–¹å¼ï¼ˆå³ä½¿ã€å®šæ—¶ï¼‰ã€å‘å¥–æ—¶é—´
```sql
-- auto-generated definition
create table strategy
(
    id           bigint(11) auto_increment comment 'è‡ªå¢ID'
        primary key,
    strategyId   bigint(11)   not null comment 'ç­–ç•¥ID',
    strategyDesc varchar(128) null comment 'ç­–ç•¥æè¿°',
    strategyMode int(4)       null comment 'ç­–ç•¥æ–¹å¼ã€Œ1:å•é¡¹æ¦‚ç‡ã€2:æ€»ä½“æ¦‚ç‡ã€',
    grantType    int(4)       null comment 'å‘æ”¾å¥–å“æ–¹å¼ã€Œ1:å³æ—¶ã€2:å®šæ—¶[å«æ´»åŠ¨ç»“æŸ]ã€3:äººå·¥ã€',
    grantDate    datetime     null comment 'å‘æ”¾å¥–å“æ—¶é—´',
    extInfo      varchar(128) null comment 'æ‰©å±•ä¿¡æ¯',
    createTime   datetime     null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime     null comment 'ä¿®æ”¹æ—¶é—´',
    constraint strategy_strategyId_uindex
        unique (strategyId)
)
    comment 'ç­–ç•¥é…ç½®';

-- auto-generated definition

```

#### æŠ½å¥–æ´»åŠ¨è¯¦æƒ…è¡¨
æè¿°çš„æ˜¯ä¸€ä¸ªæ´»åŠ¨ä¸­ã€ç­–ç•¥ç”¨ä»€ä¹ˆã€**å¥–å“æœ‰å“ªäº›ã€æ¯ä¸ªå¥–å“çš„ä¸­å¥–æ¦‚ç‡**åˆ†åˆ«æœ‰ä»€ä¹ˆ
```sql
create table strategy_detail  
(  
    id                bigint(11) auto_increment comment 'è‡ªå¢ID'  
        primary key,  
    strategyId        bigint(11)    not null comment 'ç­–ç•¥ID',  
    awardId           bigint(11)    null comment 'å¥–å“ID',  
    awardCount        int           null comment 'å¥–å“æ•°é‡',  
    awardRate         decimal(5, 2) null comment 'ä¸­å¥–æ¦‚ç‡',  
    createTime        datetime      null comment 'åˆ›å»ºæ—¶é—´',  
    updateTime        datetime      null comment 'ä¿®æ”¹æ—¶é—´',  
    awardSurplusCount int default 0 null comment 'å¥–å“å‰©ä½™åº“å­˜'  
)  
    comment 'æŠ½å¥–æƒ…å†µè¡¨';
```

### lottery_01.sql
2. lottery_01.sql ~ lottery_02.sql
æ¯ä¸ªç”¨æˆ·å‚ä¸æŠ½å¥–æ´»åŠ¨åéƒ½
#### ç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•è¡¨
```sql
create database lottery_01;

DROP TABLE IF EXISTS `user_take_activity`;  
CREATE TABLE `user_take_activity`  (  
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',  
  `u_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'ç”¨æˆ·ID',  
  `take_id` bigint(20) NULL DEFAULT NULL COMMENT 'æ´»åŠ¨é¢†å–ID',  
  `activity_id` bigint(20) NULL DEFAULT NULL COMMENT 'æ´»åŠ¨ID',  
  `activity_name` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'æ´»åŠ¨åç§°',  
  `take_date` datetime(0) NULL DEFAULT NULL COMMENT 'æ´»åŠ¨é¢†å–æ—¶é—´',  
  `take_count` int(11) NULL DEFAULT NULL COMMENT 'é¢†å–æ¬¡æ•°',  
  `strategy_id` int(11) NULL DEFAULT NULL COMMENT 'æŠ½å¥–ç­–ç•¥ID',  
  `state` tinyint(4) NULL DEFAULT NULL COMMENT 'æ´»åŠ¨å•ä½¿ç”¨çŠ¶æ€ 0æœªä½¿ç”¨ã€1å·²ä½¿ç”¨',  
  `uuid` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'é˜²é‡ID',  
  `create_time` datetime(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT 'åˆ›å»ºæ—¶é—´',  
  `update_time` datetime(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT 'æ›´æ–°æ—¶é—´',  
  PRIMARY KEY (`id`) USING BTREE,  
  UNIQUE INDEX `idx_uuid`(`uuid`) USING BTREE COMMENT 'é˜²é‡ID'  
) ENGINE = InnoDB AUTO_INCREMENT = 32 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_bin COMMENT = 'ç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•è¡¨' ROW_FORMAT = Dynamic;

```

#### ç”¨æˆ·ä¸­å¥–ç»“æœè¡¨
mq_state
```sql

-- auto-generated definition
DROP TABLE IF EXISTS `user_strategy_export_001`;  
CREATE TABLE `user_strategy_export_001`  (  
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',  
  `u_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'ç”¨æˆ·ID',  
  `activity_id` bigint(20) NULL DEFAULT NULL COMMENT 'æ´»åŠ¨ID',  
  `order_id` bigint(20) NULL DEFAULT NULL COMMENT 'è®¢å•ID',  
  `strategy_id` bigint(20) NULL DEFAULT NULL COMMENT 'ç­–ç•¥ID',  
  `strategy_mode` tinyint(4) NULL DEFAULT NULL COMMENT 'ç­–ç•¥æ–¹å¼ï¼ˆ1:å•é¡¹æ¦‚ç‡ã€2:æ€»ä½“æ¦‚ç‡ï¼‰',  
  `grant_type` tinyint(4) NULL DEFAULT NULL COMMENT 'å‘æ”¾å¥–å“æ–¹å¼ï¼ˆ1:å³æ—¶ã€2:å®šæ—¶[å«æ´»åŠ¨ç»“æŸ]ã€3:äººå·¥ï¼‰',  
  `grant_date` datetime(0) NULL DEFAULT NULL COMMENT 'å‘å¥–æ—¶é—´',  
  `grant_state` tinyint(4) NULL DEFAULT NULL COMMENT 'å‘å¥–çŠ¶æ€',  
  `award_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'å‘å¥–ID',  
  `award_type` tinyint(4) NULL DEFAULT NULL COMMENT 'å¥–å“ç±»å‹ï¼ˆ1:æ–‡å­—æè¿°ã€2:å…‘æ¢ç ã€3:ä¼˜æƒ åˆ¸ã€4:å®ç‰©å¥–å“ï¼‰',  
  `award_name` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'å¥–å“åç§°',  
  `award_content` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'å¥–å“å†…å®¹ã€Œæ–‡å­—æè¿°ã€Keyã€ç ã€',  
  `uuid` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'é˜²é‡ID',  
  `mq_state` tinyint(4) NULL DEFAULT NULL COMMENT 'æ¶ˆæ¯å‘é€çŠ¶æ€ï¼ˆ0æœªå‘é€ã€1å‘é€æˆåŠŸã€2å‘é€å¤±è´¥ï¼‰',  
  `create_time` datetime(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT 'åˆ›å»ºæ—¶é—´',  
  `update_time` datetime(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT 'æ›´æ–°æ—¶é—´',  
  PRIMARY KEY (`id`) USING BTREE,  
  UNIQUE INDEX `idx_uuid`(`uuid`) USING BTREE  
) ENGINE = InnoDB AUTO_INCREMENT = 9 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_bin COMMENT = 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨' ROW_FORMAT = Dynamic;


DROP TABLE IF EXISTS `user_take_activity_count`;  
CREATE TABLE `user_take_activity_count`  (  
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',  
  `u_id` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NULL DEFAULT NULL COMMENT 'ç”¨æˆ·ID',  
  `activity_id` bigint(20) NULL DEFAULT NULL COMMENT 'æ´»åŠ¨ID',  
  `total_count` int(11) NULL DEFAULT NULL COMMENT 'å¯é¢†å–æ¬¡æ•°',  
  `left_count` int(11) NULL DEFAULT NULL COMMENT 'å·²é¢†å–æ¬¡æ•°',  
  `create_time` datetime(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT 'åˆ›å»ºæ—¶é—´',  
  `update_time` datetime(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT 'æ›´æ–°æ—¶é—´',  
  PRIMARY KEY (`id`) USING BTREE,  
  UNIQUE INDEX `idx_uId_activityId`(`u_id`, `activity_id`) USING BTREE  
) ENGINE = InnoDB AUTO_INCREMENT = 6 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_bin COMMENT = 'ç”¨æˆ·æ´»åŠ¨å‚ä¸æ¬¡æ•°è¡¨' ROW_FORMAT = Dynamic;

```

---

1. è¿™äº›åº“è¡¨æ˜¯ç”¨äºæ”¯æ’‘èµ·æŠ½å¥–ç³»ç»Ÿå¼€å‘çš„å¿…å¤‡è¡¨ï¼Œåç»­å¯èƒ½ä¼šéšç€åŠŸèƒ½çš„å¼€å‘åšé€‚å½“çš„è°ƒæ•´ã€‚
2. æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå›´ç»•è¿™äº›åº“è¡¨ä¸€ç‚¹ç‚¹å®ç°å„ä¸ªé¢†åŸŸçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼šæŠ½å¥–ç­–ç•¥é¢†åŸŸã€å¥–å“å‘æ”¾é¢†åŸŸã€æ´»åŠ¨ä¿¡æ¯é¢†åŸŸç­‰

### ç®€ç­”é¢˜

**è¡¨ç»“æ„æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼š**
æ´»åŠ¨é…ç½®è¡¨ï¼šæ´»åŠ¨IDï¼Œå¼€å§‹ã€ç»“æŸæ—¶é—´ï¼Œæ´»åŠ¨åº“å­˜ï¼Œæ´»åŠ¨çŠ¶æ€ï¼Œæ´»åŠ¨ç­–ç•¥

æŠ½å¥–ç­–ç•¥é…ç½®è¡¨ï¼šç­–ç•¥IDï¼Œç­–ç•¥æè¿°ï¼ŒæŠ½å¥–ç®—æ³•ï¼Œå‘å¥–æ–¹å¼ï¼Œå‘å¥–æ—¶é—´ï¼Œå¥–å“ç¼–å·ï¼Œå¥–å“åº“å­˜

ç”¨æˆ·è¡¨ï¼šå‚ä¸æ´»åŠ¨è®°å½•è¡¨ï¼Œæ´»åŠ¨IDï¼Œå‚ä¸æ—¶é—´ï¼Œå¯å‚ä¸çš„æ¬¡æ•°ç­‰ã€‚

ç”¨æˆ·æŠ½å¥–è®¡ç®—ç»“æœè¡¨ï¼šæ´»åŠ¨IDï¼Œæ˜¯å¦ä¸­å¥–ï¼Œå¥–å“IDï¼Œå‘å¥–çŠ¶æ€ï¼Œå‘å¥–æ—¶é—´ç­‰ã€‚

  # é¡¹ç›®è®¾è®¡æ¨¡å¼

æ¨¡æ¿ã€å·¥å‚ã€ç­–ç•¥æ¨¡å¼ä½¿ç”¨åœ¨å“ªäº›åœ°æ–¹ï¼Ÿ

### å·¥å‚æ¨¡å¼

å·¥å‚æ¨¡å¼ï¼šæä¾›ä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±»ç”¨äºåˆ›å»ºå¯¹è±¡ï¼Œå…è®¸å­ç±»å»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±»ã€‚
**å®ç°å‘å¥–ï¼š**
é¦–å…ˆå®šä¹‰ä¸€ä¸ªæŠ½è±¡çš„å¥–å“ç±»ï¼Œç„¶åæ¯ç§å¥–å“è®¾è®¡è‡ªå·±çš„å®ç°ç±»ï¼Œåˆ›å»ºä¸€ä¸ªé…ç½®ç±»ï¼ŒæŠŠæ‰€æœ‰å¥–å“ç±»çš„å®ç°å°è£…åˆ°mapä¸­ï¼Œå®šä¹‰ä¸€ä¸ªå·¥å‚ç±»ï¼Œé€šè¿‡map.getï¼ˆï¼‰æŠŠå‘è´§å¥–å“çš„å®ç°äº¤ç»™å­ç±»å»å®ç°ï¼Œå‡å°‘if elseçš„ä½¿ç”¨ï¼Œå¹¶ä¸”ï¼Œå®šä¹‰äº†æ–°çš„å¥–å“ç±»ä¹‹åä¹Ÿå¯ä»¥ç›´æ¥åŠ å…¥mapï¼Œèƒ½å¤Ÿå‡å°‘ä»£ç æ”¹åŠ¨ã€‚


### æ¨¡æ¿æ¨¡å¼

æ¨¡æ¿æ¨¡å¼ï¼š
æ ¸å¿ƒæ¦‚å¿µæ˜¯åœ¨**æŠ½è±¡ç±»**ä¸­å®šä¹‰ä¸€ä¸ª**ç®—æ³•çš„å®ç°æ¡†æ¶**ï¼Œå…·ä½“çš„å®ç°æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»å»å®ç°ï¼Œé‡ç‚¹æ˜¯å›ºå®šä¸€å¥—ç®—æ³•æµç¨‹ï¼Œä¸æ”¹å˜å®ç°æ–¹å¼ã€‚å®šä¹‰äº†å‚ä¸æ´»åŠ¨ã€æŠ½å¥–ã€å‘å¥–çš„æ•´ä½“æµç¨‹ã€‚é¦–å…ˆå®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè¿™ä¸ªæŠ½è±¡ç±»ä¸­åŒ…å«äº†ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå¯ä»¥ç”¨finalå…³é”®å­—ä¿®é¥°ï¼Œä»–æ˜¯ä¸€ä¸ªå…·ä½“çš„æ–¹æ³•ï¼Œå®šä¹‰äº†æ•´ä¸ªè¿‡ç¨‹çš„æµç¨‹å’Œæ­¥éª¤ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜ä¼š**å®šä¹‰æŠ½è±¡æ­¥éª¤æ–¹æ³•**ï¼Œå…·ä½“çš„å®ç°åœ¨å­ç±»ä¸­è¿›è¡Œå®ç°ã€‚

**ä½¿ç”¨åœºæ™¯/ç¼–æ’æµç¨‹ï¼š**


```java
public abstract class BaseActivityPartake extends ActivityPartakeSupport implements IActivityPartake {  
  
    @Resource  
    private Map<Constants.Ids, IIdGenerator> idGeneratorMap;  
  
    @Override  
    public PartakeResult doPartake(PartakeReq req) {  
  
        // 1. æŸ¥è¯¢æ˜¯å¦å­˜åœ¨æœªæ‰§è¡ŒæŠ½å¥–é¢†å–æ´»åŠ¨å•ã€user_take_activity å­˜åœ¨ state = 0ï¼Œé¢†å–äº†ä½†æŠ½å¥–è¿‡ç¨‹å¤±è´¥çš„ï¼Œå¯ä»¥ç›´æ¥è¿”å›é¢†å–ç»“æœç»§ç»­æŠ½å¥–ã€‘  
        UserTakeActivityVO userTakeActivityVO = this.queryNoConsumedTakeActivityOrder(req.getActivityId(), req.getuId());  
        if (null != userTakeActivityVO) {  
            return buildPartakeResult(userTakeActivityVO.getStrategyId(), userTakeActivityVO.getTakeId(), Constants.ResponseCode.NOT_CONSUMED_TAKE);  
        }  
  
        // 2. æŸ¥è¯¢æ´»åŠ¨è´¦å•  
        ActivityBillVO activityBillVO = super.queryActivityBill(req);  
  
        // 3. æ´»åŠ¨ä¿¡æ¯æ ¡éªŒå¤„ç†ã€æ´»åŠ¨åº“å­˜ã€çŠ¶æ€ã€æ—¥æœŸã€ä¸ªäººå‚ä¸æ¬¡æ•°ã€‘  
        Result checkResult = this.checkActivityBill(req, activityBillVO);  
        if (!Constants.ResponseCode.SUCCESS.getCode().equals(checkResult.getCode())) {  
            return new PartakeResult(checkResult.getCode(), checkResult.getInfo());  
        }  
  
        // 4. æ‰£å‡æ´»åŠ¨åº“å­˜ï¼Œé€šè¿‡Redisã€æ´»åŠ¨åº“å­˜æ‰£å‡ç¼–å·ï¼Œä½œä¸ºé”çš„Keyï¼Œç¼©å°é¢—ç²’åº¦ã€‘ Begin        StockResult subtractionActivityResult = this.subtractionActivityStockByRedis(req.getuId(), req.getActivityId(), activityBillVO.getStockCount(), activityBillVO.getEndDateTime());  
  
        if (!Constants.ResponseCode.SUCCESS.getCode().equals(subtractionActivityResult.getCode())) {  
            this.recoverActivityCacheStockByRedis(req.getActivityId(), subtractionActivityResult.getStockKey(), subtractionActivityResult.getCode());  
            return new PartakeResult(subtractionActivityResult.getCode(), subtractionActivityResult.getInfo());  
        }  
  
        // 5. æ’å…¥é¢†å–æ´»åŠ¨ä¿¡æ¯ã€ä¸ªäººç”¨æˆ·æŠŠæ´»åŠ¨ä¿¡æ¯å†™å…¥åˆ°ç”¨æˆ·è¡¨ã€‘  
        Long takeId = idGeneratorMap.get(Constants.Ids.SnowFlake).nextId();  
        Result grabResult = this.grabActivity(req, activityBillVO, takeId);  
        if (!Constants.ResponseCode.SUCCESS.getCode().equals(grabResult.getCode())) {  
            this.recoverActivityCacheStockByRedis(req.getActivityId(), subtractionActivityResult.getStockKey(), grabResult.getCode());  
            return new PartakeResult(grabResult.getCode(), grabResult.getInfo());  
        }  
  
        // 6. æ‰£å‡æ´»åŠ¨åº“å­˜ï¼Œé€šè¿‡Redis End  
        this.recoverActivityCacheStockByRedis(req.getActivityId(), subtractionActivityResult.getStockKey(), Constants.ResponseCode.SUCCESS.getCode());  
  
        return buildPartakeResult(activityBillVO.getStrategyId(), takeId, activityBillVO.getStockCount(), subtractionActivityResult.getStockSurplusCount(), Constants.ResponseCode.SUCCESS);  
    }
```
---
ç”¨æˆ·é¢†å–æ´»åŠ¨
|
**æ‰§è¡ŒæŠ½å¥–**
	ä½¿ç”¨ä¸åŒæŠ½å¥–ç®—æ³•ï¼Œé‚£ä¹ˆæŠ½å¥–è¿‡ç¨‹çš„ç»†èŠ‚ä¹Ÿæ˜¯ä¸åŒçš„
|
ç»“æœè½åº“
|
å‘é€MQè§¦å‘å‘å¥–æµç¨‹ï¼ˆå¼‚æ­¥å®ç°ï¼‰
|
è¿”å›ç»“æœ

---

### ç­–ç•¥æ¨¡å¼

ç­–ç•¥æ¨¡å¼ï¼šå®ç°å¤šç§ç®—æ³•ï¼Œä¸»è¦æ˜¯æŒ‡å°†æ¯ä¸ªç®—æ³•éƒ½å°è£…èµ·æ¥ï¼Œå¹¶ä¸”ä½¿ä»–ä»¬ä¹‹é—´åœ¨ä½¿ç”¨æ—¶å¯ä»¥äº’æ¢ã€‚å®šä¹‰ä¸€ä¸ªæŠ½å¥–ç­–ç•¥çš„å®ç°æ¥å£ï¼Œæ¯ç§æŠ½å¥–ç®—æ³•å®ç°è¯¥æ¥å£å½¢æˆå¯¹åº”çš„æŠ½å¥–ç±»ï¼Œæ ¹æ®è¿è¡Œä¸­ä¼ é€’çš„å‚æ•°é€‰æ‹©å¯¹åº”çš„å®ç°æ–¹å¼ï¼Œå¯ä»¥å°†æ‰€æœ‰ç­–ç•¥çš„å®ç°æ–¹å¼å°è£…åœ¨mapä¸­ï¼Œè¿™æ ·å¯ä»¥æ›´åŠ çµæ´»çš„æ‰©å±•ã€‚å®ƒçš„ç‰¹ç‚¹å°±æ˜¯å°†ç­–ç•¥çš„å®ç°å’Œå¯¹ç­–ç•¥çš„é€‰æ‹©åˆ†å¼€ã€‚

### çŠ¶æ€æ¨¡å¼
æŠ½å¥–æ´»åŠ¨å®¡æ ¸ï¼ŒçŠ¶æ€æµè½¬ç¼–æ’
å®šä¹‰å¾ˆå¤šæµç¨‹çŠ¶æ€ï¼ŒçŠ¶æ€å¯¹åº”çš„å¯¹è±¡æˆ‘ä»¬ä¼šåšæˆå…·ä½“å®ç°ç±»ï¼Œæ¯ä¸ªå¯¹è±¡å¯¹è¿™äº›ç¼–æ’çš„çŠ¶æ€éƒ½æœ‰è‡ªèº«æµè½¬çš„è¡Œä¸ºå®šä¹‰ã€‚


### ç»„åˆæ¨¡å¼

å‚è€ƒæ–‡ç« [ç»„åˆæ¨¡å¼](https://refactoringguru.cn/design-patterns/composite)
1. ç»„åˆæ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼ŒÂ ä½ å¯ä»¥ä½¿ç”¨å®ƒå°†ç›¸ä¼¼å¯¹è±¡ç»„åˆæˆç±»æ ‘çŠ¶ç»“æ„ï¼ŒÂ å¹¶ä¸”èƒ½åƒä½¿ç”¨ç‹¬ç«‹å¯¹è±¡ä¸€æ ·ä½¿ç”¨å®ƒä»¬ã€‚
2. `ç»„åˆå›¾å½¢`CompoundÂ­Graphicæ˜¯ä¸€ä¸ªå®¹å™¨ï¼ŒÂ å®ƒå¯ä»¥ç”±å¤šä¸ªåŒ…æ‹¬å®¹å™¨åœ¨å†…çš„å­å›¾å½¢æ„æˆã€‚Â ç»„åˆå›¾å½¢ä¸ç®€å•å›¾å½¢æ‹¥æœ‰ç›¸åŒçš„æ–¹æ³•ã€‚Â ä½†æ˜¯ï¼ŒÂ ç»„åˆå›¾å½¢è‡ªèº«å¹¶ä¸å®Œæˆå…·ä½“å·¥ä½œï¼ŒÂ è€Œæ˜¯**å°†è¯·æ±‚é€’å½’åœ°ä¼ é€’ç»™è‡ªå·±çš„å­é¡¹ç›®ï¼ŒÂ ç„¶åÂ â€œæ±‡æ€»â€Â ç»“æœã€‚

# åˆ†åº“åˆ†è¡¨è·¯ç”±å®ç°

## sharding-jdbcä½¿ç”¨
ä¸é¡¹ç›®ä»£ç ç»“åˆå®è·µï¼Œæ–‡ç« ä¸­ç»„ä»¶ä½¿ç”¨éƒ¨åˆ†å·²æ•´ç†ç¬”è®°
[[2024-10-11-åˆ†åº“åˆ†è¡¨ç»„ä»¶]]
## äº‹åŠ¡ç®¡ç†
å®é™…ä¸Šç”±äºspringæœ¬èº«ä¹Ÿæä¾›äº†é¡¹ç›®çš„äº‹åŠ¡ç®¡ç†åŠŸèƒ½ï¼Œæ·»åŠ `@Transactional`æ³¨è§£é»˜è®¤å¼€å¯ã€‚ä½†æ˜¯ç”±äºsharding-jdbcæä¾›äº†
åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¸ºäº†æé«˜å…¶å¯æ‰©å±•æ€§æˆ‘ä»¬ä¼˜å…ˆé€‰æ‹©sharding-jdbcçš„äº‹åŠ¡ç®¡ç†ã€‚
è¯¦æƒ…è§ï¼šsharding-jdbcäº‹åŠ¡ç®¡ç†å™¨è¯¦è§£ï¼š[[2024-10-11-åˆ†åº“åˆ†è¡¨ç»„ä»¶]]
1. æœ¬åœ°äº‹åŠ¡çš„å¼€å¯ä»…éœ€åŠ æ³¨è§£ @Transactionalå³å¯ï¼Œ@ShardingTransaction(TransactionType.LOCAL)æ˜¯é€‰æ‹©shardingçš„åˆ†å¸ƒå¼äº‹åŠ¡ç±»å‹ï¼Œæ­¤æ³¨è§£ä¸æ·»åŠ çš„åŒ–ä¼šé»˜è®¤ä½¿ç”¨æœ¬åœ°äº‹åŠ¡ã€‚
2. ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡é€‰ç”¨`TransactionType.XA`æ³¨è§£å³å¯
### ä¸šåŠ¡æµç¨‹
åœ¨å‚ä¸æ´»åŠ¨ç¯èŠ‚ä¸­æˆ‘ä»¬é€šè¿‡æ¨¡æ¿æ¨¡å¼å®šä¹‰äº†ä¸‰ä¸ªæµç¨‹ï¼š
1. æ ¡éªŒæœ¬æ¬¡æ´»åŠ¨æ˜¯å¦å¯ä»¥å‚ä¸ï¼ˆæ´»åŠ¨ä¿¡æ¯é…ç½®ç”Ÿæˆå­˜å‚¨åœ¨ActivityBillVO billå¯¹è±¡ä¸­ï¼‰
	1. æ ¡éªŒï¼šæ´»åŠ¨çŠ¶æ€
	2. æ ¡éªŒï¼šæ´»åŠ¨æ—¥æœŸ
	3. æ ¡éªŒï¼šæ´»åŠ¨åº“å­˜
	4. æ ¡éªŒï¼šä¸ªäººåº“å­˜ - ä¸ªäººæ´»åŠ¨å‰©ä½™å¯é¢†å–æ¬¡æ•°
2. æ‰£å‡æ´»åŠ¨è¡¨å¯å‚ä¸æ´»åŠ¨æ¬¡æ•°
	1. æ‰£å‡æ´»åŠ¨åº“å­˜ã€ç›®å‰ä¸ºç›´æ¥å¯¹é…ç½®åº“ä¸­çš„ lottery.activity ç›´æ¥æ“ä½œè¡¨æ‰£å‡åº“å­˜ï¼Œåç»­ä¼˜åŒ–ä¸ºRedisæ‰£å‡ã€‘![[Pasted image 20241012195940.png]]
3. åœ¨ç”¨æˆ·å‚ä¸æ´»åŠ¨è¡¨æ–°å¢ç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•ï¼ˆgrabActivityï¼‰
	1. åœ¨ç”¨æˆ·ä¸ªäººå‚ä¸æ´»åŠ¨è®°å½•è¡¨ä¸­ æ‰£å‡ä¸ªäººå¯å‚ä¸æ¬¡æ•°![[Pasted image 20241012200156.png]]
	2. åœ¨ç”¨æˆ·æ´»åŠ¨å…³è”è¡¨ä¸­ æ’å…¥ç”¨æˆ·å‚ä¸æ´»åŠ¨ä¿¡æ¯![[Pasted image 20241012200312.png]]

ä¸ºä¿è¯æ´»åŠ¨å‚ä¸è¡¨ä¸ç”¨æˆ·å‚ä¸æ´»åŠ¨è¡¨æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©å¯¹grabActivityæ–¹æ³•æ·»åŠ æ³¨è§£å¼äº‹åŠ¡ç®¡ç†ã€‚
### ä¸šåŠ¡å®ç°

**ç”±äºæ¶‰åŠåˆ°äº‹åŠ¡ç®¡ç†çš„ä¸¤ä¸ªè¡¨ï¼ˆuser_take_activityã€user_take_activity_countï¼‰åªè¿›è¡Œäº†åˆ†åº“å¹¶æœªè¿›è¡Œåˆ†è¡¨ï¼ˆlottery01ï¼‰ï¼Œå› æ­¤é€‰ç”¨æœ¬åœ°äº‹åŠ¡ç®¡ç†å™¨å³å¯**ã€‚
ã€å› ä¸ºlocal**æœ¬åœ°äº‹åŠ¡ç®¡ç†**å®Œå…¨æ”¯æŒéè·¨åº“äº‹åŠ¡ï¼Œ**ä¾‹å¦‚ï¼šä»…åˆ†è¡¨ï¼Œæˆ–åˆ†åº“ä½†æ˜¯è·¯ç”±çš„ç»“æœåœ¨å•åº“ä¸­ã€‚**ã€‘
![[Pasted image 20241012204447.png]]
åœ¨éœ€è¦äº‹åŠ¡çš„æ–¹æ³•ä¸­æ·»åŠ ç›¸å…³æ³¨è§£å³å¯ï¼Œä¾‹å¦‚ï¼š
```java
@ShardingTransactionType(TransactionType.LOCAL)
@Transactional
```
#### **å®Œæ•´ä»£ç ï¼š**
```java
@ShardingTransactionType(TransactionType.LOCAL) 
@Transactional
@Override  
protected Result grabActivity(PartakeReq partake, ActivityBillVO bill) {
                // æ‰£å‡ä¸ªäººå·²å‚ä¸æ¬¡æ•°  
                int updateCount = userTakeActivityRepository.subtractionLeftCount(bill.getActivityId(), bill.getActivityName(), bill.getTakeCount(), bill.getUserTakeLeftCount(), partake.getuId(), partake.getPartakeDate());  
                if (0 == updateCount) {  
                    status.setRollbackOnly();  
                    logger.error("é¢†å–æ´»åŠ¨ï¼Œæ‰£å‡ä¸ªäººå·²å‚ä¸æ¬¡æ•°å¤±è´¥ activityIdï¼š{} uIdï¼š{}", partake.getActivityId(), partake.getuId());  
                    return Result.buildResult(Constants.ResponseCode.NO_UPDATE);  
                }  
  
                // æ’å…¥é¢†å–æ´»åŠ¨ä¿¡æ¯  
                Long takeId = idGeneratorMap.get(Constants.Ids.SnowFlake).nextId();  
                userTakeActivityRepository.takeActivity(bill.getActivityId(), bill.getActivityName(), bill.getTakeCount(), bill.getUserTakeLeftCount(), partake.getuId(), partake.getPartakeDate(), takeId);  
            } catch (DuplicateKeyException e) {  
                status.setRollbackOnly();  
                logger.error("é¢†å–æ´»åŠ¨ï¼Œå”¯ä¸€ç´¢å¼•å†²çª activityIdï¼š{} uIdï¼š{}", partake.getActivityId(), partake.getuId(), e);  
                return Result.buildResult(Constants.ResponseCode.INDEX_DUP);  
            }  
            return Result.buildSuccessResult();  
}
```
#### éªŒè¯ç»“æœ
å‡†å¤‡æ•°æ®ï¼š
![[Pasted image 20241012212227.png]]
![[Pasted image 20241012212244.png]]
ç»“æœéªŒè¯ï¼š
![[Pasted image 20241012212315.png]]


## åœºæ™¯é—®é¢˜



# è§„åˆ™å¼•æ“â€”â€”å†³ç­–æ ‘

## å†³ç­–æ ‘ç®€ä»‹
é™¤äº†æ™®é€šæŠ½å¥–ä»¥å¤–ï¼Œé¡¹ç›®è¿˜æä¾›äº†æ ¹æ®ä¸åŒäººç¾¤ç”»åƒä»è§„åˆ™å¼•æ“æ ‘ä¸­æŸ¥æ‰¾å¹¶åŒ¹é…åˆ°åˆé€‚è¯¥ç”¨æˆ·æŠ½å¥–çš„æ´»åŠ¨idï¼Œå†å‚ä¸æŠ½å¥–æ–¹å¼ã€‚å› æ­¤æˆ‘ä»¬é‡‡ç”¨**ç»„åˆæ¨¡å¼**æŠŠä¸åŒçš„å†³ç­–æ¡ä»¶å’Œå†³ç­–ç»†èŠ‚éƒ½å°è£…åˆ°æ ‘å½¢ç»“æ„ä¸­ã€‚

è§„åˆ™å¼•æ“çš„æ ¸å¿ƒç®—æ³•åŸç†åŒ…æ‹¬å†³ç­–æ ‘æ„å»ºã€å†³ç­–æ ‘æ‰§è¡Œã€è§„åˆ™åŒ¹é…ã€è§„åˆ™æ‰§è¡Œã€‚
è§„åˆ™å¼•æ“åˆ†ä¸º **è§„åˆ™ç®¡ç†å™¨ + æ¨ç†å¼•æ“ã€‚**

**ç»„åˆæ¨¡å¼**ï¼š
å‚è€ƒæ–‡ç« [ç»„åˆæ¨¡å¼](https://refactoringguru.cn/design-patterns/composite)
1. ç»„åˆæ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼ŒÂ ä½ å¯ä»¥ä½¿ç”¨å®ƒå°†ç›¸ä¼¼å¯¹è±¡ç»„åˆæˆç±»æ ‘çŠ¶ç»“æ„ï¼ŒÂ å¹¶ä¸”èƒ½åƒä½¿ç”¨ç‹¬ç«‹å¯¹è±¡ä¸€æ ·ä½¿ç”¨å®ƒä»¬ã€‚
2. `ç»„åˆå›¾å½¢`CompoundÂ­Graphicæ˜¯ä¸€ä¸ªå®¹å™¨ï¼ŒÂ å®ƒå¯ä»¥ç”±å¤šä¸ªåŒ…æ‹¬å®¹å™¨åœ¨å†…çš„å­å›¾å½¢æ„æˆã€‚Â ç»„åˆå›¾å½¢ä¸ç®€å•å›¾å½¢æ‹¥æœ‰ç›¸åŒçš„æ–¹æ³•ã€‚Â ä½†æ˜¯ï¼ŒÂ ç»„åˆå›¾å½¢è‡ªèº«å¹¶ä¸å®Œæˆå…·ä½“å·¥ä½œï¼ŒÂ è€Œæ˜¯**å°†è¯·æ±‚é€’å½’åœ°ä¼ é€’ç»™è‡ªå·±çš„å­é¡¹ç›®ï¼ŒÂ ç„¶åÂ â€œæ±‡æ€»â€Â ç»“æœã€‚**

è§„åˆ™æ ‘éœ€è¦å­˜å‚¨Mysqlæ•°æ®åº“ä¸­ï¼Œå› ä¸ºæ”¾åœ¨æ•°æ®åº“å¯ä»¥è¿›è¡ŒåŠ¨æ€åŒ–é…ç½®ï¼Œæ— éœ€å¤§é‡æ”¹åŠ¨ä»£ç ï¼Œåªéœ€è¦æ–°å¢å¯¹åº”çš„è§„åˆ™å¼•æ“å³å¯ï¼ˆfilterï¼‰ã€‚
1. é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¡¨**ä¿å­˜è§„åˆ™æ ‘çš„ç»“æ„**
	* ä¾‹å¦‚æ ¹æ®æ€§åˆ«å’Œå¹´é¾„åˆ’åˆ†çš„è§„åˆ™æ ‘ï¼Œéœ€è¦å…ˆæ ¹æ®æ€§åˆ«ç­›é€‰äººç¾¤ï¼Œå†æ ¹æ®å¹´é¾„èŒƒå›´ç­›é€‰æŸç±»äººç¾¤å¯ä»¥å‚ä¸å“ªä¸ªæ´»åŠ¨
2. è¿˜éœ€è¦ä¸€å¼ è¡¨ç”¨äºè®°å½•**æ‰€æœ‰ä»æ ¹èŠ‚ç‚¹åˆ°æœå®èŠ‚ç‚¹çš„ä¸€æ¡å¯é‡åŒ–ç­›é€‰äººç¾¤çš„è§„åˆ™é“¾è·¯ï¼Œå³è¿™é¢—è§„åˆ™æ ‘çš„å…¨éƒ¨ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„è·¯å¾„**
	* ä¾‹å¦‚æŸä¸ªç”¨æˆ·ç”»åƒã€ç”·ï¼Œ26å²ã€‘ï¼Œä¼šæ ¹æ®è¿‡æ»¤å™¨è¿›å…¥æ€§åˆ«ç”·ã€å¹´é¾„`>=25`å²ã€å‚ä¸id=xxxæ´»åŠ¨çš„é“¾è·¯ä¸­ã€‚
3. åˆå› ä¸º**ä¸åŒçš„è§„åˆ™æ ‘åªèƒ½ä¿å­˜ä¸€ç»„ä¸åŒæ¡ä»¶çš„ç”¨æˆ·ç­›é€‰é€»è¾‘**ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªè¡¨ç”¨äºè®°å½•æ‰€æœ‰ç§ç±»çš„è§„åˆ™æ ‘ã€‚
	* ä¾‹å¦‚æŠ½å¥–æ´»åŠ¨éœ€è¦æ ¹æ®å¹´é¾„ã€æ€§åˆ«ç”»åƒç»„æˆçš„è§„åˆ™æ ‘ï¼›ä¹Ÿéœ€è¦æ ¹æ®ä¸‹å•é‡ã€æ€§åˆ«ç»„æˆè§„åˆ™æ ‘ã€‚

![[Pasted image 20241014165522.png]]

## åº“è¡¨è®¾è®¡

1. åˆ›å»ºè¡¨`rule_tree`ç”¨äºä¿å­˜æ‰€æœ‰ä¸åŒç±»å‹çš„è§„åˆ™æ ‘ï¼Œæ–¹ä¾¿æ‹“å±•ä¸åŒçš„è¿‡æ»¤è§„åˆ™
2. åˆ›å»ºè¡¨`rule_tree_node`ç”¨äºå®šä¹‰è§„åˆ™æ ‘çš„æ ‘å½¢ç»“æ„
3. åˆ›å»ºè¡¨`rule_tree_node_line`ç”¨äºä¿å­˜ï¼ˆåŒä¸€ï¼‰è§„åˆ™æ ‘çš„æ‰€æœ‰è¿‡æ»¤é“¾è·¯

```sql
-- ----------------------------  
-- Table structure for rule_tree  
-- ----------------------------  
DROP TABLE IF EXISTS `rule_tree`;  
CREATE TABLE `rule_tree` (  
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',  
  `tree_name` varchar(64) DEFAULT NULL COMMENT 'è§„åˆ™æ ‘Id',  
  `tree_desc` varchar(128) DEFAULT NULL COMMENT 'è§„åˆ™æ ‘æè¿°',  
  `tree_root_node_id` bigint(20) DEFAULT NULL COMMENT 'è§„åˆ™æ ‘æ ¹ID',  
  `create_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',  
  `update_time` datetime DEFAULT NULL COMMENT 'æ›´æ–°æ—¶é—´',  
  PRIMARY KEY (`id`)  
) ENGINE=InnoDB AUTO_INCREMENT=10002 DEFAULT CHARSET=utf8;  
  
-- ----------------------------  
-- Records of rule_tree  
-- ----------------------------  
BEGIN;  
INSERT INTO `rule_tree` VALUES (2110081902, 'æŠ½å¥–æ´»åŠ¨è§„åˆ™æ ‘', 'ç”¨äºå†³ç­–ä¸åŒç”¨æˆ·å¯å‚ä¸çš„æ´»åŠ¨', 1, '2021-10-08 15:38:05', '2021-10-08 15:38:05');  
COMMIT;  
  
-- ----------------------------  
-- Table structure for rule_tree_node  
-- ----------------------------  
DROP TABLE IF EXISTS `rule_tree_node`;  
CREATE TABLE `rule_tree_node` (  
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',  
  `tree_id` int(2) DEFAULT NULL COMMENT 'è§„åˆ™æ ‘ID',  
  `node_type` int(2) DEFAULT NULL COMMENT 'èŠ‚ç‚¹ç±»å‹ï¼›1å­å¶ã€2æœå®',  
  `node_value` varchar(32) DEFAULT NULL COMMENT 'èŠ‚ç‚¹å€¼[nodeType=2]ï¼›æœå®å€¼',  
  `rule_key` varchar(16) DEFAULT NULL COMMENT 'è§„åˆ™Key',  
  `rule_desc` varchar(32) DEFAULT NULL COMMENT 'è§„åˆ™æè¿°',  
  PRIMARY KEY (`id`)  
) ENGINE=InnoDB AUTO_INCREMENT=123 DEFAULT CHARSET=utf8;  
  
-- ----------------------------  
-- Records of rule_tree_node  
-- ----------------------------  
BEGIN;  
INSERT INTO `rule_tree_node` VALUES (1, 2110081902, 1, NULL, 'userGender', 'ç”¨æˆ·æ€§åˆ«[ç”·/å¥³]');  
INSERT INTO `rule_tree_node` VALUES (11, 2110081902, 1, NULL, 'userAge', 'ç”¨æˆ·å¹´é¾„');  
INSERT INTO `rule_tree_node` VALUES (12, 2110081902, 1, NULL, 'userAge', 'ç”¨æˆ·å¹´é¾„');  
INSERT INTO `rule_tree_node` VALUES (111, 2110081902, 2, '100001', NULL, NULL);  
INSERT INTO `rule_tree_node` VALUES (112, 2110081902, 2, '100002', NULL, NULL);  
INSERT INTO `rule_tree_node` VALUES (121, 2110081902, 2, '100003', NULL, NULL);  
INSERT INTO `rule_tree_node` VALUES (122, 2110081902, 2, '100004', NULL, NULL);  
COMMIT;  
  
-- ----------------------------  
-- Table structure for rule_tree_node_line  
-- ----------------------------  
DROP TABLE IF EXISTS `rule_tree_node_line`;  
CREATE TABLE `rule_tree_node_line` (  
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',  
  `tree_id` bigint(20) DEFAULT NULL COMMENT 'è§„åˆ™æ ‘ID',  
  `node_id_from` bigint(20) DEFAULT NULL COMMENT 'èŠ‚ç‚¹From',  
  `node_id_to` bigint(20) DEFAULT NULL COMMENT 'èŠ‚ç‚¹To',  
  `rule_limit_type` int(2) DEFAULT NULL COMMENT 'é™å®šç±»å‹ï¼›1:=;2:>;3:<;4:>=;5<=;6:enum[æšä¸¾èŒƒå›´];7:æœå®',  
  `rule_limit_value` varchar(32) DEFAULT NULL COMMENT 'é™å®šå€¼',  
  PRIMARY KEY (`id`)  
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;  
  
-- ----------------------------  
-- Records of rule_tree_node_line  
-- ----------------------------  
BEGIN;  
INSERT INTO `rule_tree_node_line` VALUES (1, 2110081902, 1, 11, 1, 'man');  
INSERT INTO `rule_tree_node_line` VALUES (2, 2110081902, 1, 12, 1, 'woman');  
INSERT INTO `rule_tree_node_line` VALUES (3, 2110081902, 11, 111, 3, '25');  
INSERT INTO `rule_tree_node_line` VALUES (4, 2110081902, 11, 112, 4, '25');  
INSERT INTO `rule_tree_node_line` VALUES (5, 2110081902, 12, 121, 3, '25');  
INSERT INTO `rule_tree_node_line` VALUES (6, 2110081902, 12, 122, 4, '25');  
COMMIT;
```

## å®ç°

### å·¥ç¨‹ç»“æ„

```xml
Lottery
â””â”€â”€ src
    â””â”€â”€ main
       â””â”€â”€ java
          â””â”€â”€ cn.itedus.lottery.domain.rule
              â”œâ”€â”€ model
              â”‚   â”œâ”€â”€ aggregates
              â”‚   â”‚   â””â”€â”€ TreeRich.java
              â”‚   â”œâ”€â”€ req
              â”‚   â”‚   â””â”€â”€ DecisionMatterReq.java # 
              â”‚   â”œâ”€â”€ res
              â”‚   â”‚   â””â”€â”€ EngineResult.java
              â”‚   â””â”€â”€ vo
              â”‚       â”œâ”€â”€ TreeNodeLineVO.java
              â”‚       â”œâ”€â”€ TreeNodeVO.java
              â”‚       â””â”€â”€ TreeRootVO.java	
              â””â”€â”€ service
                  â”œâ”€â”€ engine
                  â”‚   â”œâ”€â”€ impl	
                  â”‚   â”‚   â””â”€â”€ TreeEngineHandle.java
                  â”‚   â”œâ”€â”€ EngineBase.java 
                  â”‚   â”œâ”€â”€ EngineConfig.java
                  â”‚   â””â”€â”€ IEngine.java	
                  â””â”€â”€ logic
                      â”œâ”€â”€ impl	
                      â”‚   â”œâ”€â”€ UserAgeFilter.java
                      â”‚   â””â”€â”€ UserGenderFilter.java
                      â”œâ”€â”€ BaseLogic.java
                      â””â”€â”€ LogicFilter.java
```

### ä»£ç å®ç°

#### å°è£…è§„åˆ™è¿‡æ»¤å™¨

```java
// å¹´é¾„è§„åˆ™
@Component
public class UserAgeFilter extends BaseLogic {
    @Override
    public String matterValue(DecisionMatterReq decisionMatter) {
        return decisionMatter.getValMap().get("age").toString();
    }
}

// æ€§åˆ«è§„åˆ™
@Component
public class UserGenderFilter extends BaseLogic {
    @Override
    public String matterValue(DecisionMatterReq decisionMatter) {
        return decisionMatter.getValMap().get("gender").toString();
    }
    
}
```

#### éå†è§„åˆ™è·¯å¾„è·å–æœå®èŠ‚ç‚¹

* è¿™é‡Œä¸»è¦æä¾›å†³ç­–æ ‘æµç¨‹çš„å¤„ç†è¿‡ç¨‹ï¼Œæœ‰ç‚¹åƒé€šè¿‡é“¾è·¯çš„å…³ç³»(æ€§åˆ«ã€å¹´é¾„)åœ¨äºŒå‰æ ‘ä¸­å¯»æ‰¾æœå®èŠ‚ç‚¹çš„è¿‡ç¨‹ã€‚
* åŒæ—¶æä¾›ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰§è¡Œå†³ç­–æµç¨‹çš„æ–¹æ³•ä¾›å¤–éƒ¨å»åšå…·ä½“çš„å®ç°ã€‚

```java
public class EngineBase extends EngineConfig implements EngineFilter {

    private Logger logger = LoggerFactory.getLogger(EngineBase.class);

    @Override
    public EngineResult process(DecisionMatterReq matter) {
        throw new RuntimeException("æœªå®ç°è§„åˆ™å¼•æ“æœåŠ¡");
    }

    protected TreeNodeVO engineDecisionMaker(TreeRuleRich treeRuleRich, DecisionMatterReq matter) {
        TreeRootVO treeRoot = treeRuleRich.getTreeRoot();
        Map<Long, TreeNodeVO> treeNodeMap = treeRuleRich.getTreeNodeMap();

        // è§„åˆ™æ ‘æ ¹ID
        Long rootNodeId = treeRoot.getTreeRootNodeId();
        TreeNodeVO treeNodeInfo = treeNodeMap.get(rootNodeId);

        // èŠ‚ç‚¹ç±»å‹[NodeType]ï¼›1å­å¶ã€2æœå®
        while (Constants.NodeType.STEM.equals(treeNodeInfo.getNodeType())) {
            String ruleKey = treeNodeInfo.getRuleKey();
            LogicFilter logicFilter = logicFilterMap.get(ruleKey);
            String matterValue = logicFilter.matterValue(matter);
            Long nextNode = logicFilter.filter(matterValue, treeNodeInfo.getTreeNodeLineInfoList());
            treeNodeInfo = treeNodeMap.get(nextNode);
            logger.info("å†³ç­–æ ‘å¼•æ“=>{} userIdï¼š{} treeIdï¼š{} treeNodeï¼š{} ruleKeyï¼š{} matterValueï¼š{}", treeRoot.getTreeName(), matter.getUserId(), matter.getTreeId(), treeNodeInfo.getTreeNodeId(), ruleKey, matterValue);
        }

        return treeNodeInfo;
    }

}
```

éå†è¿‡ç¨‹ï¼š

![[Pasted image 20241014173544.png]]
#### è§„åˆ™è¿‡æ»¤å™¨åŸºç¡€æŠ½è±¡ç±»

* åœ¨æŠ½è±¡æ–¹æ³•ä¸­å®ç°äº†æ¥å£æ–¹æ³•ï¼ŒåŒæ—¶å®šä¹‰äº†åŸºæœ¬çš„å†³ç­–æ–¹æ³•ï¼›`1ã€2ã€3ã€4ã€5`ï¼Œ`ç­‰äºã€å°äºã€å¤§äºã€å°äºç­‰äºã€å¤§äºç­‰äº`çš„åˆ¤æ–­é€»è¾‘ã€‚
- åŒæ—¶å®šä¹‰äº†æŠ½è±¡æ–¹æ³•ï¼Œè®©æ¯ä¸€ä¸ªå®ç°æ¥å£çš„ç±»éƒ½å¿…é¡»æŒ‰ç…§è§„åˆ™æä¾›`å†³ç­–å€¼`ï¼Œè¿™ä¸ªå†³ç­–å€¼ç”¨äºåšé€»è¾‘æ¯”å¯¹ã€‚
 
```java
public abstract class BaseLogic implements LogicFilter {
    @Override
    public Long filter(String matterValue, List<TreeNodeLineVO> treeNodeLineInfoList) {
        for (TreeNodeLineVO nodeLine : treeNodeLineInfoList) {
            if (decisionLogic(matterValue, nodeLine)) {
                return nodeLine.getNodeIdTo();
            }
        }
        return Constants.Global.TREE_NULL_NODE;
    }
    /**
     * è·å–è§„åˆ™æ¯”å¯¹å€¼
     * @param decisionMatter è§„åˆ™æ¯”è¾ƒåˆ¤æ–­å€¼ã€‚åœ¨æœ¬ä¾‹ä¸­ä¸ºæ€§åˆ«ã€å¹´é¾„ä¿¡æ¯ã€‚
     * @return æ¯”å¯¹å€¼
     */
    @Override
    public abstract String matterValue(DecisionMatterReq decisionMatter);
    private boolean decisionLogic(String matterValue, TreeNodeLineVO nodeLine) {
        switch (nodeLine.getRuleLimitType()) {
            case Constants.RuleLimitType.EQUAL:
                return matterValue.equals(nodeLine.getRuleLimitValue());
            case Constants.RuleLimitType.GT:
                return Double.parseDouble(matterValue) > Double.parseDouble(nodeLine.getRuleLimitValue());
            case Constants.RuleLimitType.LT:
                return Double.parseDouble(matterValue) < Double.parseDouble(nodeLine.getRuleLimitValue());
            case Constants.RuleLimitType.GE:
                return Double.parseDouble(matterValue) >= Double.parseDouble(nodeLine.getRuleLimitValue());
            case Constants.RuleLimitType.LE:
                return Double.parseDouble(matterValue) <= Double.parseDouble(nodeLine.getRuleLimitValue());
            default:
                return false;
        }
    }
}
```


![[Pasted image 20241014171547.png]]

## æµ‹è¯•ç»“æœ

```java
@Resource
    private EngineFilter engineFilter;
    @Test
    public void test_process() {
        DecisionMatterReq req = new DecisionMatterReq();
        req.setTreeId(2110081902L);
        req.setUserId("lily");
        req.setValMap(new HashMap<String, Object>() {{
            put("gender", "man");
            put("age", "25");
        }});
        EngineResult res = engineFilter.process(req);
        logger.info("è¯·æ±‚å‚æ•°ï¼š{}", JSON.toJSONString(req));
        logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(res));
    }
```

è¾“å‡º
```java
c.i.lottery.test.domain.ActivityTest     : è¯·æ±‚å‚æ•°ï¼š{"treeId":2110081902,"userId":"lily","valMap":{"gender":"man","age":"25"}}
09:30:59.355  INFO 53959 --- [           main] c.i.lottery.test.domain.ActivityTest     : æµ‹è¯•ç»“æœï¼š{"nodeId":112,"nodeValue":"100002","success":true,"treeId":2110081902,"userId":"lily"}
```
é€šè¿‡æµ‹è¯•ç»“æœæ‰¾åˆ° `"nodeValue":"100002"` è¿™ä¸ª 100002 å°±æ˜¯ç”¨æˆ· `fustack` å¯ä»¥å‚ä¸çš„æ´»åŠ¨å·ã€‚

## æ€è€ƒé¢˜

**è§„åˆ™å¼•æ“çš„è®¾è®¡ç›®çš„ï¼Œæ ¹æ®ä»€ä¹ˆæ¥ç­›é€‰ï¼Ÿ**
1. ç›®æ ‡ç²¾å‡†æ€§ï¼šæŸäº›æ´»åŠ¨ä¸­ï¼Œç»„ç»‡è€…å¯èƒ½å¸Œæœ›æŠ½å¥–é’ˆå¯¹ç‰¹å®šçš„äººç¾¤ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œè¿‡æ»¤ä¸€ã€‚
2. å¤šæ´»åŠ¨ç®¡ç†ï¼šå¦‚æœå¤šä¸ªæŠ½å¥–æ´»åŠ¨åŒæ—¶è¿›è¡Œï¼Œä¸åŒçš„æ´»åŠ¨å¯èƒ½æœ‰ä¸åŒçš„ç›®æ ‡å’Œäººç¾¤ã€‚
3. åŠ¨æ€è§„åˆ™æ›´æ”¹ï¼šå¯ä»¥æ–¹ä¾¿çš„æ›´æ”¹ç­›é€‰æ¡ä»¶è§„åˆ™è€Œä¸æ˜¯åµŒå¥—ä½¿ç”¨if elseï¼Œæ— éœ€æ›´æ”¹æ•´ä¸ªæŠ½å¥–ç³»ç»Ÿã€‚

å®ç°æ–¹å¼ï¼šå¼•æ“è§„åˆ™æ˜¯ä¸€ä¸ªå†³ç­–æ ‘åˆ¤æ–­ï¼Œå®šä¹‰ä¸€ä¸ªè¿‡æ»¤çš„æ¥å£ï¼ŒæŠ½è±¡ç±»å°è£…ä¸€ä¸ªæ¯”å¯¹æ¥å£ï¼Œå…·ä½“ç±»è¿”å›å†³ç­–keyå¯¹åº”çš„å€¼ï¼Œæ¯”å¦‚æ€§åˆ«â€œå¥³â€ï¼Œå¹´é¾„23è¿™æ ·å­ï¼Œäº¤ç»™æŠ½è±¡ç±»å»æ¯”å¯¹ã€‚
å¯ä»¥æ ¹æ®åˆ¶å®šçš„è§„åˆ™æŠŠèŠ‚ç‚¹çš„filteré€»è¾‘å°è£…åˆ°mapä¸­å¾—åˆ°æ ‘çš„ä¿¡æ¯ï¼Œç„¶åéå†ï¼Œæ‹¿å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„keyæ¯”å¦‚genderï¼Œå¾—åˆ°å…·ä½“å€¼è¿›è¡Œæ¯”å¯¹ï¼Œå¾—åˆ°ä¸‹ä¸€ä¸ªnodeï¼Œå†ä»mapä¸­è¿›è¡Œå–å€¼ä¾æ¬¡éå†ã€‚
æ€§åˆ«ã€å¹´é¾„ã€æ¶ˆè´¹æƒ…å†µã€èº«ä»½ã€æœç´¢ã€ç‚¹å‡»ç­‰ã€‚

**è§„åˆ™éƒ½æ˜¯æ—¢å®šçš„ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨å†³ç­–æ ‘ï¼Ÿå†³ç­–æ ‘å’Œå¸ƒå°”æ£€ç´¢æœ‰åŒºåˆ«å—ï¼Ÿ**

ç­”ï¼šè§„åˆ™æ˜¯æ—¢å®šçš„ï¼Œå†³ç­–æ ‘å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç»„åˆè¿™äº›è§„åˆ™ï¼Œæ˜¯çš„åœ¨ç¡®å®šåœºæ™¯ä¸‹ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„è¾“å…¥æ¡ä»¶æ‰§è¡Œä¸åŒçš„è·¯å¾„ï¼Œå¸ƒå°”æ£€ç´¢ä¸»è¦æ˜¯ä¸€ç§æ£€ç´¢æŠ€æœ¯ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ã€‚
# MQè§£è€¦å‘å¥–æµç¨‹

![[Pasted image 20241013185018.png]]



## ä¸šåŠ¡æµç¨‹

ä»£ç å±‚é¢ï¼š
- åœ¨æ•°æ®åº“è¡¨ `user_strategy_export` æ·»åŠ å­—æ®µ `mq_state` è¿™ä¸ªå­—æ®µç”¨äºè®°å½• MQ å‘é€çŠ¶æ€ã€‚
- å¯åŠ¨ kafka æ–°å¢ topicï¼šlottery_invoice ç”¨äºå‘è´§å•æ¶ˆæ¯ï¼Œå½“æŠ½å¥–å®Œæˆååˆ™å‘é€ä¸€ä¸ªå‘è´§å•ï¼Œå†å¼‚æ­¥å¤„ç†å‘è´§æµç¨‹ï¼Œè¿™ä¸ªéƒ¨åˆ†å°±æ˜¯MQçš„è§£è€¦æµç¨‹ä½¿ç”¨ã€‚
- åœ¨ `ActivityProcessImpl#doDrawProcess` æ´»åŠ¨æŠ½å¥–æµç¨‹ç¼–æ’ä¸­è¡¥å…¨ç”¨æˆ·æŠ½å¥–åï¼Œå‘é€MQè§¦è¾¾å¼‚æ­¥å¥–å“å‘é€çš„æµç¨‹ã€‚

ä¸šåŠ¡é€»è¾‘å±‚é¢ï¼š

MQç”¨äºè§£è€¦æŠ½å¥–ç»“æœè½åº“ä¸å‘è´§ç³»ç»Ÿï¼Œå½“è·å¾—æŠ½å¥–ç»“æœä¹‹åï¼Œæˆ‘ä»¬**å°†è·å¥–è®°å½•å­˜å…¥ç”¨æˆ·æŠ½å¥–ç»“æœè¡¨ä¸­**ï¼Œæ¥ç€å‘é€MQæ¶ˆæ¯è¿›è¡Œå®é™…å¥–å“å‘è´§çš„å¼‚æ­¥å¤„ç†ã€‚

æŠ½å¥–ç»“æœäº§ç”Ÿåï¼Œè¦è¿›è¡Œå¥–å“å‘è´§çš„æµç¨‹ï¼Œå…¶ä¸­æ¶‰åŠåˆ°è°ƒç”¨**å‘è´§æœåŠ¡ã€åº“å­˜æ‰£å‡ã€æ›´æ–°åº“è¡¨å‘è´§æˆåŠŸè®°å½•ã€å‘è´§å¤±è´¥é‡è¯•MQæ¶ˆæ¯é‡è¯•**ï¼ˆé‡è¯•æœºåˆ¶è€—æ—¶ï¼‰ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œä½¿ç”¨MQè§£è€¦æ¶ˆæ¯å¯ä»¥ä½¿å¾—ç«‹é©¬è·çŸ¥æŠ½å¥–ç»“æœè€Œä¸è¢«è¿™ä¸€ç³»åˆ—çš„åç»­æ“ä½œæ‰€å½±å“ã€‚

ä¸šåŠ¡æµç¨‹å›¾
![[Pasted image 20241013185018.png]]



## æ¥å£å¹‚ç­‰æ€§(?
é¡¹ç›®ä¸­çš„æ¥å£å¦‚ä½•å¹‚ç­‰å®ç°ï¼Ÿ
ç­”ï¼šç¨‹åºä¸­æ¥å£çš„å¹‚ç­‰æ€§ï¼Œæ˜¯åŸºäºæ•°æ®é˜²é‡å­—æ®µå®ç°çš„ï¼Œæ¯”å¦‚UUIDå”¯ä¸€ç´¢å¼•ï¼Œåœ¨æ’å…¥æ—¶ä¼šæŠ›å¼‚å¸¸ï¼Œä¸€èˆ¬ä¼šåŠ å…¥æŸ¥è¯¢ã€æ•°æ®åº“ç¼“å­˜çš„æ–¹å¼å‡å°‘å¯¹æ•°æ®åº“çš„å†™æ“ä½œã€‚

## æ¶ˆæ¯å¹‚ç­‰æ€§ä¿è¯

1. åº“è¡¨ä¸­**è®°å½•MQæ¶ˆæ¯å‘é€çŠ¶æ€**ï¼šæ¶ˆè´¹è€…å‘é€æ¶ˆæ¯æˆåŠŸä¸å¦éœ€è¦è®°å½•åœ¨åº“è¡¨stateå­—æ®µä¸­ã€‚
2. **å®šæ—¶ä»»åŠ¡ç¡®ä¿æ¶ˆæ¯å‘é€**ï¼šä½¿ç”¨å®šæ—¶ä»»åŠ¡æ‰«æå‘é€å¤±è´¥ä»»åŠ¡ï¼Œç¡®ä¿MQæ¶ˆæ¯å‘é€æˆåŠŸã€‚
3. **Kafkaé‡è¯•æœºåˆ¶**ï¼šMQæ¶ˆæ¯é‡è¯•æœºåˆ¶ä¿è¯æ¶ˆè´¹æ¶ˆæ¯å¯é æ€§ã€‚

ä¿è¯ MQ æ¶ˆæ¯é‡è¯•çš„å‰æå°±æ˜¯æœåŠ¡çš„å¹‚ç­‰æ€§ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæŠ½å¥–ç»“æœåªä¼šå¯¹åº”ä¸€æ¬¡å‘è´§æµç¨‹ã€‚å¦‚æœæ²¡æœ‰å¹‚ç­‰æ€§ä¿éšœï¼Œåœ¨é‡è¯•çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé€ æˆæµç¨‹å¼‚å¸¸ï¼Œæ¯”å¦‚çŠ¶æ€æ›´æ–°æ¬¡æ•°å¤šäº†ã€æ•°æ®åº“æ’å…¥å¤šäº†ã€ç»™ç”¨æˆ·å‘å¥–å¤šäº†ç­‰ç­‰ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šå‘ç”Ÿèµ„æŸé—®é¢˜ã€‚

åœ¨å‘é€ MQ æ—¶å¯èƒ½ä¼šå¤±è´¥ï¼Œä¸ç®¡æˆåŠŸç‡å¤šé«˜æˆ‘ä»¬éƒ½éœ€è¦è€ƒè™‘å¤±è´¥çš„æƒ…å†µã€‚æ‰€ä»¥æˆ‘ä»¬è¦æ›´æ–°åº“è¡¨çŠ¶æ€è®°å½•**MQæ¶ˆè´¹å‘é€æˆåŠŸä¸å¦**ï¼Œå¦‚æœå‘é€å¤±è´¥åˆ™éœ€è¦ä½¿ç”¨ å®šæ—¶ä»»åŠ¡worker æ¥è¡¥å¿ MQ å‘é€ã€‚

æ‰€ä»¥MQ å‘é€å®Œæˆåˆ°æ¶ˆè´¹ï¼Œä¹Ÿæ˜¯å¯èƒ½æœ‰å¤±è´¥çš„ï¼Œæ¯”å¦‚å¤„ç†å¤±è´¥ã€æ›´æ–°åº“è¡¨å¤±è´¥ç­‰ï¼Œä½†æ— è®ºæ˜¯ä»€ä¹ˆå¤±è´¥éƒ½éœ€è¦ä¿è¯ MQ è¿›è¡Œé‡è¯•å¤„ç†ã€‚

### å›è°ƒå‡½æ•°

```java
// 5. å‘é€MQï¼Œè§¦å‘å‘å¥–æµç¨‹  
InvoiceVO invoiceVO = buildInvoiceVO(drawOrderVO);  
ListenableFuture<SendResult<String, Object>> future = kafkaProducer.sendLotteryInvoice(invoiceVO);  
future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {  
  
    @Override  
    public void onSuccess(SendResult<String, Object> stringObjectSendResult) {  
        // 4.1 MQ æ¶ˆæ¯å‘é€å®Œæˆï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 1        activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.COMPLETE.getCode());  
    }  
  
    @Override  
    public void onFailure(Throwable throwable) {  
        // 4.2 MQ æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 2 ã€ç­‰å¾…å®šæ—¶ä»»åŠ¡æ‰«ç è¡¥å¿MQæ¶ˆæ¯ã€‘  
        activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.FAIL.getCode());  
    }  
  
});
```
## æœ€ç»ˆä¸€è‡´æ€§ä¿è¯

## æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹

å‚è€ƒæ–‡ç« ï¼š
1. [æ¶ˆæ¯é˜Ÿåˆ—åœºæ™¯æ€§èƒ½å¯¹æ¯”](https://cloud.tencent.com/developer/article/2241083)
2. [æ¶æ„å¯¹æ¯”](https://www.51cto.com/article/774611.html)

* RocketMQä¸€èˆ¬é€‚ç”¨äºæ¶ˆæ¯å¯é æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œä¾‹å¦‚é‡‘èæ¶ˆè´¹ç³»ç»Ÿ
* Kafkaé€‚ç”¨äºååé‡é«˜ï¼Œå¤§æ•°æ®å¤„ç†å’Œæµå¼å¤„ç†çš„åœºæ™¯ã€‚é€šè¿‡é«˜æ•ˆçš„åˆ†åŒºå’Œå‰¯æœ¬æœºåˆ¶ä¿è¯äº†é«˜å¯ç”¨å’Œæ•°æ®ä¸€è‡´æ€§ã€‚æ˜¯å¤§æ•°æ®å¤„ç†åœºæ™¯ä¸‹çš„ä¼˜é€‰æ¶ˆæ¯é˜Ÿåˆ—

ä¸ºä»€ä¹ˆä¸»é¡¹ç›®ä½¿ç”¨çš„æ˜¯RocketMQï¼ŒæŠ½å¥–æ¨¡å—ä½¿ç”¨kafkaå‘¢ï¼Ÿ

é¦–å…ˆåœ¨è¿™æ ·çš„é«˜å¹¶å‘åœºæ™¯é€‰ç”¨Kafkaæ˜¯å¾ˆåˆé€‚çš„ï¼Œï¼ˆè°ˆè®ºäºŒè€…æ¶æ„ä¸Šçš„ä¼˜åŠ¿å’ŒåŒºåˆ«ã€è¯¦è§RocketMQå’ŒKafkaæ¶æ„åŒºåˆ«çš„æ–‡ç« ã€‘ï¼‰ï¼Œæˆ‘å¸Œæœ›è¿™ä¸ªæŠ½å¥–æ¨¡å—å¯ä»¥ä»ä¸»é¡¹ç›®ä¸­è„±ç¦»å‡ºæ¥æˆä¸ºä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œä¸”å®Œå–„çš„ç‹¬ç«‹æœåŠ¡ï¼Œå› ä¸ºå¾ˆå¤šè¥é”€åœºæ™¯ä¸‹éƒ½éœ€è¦ç±»ä¼¼æŠ½å¥–çš„åŠŸèƒ½ï¼Œ**æ‰€ä»¥è¿™ä¸ªæŠ½å¥–ç³»ç»Ÿè®¾è®¡ä¹‹åˆå°±æ˜¯å¸Œæœ›å¯ä»¥ç»™å¤šæ–¹è¥é”€ç³»ç»Ÿæä¾›ç›´æ¥å°è£…å¥½çš„æŠ½å¥–æœåŠ¡**ï¼Œæ¯”å¦‚è¯´åœ¨ä¹‹å‰è¿‡å¹´çš„æ—¶å€™æ”¯ä»˜å®æä¾›çš„ä¸€ä¸ªå…¨æ°‘é›†ç¦ä¹‹åå‚ä¸çš„æŠ½å¥–ç“œåˆ†å¥–é‡‘çš„æ´»åŠ¨ï¼Œè¿™æ ·çš„åœºæ™¯ä¸‹å¦‚æœä½¿ç”¨kafkaä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯å¾ˆåˆé€‚çš„ï¼Œå…¶æ¬¡æ˜¯ç”±äºä¹‹å‰å­¦ä¹ è¿‡äº†RocketMQï¼Œæ‰€ä»¥ç°åœ¨ä¸»è¦æ˜¯ä¸ºäº†å­¦ä¹ è€Œå»æ¥è§¦å’Œä½¿ç”¨ã€‚

## æ€è€ƒé¢˜

ä¸ºä»€ä¹ˆä½¿ç”¨å¡å¤«å¡ï¼Œæ€ä¹ˆé…ç½®å¡å¤«å¡ï¼Œæ¶ˆæ¯ä¸¢å¤±æ€ä¹ˆåŠï¼Œæ¶ˆè´¹å¤±è´¥æ€ä¹ˆåŠï¼š
ä¸ºä»€ä¹ˆï¼šé«˜ååé‡ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½ç”Ÿäº§å’Œæ¶ˆè´¹åœºæ™¯ï¼›æŒä¹…æ€§ï¼Œå¯ä»¥ä¿æŒå¤§é‡æ•°æ®ï¼›å¯ä»¥å®æ—¶å¤„ç†æ•°æ®æµã€‚

é¦–å…ˆè¦åœ¨pomæ–‡ä»¶é‡Œå¼•å…¥å¡å¤«å¡çš„ä¾èµ–ï¼Œymlä¸­é…ç½®ç›‘å¬è€…æ¶ˆè´¹è€…çš„å±æ€§ï¼Œæ¯”å¦‚ç«¯å£å·ã€é”™è¯¯é‡è¯•æ¬¡æ•°ã€åºåˆ—åŒ–æ–¹å¼ã€ä»¥åŠç›‘å¬çš„çº¿ç¨‹æ•°ç­‰ã€‚å¯åŠ¨zookeeperæœåŠ¡å™¨å’Œå¡å¤«å¡æœåŠ¡å™¨ã€‚

æ€ä¹ˆåŠï¼šé‡è¯•ç­–ç•¥ï¼Œè®¾ç½®é‡è¯•æ¬¡æ•°å’Œæ—¶é—´é—´éš”ï¼›å°†ä¸èƒ½å‘é€çš„æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ï¼›å½“å‘é€å¤±è´¥æ¬¡æ•°è¾¾åˆ°ä¸€å®šé˜ˆå€¼æ—¶ï¼Œå¯åŠ¨æŠ¥è­¦æœºåˆ¶ã€‚

æ€ä¹ˆåŠï¼šé‡è¯•æœºåˆ¶ï¼Œå¦‚æœå¤šæ¬¡æ— æ³•æ¶ˆè´¹ï¼Œæ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚æŠ¥è­¦æœºåˆ¶ã€‚

xxl-jobæ˜¯å¹²å•¥çš„ï¼Ÿä¸ºä»€ä¹ˆé€‰æ‹©xxl-jobæ‰§è¡Œå®šæ—¶ä»»åŠ¡
XXL-JOBæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œå®šæ—¶æ‰«æä¸Šçº¿çš„ä»»åŠ¡è¿›è¡Œè°ƒåº¦ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…æ‰§è¡ŒæŸäº›æ“ä½œã€‚ä½¿ä»»åŠ¡çš„ç›‘æ§å’Œç®¡ç†å˜å¾—ç®€å•æ˜äº†ã€‚

xxl-jobåœ¨æŠ½å¥–ç³»ç»Ÿä¸­ä¸»è¦å¯ä»¥æ‰«ææ—¥å¿—æˆ–æ•°æ®åº“ä¸­æ˜¯å¦æœ‰MQæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œå¹¶ä¸”å®šæ—¶æ§åˆ¶æ´»åŠ¨çŠ¶æ€çš„å˜æ›´ã€‚

å…·ä½“æ€ä¹ˆå®ç°ï¼šé¦–å…ˆåº”è¯¥è¦æœ‰æ—¥å¿—è®°å½•ï¼Œæ“ä½œå¤±è´¥æ—¶ä¼šæœ‰æ—¥å¿—è®°å½•ä¸‹æ¥ã€‚ä½¿ç”¨xxl-jobè®¾å®šä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚éš”ä¸€æ®µæ—¶é—´å°±æ‰«ææŸ¥æ‰¾å¤±è´¥çš„ä»»åŠ¡ï¼Œæ ¹æ®ä¸šåŠ¡åˆ¤æ–­ç»“æœæ‰§è¡Œå®é™…çš„è¡¥å¿ï¼Œå¯èƒ½æ˜¯é‡æ–°æ‰§è¡Œä¸€ä¸ªæ•°æ®åº“æ“ä½œã€å‘é€ä¸€ä¸ªMQæ¶ˆæ¯ç­‰ã€‚è¡¥å¿çš„ç»“æœä¹Ÿè¦è®°å½•ã€‚


# XXL-Jobçš„ä½¿ç”¨

```java

@Component  
public class LotteryXxlJob {  
  
    private Logger logger = LoggerFactory.getLogger(LotteryXxlJob.class);  
  
    @Resource  
    private IActivityDeploy activityDeploy;  
  
    @Resource  
    private IActivityPartake activityPartake;  
  
    @Resource  
    private IStateHandler stateHandler;  
  
    @Resource  
    private IDBRouterStrategy dbRouter;  
  
  
    @Resource  
    private KafkaProducer kafkaProducer;  
  
    @XxlJob("lotteryActivityStateJobHandler")  
    public void lotteryActivityStateJobHandler() throws Exception {  
        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ Begin");  
  
        List<ActivityVO> activityVOList = activityDeploy.scanToDoActivityList(0L);  
        if (activityVOList.isEmpty()) {  
            logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ End æš‚æ— ç¬¦åˆéœ€è¦æ‰«æçš„æ´»åŠ¨åˆ—è¡¨");  
            return;  
        }  
  
        while (!activityVOList.isEmpty()) {  
            for (ActivityVO activityVO : activityVOList) {  
                Integer state = activityVO.getState();  
                switch (state) {  
                    // æ´»åŠ¨çŠ¶æ€ä¸ºå®¡æ ¸é€šè¿‡ï¼Œåœ¨ä¸´è¿‘æ´»åŠ¨å¼€å¯æ—¶é—´å‰ï¼Œå®¡æ ¸æ´»åŠ¨ä¸ºæ´»åŠ¨ä¸­ã€‚åœ¨ä½¿ç”¨æ´»åŠ¨çš„æ—¶å€™ï¼Œéœ€è¦ä¾ç…§æ´»åŠ¨çŠ¶æ€æ ¸æ—¶é—´ä¸¤ä¸ªå­—æ®µè¿›è¡Œåˆ¤æ–­å’Œä½¿ç”¨ã€‚  
                    case 4:  
                        Result state4Result = stateHandler.doing(activityVO.getActivityId(), Constants.ActivityState.PASS);  
                        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ä¸ºæ´»åŠ¨ä¸­ ç»“æœï¼š{} activityIdï¼š{} activityNameï¼š{} creatorï¼š{}", JSON.toJSONString(state4Result), activityVO.getActivityId(), activityVO.getActivityName(), activityVO.getCreator());  
                        break;  
                    // æ‰«ææ—¶é—´å·²è¿‡æœŸçš„æ´»åŠ¨ï¼Œä»æ´»åŠ¨ä¸­çŠ¶æ€å˜æ›´ä¸ºå…³é—­çŠ¶æ€ã€è¿™é‡Œä¹Ÿå¯ä»¥ç»†åŒ–ä¸º2ä¸ªä»»åŠ¡æ¥å¤„ç†ï¼Œä¹Ÿå¯ä»¥æŠŠæ—¶é—´åˆ¤æ–­æ”¾åˆ°æ•°æ®åº“ä¸­æ“ä½œã€‘  
                    case 5:  
                        if (activityVO.getEndDateTime().before(new Date())) {  
                            Result state5Result = stateHandler.close(activityVO.getActivityId(), Constants.ActivityState.DOING);  
                            logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ä¸ºå…³é—­ ç»“æœï¼š{} activityIdï¼š{} activityNameï¼š{} creatorï¼š{}", JSON.toJSONString(state5Result), activityVO.getActivityId(), activityVO.getActivityName(), activityVO.getCreator());  
                        }  
                        break;  
                    default:  
                        break;  
                }  
            }  
  
            // è·å–é›†åˆä¸­æœ€åä¸€æ¡è®°å½•ï¼Œç»§ç»­æ‰«æåé¢10æ¡è®°å½•  
            ActivityVO activityVO = activityVOList.get(activityVOList.size() - 1);  
            activityVOList = activityDeploy.scanToDoActivityList(activityVO.getId());  
        }  
  
        logger.info("æ‰«ææ´»åŠ¨çŠ¶æ€ End");  
  
    }  
  
    @XxlJob("lotteryOrderMQStateJobHandler")  
    public void lotteryOrderMQStateJobHandler() throws Exception {  
        // éªŒè¯å‚æ•°  
        String jobParam = XxlJobHelper.getJobParam();  
        if (null == jobParam) {  
            logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] é”™è¯¯ params is null");  
            return;  
        }  
  
        // è·å–åˆ†å¸ƒå¼ä»»åŠ¡é…ç½®å‚æ•°ä¿¡æ¯ å‚æ•°é…ç½®æ ¼å¼ï¼š1,2,3 ä¹Ÿå¯ä»¥æ˜¯æŒ‡å®šæ‰«æä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥é…ç½®å¤šä¸ªåº“ï¼ŒæŒ‰ç…§éƒ¨ç½²çš„ä»»åŠ¡é›†ç¾¤è¿›è¡Œæ•°é‡é…ç½®ï¼Œå‡æ‘Šåˆ†åˆ«æ‰«ææ•ˆç‡æ›´é«˜  
        String[] params = jobParam.split(",");  
        logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] å¼€å§‹ paramsï¼š{}", JSON.toJSONString(params));  
  
        if (params.length == 0) {  
            logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] ç»“æŸ params is null");  
            return;  
        }  
  
        // è·å–åˆ†åº“åˆ†è¡¨é…ç½®ä¸‹çš„åˆ†è¡¨æ•°  
        int tbCount = dbRouter.tbCount();  
  
        // å¾ªç¯è·å–æŒ‡å®šæ‰«æåº“  
        for (String param : params) {  
            // è·å–å½“å‰ä»»åŠ¡æ‰«æçš„æŒ‡å®šåˆ†åº“  
            int dbCount = Integer.parseInt(param);  
  
            // åˆ¤æ–­é…ç½®æŒ‡å®šæ‰«æåº“æ•°ï¼Œæ˜¯å¦å­˜åœ¨  
            if (dbCount > dbRouter.dbCount()) {  
                logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] ç»“æŸ dbCount not exist");  
                continue;  
            }  
  
            // å¾ªç¯æ‰«æå¯¹åº”è¡¨  
            for (int i = 0; i < tbCount; i++) {  
  
                // æ‰«æåº“è¡¨æ•°æ®  
                List<InvoiceVO> invoiceVOList = activityPartake.scanInvoiceMqState(dbCount, i);  
                logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] æ‰«æåº“ï¼š{} æ‰«æè¡¨ï¼š{} æ‰«ææ•°ï¼š{}", dbCount, i, invoiceVOList.size());  
  
                // è¡¥å¿ MQ æ¶ˆæ¯  
                for (InvoiceVO invoiceVO : invoiceVOList) {  
  
                    ListenableFuture<SendResult<String, Object>> future = kafkaProducer.sendLotteryInvoice(invoiceVO);  
                    future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {  
  
                        @Override  
                        public void onSuccess(SendResult<String, Object> stringObjectSendResult) {  
                            // MQ æ¶ˆæ¯å‘é€å®Œæˆï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 1                            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.COMPLETE.getCode());  
                        }  
  
                        @Override  
                        public void onFailure(Throwable throwable) {  
                            // MQ æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ›´æ–°æ•°æ®åº“è¡¨ user_strategy_export.mq_state = 2 ã€ç­‰å¾…å®šæ—¶ä»»åŠ¡æ‰«ç è¡¥å¿MQæ¶ˆæ¯ã€‘  
                            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.FAIL.getCode());  
                        }  
  
                    });  
                }  
            }  
  
        }  
  
        logger.info("æ‰«æç”¨æˆ·æŠ½å¥–å¥–å“å‘æ”¾MQçŠ¶æ€[Table = 2*4] å®Œæˆ paramï¼š{}", JSON.toJSONString(params));  
  
    }  
  
}
```
# ä¸è¶…ä¹°è®¾è®¡



**é¦–å…ˆå¯¹äºåº“å­˜é›†ä¸­æ‰£å‡ç±»çš„ä¸šåŠ¡æµç¨‹ï¼Œæ˜¯ä¸èƒ½ç›´æ¥ç”¨æ•°æ®åº“è¡¨æŠ—çš„ã€‚**

æ¯”å¦‚æ•°æ®åº“è¡¨æœ‰ä¸€æ¡è®°å½•æ˜¯åº“å­˜ï¼Œå¦‚æœæ˜¯é€šè¿‡é”è¿™ä¸€æ¡è¡¨è®°å½•æ›´æ–°åº“å­˜ä¸º10ã€9ã€8çš„è¯ï¼Œå°±ä¼šå‡ºç°å¤§é‡çš„ç”¨æˆ·åœ¨åº”ç”¨ç”¨è·å¾—æ•°æ®åº“çš„è¿æ¥åï¼Œç­‰å¾…å‰ä¸€ä¸ªç”¨æˆ·æ›´æ–°å®Œåº“è¡¨è®°å½•åé‡Šæ”¾é”ï¼Œè®©ä¸‹ä¸€ä¸ªç”¨æˆ·è¿›å…¥åœ¨æ‰£å‡ã€‚

è¿™æ ·éšç€ç”¨æˆ·å‚ä¸é‡çš„å¢åŠ ï¼Œå°±ä¼šæœ‰éå¸¸å¤šçš„ç”¨æˆ·å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œç­‰å¾…çš„ç”¨æˆ·æ˜¯æŒä¹…æ•°æ®åº“çš„è¿æ¥çš„ï¼Œè¿™ä¸ªè¿æ¥èµ„æºéå¸¸å®è´µï¼Œä½ å ç”¨äº†åº”ç”¨ä¸­å…¶ä»–çš„è¯·æ±‚å°±è¿›ä¸æ¥ï¼Œæœ€ç»ˆå¯¼è‡´ä¸€ä¸ªè¯·æ±‚è¦å‡ åˆ†é’Ÿæ‰èƒ½å¾—åˆ°å“åº”ã€‚ã€å‰å°çš„ç”¨æˆ·è¶Šç€æ€¥ï¼Œè¶Šç–¯ç‹‚ç‚¹å‡»ï¼Œç›´è‡³è¶Šæ¥è¶Šå¡åˆ°å´©æºƒã€‘

æ‰€ä»¥ï¼Œå¯¹äºè¿™æ ·çš„**ç§’æ€åœºæ™¯**ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ redis ç¼“å­˜æ¥å¤„ç†åº“å­˜ï¼Œå®ƒåªè¦ä¸è¶…å–å°±å¯ä»¥ã€‚ä½†ä¹Ÿç¡®ä¿ä¸€ç‚¹ï¼Œä¸è¦ç”¨ä¸€æ¡keyåŠ é”å’Œç­‰å¾…é‡Šæ”¾çš„æ–¹å¼æ¥å¤„ç†ï¼Œè¿™æ ·çš„æ•ˆç‡ä¾ç„¶æ˜¯å¾ˆä½çš„ã€‚æ‰€ä»¥æˆ‘ä»¬**è¦å°½å¯èƒ½çš„è€ƒè™‘åˆ†æ‘Šç«äº‰ï¼Œè¾¾åˆ°æ— é”åŒ–æ‰æ˜¯åˆ†å¸ƒå¼æ¶æ„è®¾è®¡**çš„æ ¸å¿ƒã€‚


# å¯¹æ¥wxå…¬ä¼—å·
refï¼š
1. [å¯¹æ¥wxå…¬ä¼—å·](https://articles.zsxq.com/id_5oi7ul1i9fsx.html)

## ä¸šåŠ¡è®¾è®¡

æ­å»ºå¾®ä¿¡å…¬ä¼—å·ç½‘å…³æœåŠ¡ -- æ¶ˆæ¯å›å¤
![[Pasted image 20241030172530.png]]

## ä»£ç å®ç°

è¯¥å®ç°ä¸»è¦æ˜¯ä»¥å¾®ä¿¡å…¬ä¼—å·å¯¹è¯ä¸ºç›®æ ‡å®ç°çš„ï¼Œå…¥å£ä¾ç„¶é‡‡ç”¨äº†å°å‚…å“¥çš„ç»„ä»¶è®¾è®¡ï¼Œå…ˆæ ¹æ®æ¶ˆæ¯ç±»å‹æ¥è·å–å¯¹åº”çš„å¤„ç†æ ‘ï¼Œå†è¿›è¡Œæµç¨‹å¤„ç†ã€‚

ç±»è¯´æ˜ï¼š
1. LogicFilterï¼šæ¶ˆæ¯è¿‡æ»¤é€»è¾‘æ¥å£
	1. filterï¼šå›è¿”å›æ¶ˆæ¯å†…å®¹ï¼Œå¯ä»¥å†™å…¥è°ƒç”¨çš„å…¶ä»–é€»è¾‘ï¼Œå†è¿”å›æ¶ˆæ¯ä¿¡æ¯ã€‚
	2. getLogicLineListï¼šè¿”å›å½“å‰é€»è¾‘æ¥å£è¿æ¥çº¿ä¿¡æ¯ï¼Œè¿”å›ç©ºï¼Œåˆ™è¯´æ˜è¯¥èŠ‚ç‚¹å·²è¾¾æ¶ˆæ¯é€»è¾‘çš„å°½å¤´ï¼Œå¦åˆ™ä¸ºè¿ç»­å‹å¯¹è¯ï¼Œä¼šè°ƒç”¨ç¼“å­˜è®°å½•å½“å‰å¯¹è¯èŠ‚ç‚¹ä¿¡æ¯ã€‚
2. LogicLineï¼šæ¶ˆæ¯è¿‡æ»¤é€»è¾‘ç»„ä»¶çš„è¿æ¥å¯¹è±¡
	1. accessSignï¼šé€šå®Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦åŒ…å«çš„å¯¹è¯å†…å®¹ï¼Œä¼šé€šè¿‡ç”¨æˆ·å†…å®¹ä¸ æ­¤å¯¹è±¡è¿›è¡Œå¯¹æ¯”æ¥é€‰æ‹©æ˜¯å¦å¯ä»¥ç»§ç»­é€šå¾€æ¶ˆæ¯é€»è¾‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚
	2. nextNodeï¼šä¸‹ä¸€ä¸ª LogicFilter
3. EngineBaseï¼šæ¶ˆæ¯é€»è¾‘å¼•æ“åŸºç¡€å®ç°
	1. continueTalkï¼šæ ¹æ®ä¼ å…¥ openIdï¼ŒæŸ¥è¯¢æ˜¯å¦æœ‰è®°å½•çš„å¯¹è¯èŠ‚ç‚¹
	2. saveTalkï¼šä¿å­˜ <openId, LogicFilter>
	3. removeTalkï¼šç§»é™¤ openId
	4. routerï¼šæ²¿ç”¨ä»£ç ä¸­ router æ–¹æ³•ï¼Œæˆ‘ä¸ºä¸åŒçš„äº‹ä»¶ç±»å‹è®¾ç«‹ä¸€ç§æ ¹èŠ‚ç‚¹çš„é€»è¾‘ï¼Œç¬¬ä¸€æ­¥ä¼šè¯•å›¾æ‰¾åˆ°é€»è¾‘æ ¹èŠ‚ç‚¹ã€‚
		* å½“å‰æ ¹ LogicFilterï¼š
			* textLogicFilter
			* eventLogicFilter

å¼•æ“å®ç°æ–¹å¼ï¼š
```java


@Override

public String process(BehaviorMatter request) {

// è·å–åˆ°æ¶ˆæ¯ç±»å‹å¯¹åº”é€»è¾‘å¤„ç†ç±»

LogicFilter logicFilter = router(request);

// å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰åç»­èŠ‚ç‚¹, è¯´æ˜å•æ¬¡æ¶ˆæ¯è¿”å›å†…å®¹

if (null == logicFilter.getLogicLineList()) {

return logicFilter.filter(request);

}

// ä¸ºè¿ç»­å‹æ¶ˆæ¯èŠ‚ç‚¹

String openId = request.getOpenId();

// å°è¯•è·å–ä¸Šæ¬¡è§¦å‘è¿‡å†…å®¹çš„èŠ‚ç‚¹

LogicFilter continuedLogicFilter = continueTalk(openId);

// å¦‚æœä¸ºåˆšå¼€å§‹å¯¹è¯

if (null == continuedLogicFilter) {

// è®°å½•å½“å‰å¯¹è¯å†…å®¹

saveTalk(openId, logicFilter);

return logicFilter.filter(request);

}

// ç»§ç»­æœªå®Œæˆçš„å¯¹è¯

// å¯¹è¯åœ¨è¿›è¡Œä¸­, å°è¯•æ ¹æ®å›å¤ä¿¡æ¯æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯¹è¯æ¶ˆæ¯é€»è¾‘èŠ‚ç‚¹

List<LogicLine> logicLines = continuedLogicFilter.getLogicLineList();

LogicFilter nextNode = null;

// éå†æŸ¥è¯¢ --ã€‹ã€‹ è¿™æ®µé€»è¾‘ä¼¼ä¹è¿˜æ˜¯åº”è¯¥äº¤ç»™ LogicFilter å®ç°æ›´å¥½ï¼ï¼

for (LogicLine logicLine : logicLines) {

if (request.getContent().contains(logicLine.getAccessSign())) {

nextNode = logicLine.getNextNode();

break;

}

}

if (nextNode == null) {

return "å¯¹è¯æ¶ˆæ¯å¼•æ“æ‰§è¡Œé”™è¯¯, è¯·æŒ‰ç…§æç¤ºå†…å®¹é‡æ–°å›å¤";

}

// è·å–å½“å‰èŠ‚ç‚¹å›å¤çš„æ¶ˆæ¯

String backMsg = nextNode.filter(request);

// å¦‚æœå½“å‰å›å¤èŠ‚ç‚¹å·²æŠµè¾¾å¯¹è¯é€»è¾‘æœ«å°¾, æ¸…é™¤å¯¹è¯ç¼“å­˜ä¿¡æ¯

// å¦åˆ™è¿›è¡Œå¯¹è¯ä¿¡æ¯ä¿å­˜

if (null == nextNode.getLogicLineList()) {

removeTalk(openId);

} else {

saveTalk(openId, nextNode);

}

return backMsg;

}

  
  ```
 
å½“å‰å¼•æ“é…ç½®ä»£ç ï¼š
   
```java

public class EngineConfig {

/**

* å­˜å‚¨ç”¨æˆ·å›å¤ä¿¡æ¯å¤„ç†èŠ‚ç‚¹ <openId, logicFilter>

*/

protected Map<String, LogicFilter> receiveCache = new HashMap<>();

/**

* å­˜å‚¨ä¸åŒæ¶ˆæ¯ç±»å‹LogicFilteræ ¹èŠ‚ç‚¹ <MsgType, LogicFilter>

*/
protected Map<String, LogicFilter> rootLogicFilterGroup = new HashMap<>();

  
@Resource
private EventLogicFilter eventLogicFilter;


@Resource
private RuleHandleLogicFilter ruleHandleLogicFilter;

@Resource
private NormalLotteryLogicFilter normalLotteryLogicFilter;


/**

* ç»„è£…æ¶ˆæ¯å¼•æ“èŠ‚ç‚¹

*/
@PostConstruct
public void init() {

// æ¶ˆæ¯å›å¤ç±»å‹èŠ‚ç‚¹

TextLogicFilter textLogicFilter = new TextLogicFilter();

ArrayList<LogicLine> textLogicLines = new ArrayList<>();

LotteryLogicFilter lotteryLogicFilter = new LotteryLogicFilter();

OtherLogicFilter otherLogicFilter = new OtherLogicFilter();

textLogicLines.add(new LogicLine("æŠ½å¥–", lotteryLogicFilter));

textLogicLines.add(new LogicLine("", otherLogicFilter));

textLogicFilter.setLogicLineList(textLogicLines);

  

// é…ç½®æŠ½å¥–å›å¤è§„åˆ™æ ‘

ArrayList<LogicLine> lotteryLogicLine = new ArrayList<>();

lotteryLogicLine.add(new LogicLine("æ­£å¸¸", normalLotteryLogicFilter));

RuleLotteryLogicFilter ruleLotteryLogicFilter = new RuleLotteryLogicFilter();

lotteryLogicLine.add(new LogicLine("è§„åˆ™", ruleLotteryLogicFilter));

lotteryLogicFilter.setLogicLineList(lotteryLogicLine);

  

// è§„åˆ™æŠ½å¥–åç»­èŠ‚ç‚¹

ArrayList<LogicLine> ruleLotteryLogicLine = new ArrayList<>();

ruleLotteryLogicLine.add(new LogicLine("", ruleHandleLogicFilter));

  

ruleLotteryLogicFilter.setLogicLineList(ruleLotteryLogicLine);

  

rootLogicFilterGroup.put("text", textLogicFilter);

rootLogicFilterGroup.put("event", eventLogicFilter);

}
}