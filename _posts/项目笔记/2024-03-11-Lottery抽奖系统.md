---
layout: Â  Â  post
title: Â  Â  Â 2024-06-11-LotteryæŠ½å¥–ç³»ç»Ÿ
subtitle: Â  2024-06-11-LotteryæŠ½å¥–ç³»ç»Ÿ
date: Â  Â  Â  2024-06-11 05:53
author: Â  Â  lily
header-img: img/é¡¹ç›®ç¬”è®°.jpg
catalog: Â  Â true
tags:
Â  Â  - é¡¹ç›®ç¬”è®°
---
# Chapter1ï¼šDDDåˆ†å±‚åŸºç¡€æ‰‹è„šæ¶æ­å»º
DDDåˆ†å±‚æ˜¯é¡¹ç›®åŸºç¡€æ¶æ„è®¾è®¡çš„ä¸€ç§æ¨¡å¼ï¼Œç±»ä¼¼äºwebå¼€å‘ä¸­çš„MVCæ¶æ„ï¼Œæˆ‘è§‰å¾—å°†DDDåˆ†å±‚æ¶æ„ä¸æ›¾ç»å­¦ä¹ è¿‡çš„spring clould Alibabaå¾®æœåŠ¡æ¶æ„ç±»æ¯”ä¼šæ›´ç›¸ä¼¼äº›ã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨DDDæ¶æ„
DDDæ¶æ„åˆ†å±‚åŒ…æ‹¬
## é¡¹ç›®åŸºç¡€æ‰‹è„šæ¶
### åº”ç”¨å±‚-application
è¿™æ˜¯åº”ç”¨å¯åŠ¨å’Œé…ç½®çš„ä¸€å±‚ï¼Œå¦‚ä¸€äº› aop åˆ‡é¢æˆ–è€… config é…ç½®ï¼Œä»¥åŠæ‰“åŒ…é•œåƒéƒ½æ˜¯åœ¨è¿™ä¸€å±‚å¤„ç†ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸“é—¨ä¸ºäº†å¯åŠ¨æœåŠ¡è€Œå­˜åœ¨çš„ã€‚
é€»è¾‘åŒ…è£…ï¼Œç¼–æ’ã€ä»»åŠ¡ã€é¢†åŸŸäº‹ä»¶çš„å‘å¸ƒå’Œè®¢é˜…

### é€šç”¨å±‚-common
é€šç”¨ç±»å‹å®šä¹‰å±‚ï¼Œåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿå¼€å‘ä¸­ï¼Œä¼šæœ‰å¾ˆå¤šç±»å‹çš„å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼›åŸºæœ¬çš„ Responseã€Constants å’Œæšä¸¾ã€‚å®ƒä¼šè¢«å…¶ä»–çš„å±‚è¿›è¡Œå¼•ç”¨ä½¿ç”¨ã€‚

### é¢†åŸŸå±‚-domian
**å°è£…å…·ä½“çš„ä¸šåŠ¡é¢†åŸŸåŠŸèƒ½å®ç°**ï¼Œæ˜¯èšåˆçš„ï¼Œå……è¡€çš„ã€‚
é¢†åŸŸæ¨¡å‹æœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¨¡å—ã€‚æ— è®ºæ€ä¹ˆåšDDDçš„åˆ†å±‚æ¶æ„ï¼Œdomain éƒ½æ˜¯è‚¯å®šå­˜åœ¨çš„ã€‚åœ¨ä¸€å±‚ä¸­ä¼šæœ‰ä¸€ä¸ªä¸ªç»†åˆ†çš„é¢†åŸŸæœåŠ¡ï¼Œåœ¨æ¯ä¸ªæœåŠ¡åŒ…ä¸­ä¼šæœ‰ã€æ¨¡å‹ã€ä»“åº“ã€æœåŠ¡ã€‘è¿™æ ·3éƒ¨åˆ†ã€‚

- model æ¨¡å‹å¯¹è±¡ï¼›
    - aggreateï¼šèšåˆå¯¹è±¡ï¼Œå®ä½“å¯¹è±¡ã€å€¼å¯¹è±¡çš„ååŒç»„ç»‡ï¼Œå°±æ˜¯èšåˆå¯¹è±¡ã€‚
    - entityï¼šå®ä½“å¯¹è±¡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ä½“å¯¹è±¡(Entity)ä¸æ•°æ®åº“æŒä¹…åŒ–å¯¹è±¡(PO)æ˜¯1v1çš„å…³ç³»ï¼Œä½†ä¹Ÿæœ‰ä¸ºäº†å°è£…ä¸€äº›å±æ€§ä¿¡æ¯ï¼Œä¼šå‡ºç°1vnçš„å…³ç³»ã€‚
    - valobjï¼šå€¼å¯¹è±¡ï¼Œé€šè¿‡å¯¹è±¡å±æ€§å€¼æ¥è¯†åˆ«çš„å¯¹è±¡ By ã€Šå®ç°é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹

- repository ä»“å‚¨æœåŠ¡ï¼›ä»æ•°æ®åº“ç­‰æ•°æ®æºä¸­è·å–æ•°æ®ï¼Œä¼ é€’çš„å¯¹è±¡å¯ä»¥æ˜¯èšåˆå¯¹è±¡ã€å®ä½“å¯¹è±¡ï¼Œè¿”å›çš„ç»“æœå¯ä»¥æ˜¯ï¼›å®ä½“å¯¹è±¡ã€å€¼å¯¹è±¡ã€‚å› ä¸ºä»“å‚¨æœåŠ¡æ˜¯ç”±åŸºç¡€å±‚(infrastructure) å¼•ç”¨é¢†åŸŸå±‚(domain)ï¼Œæ˜¯ä¸€ç§ä¾èµ–å€’ç½®çš„ç»“æ„ï¼Œä½†å®ƒå¯ä»¥å¤©ç„¶çš„éš”ç¦»POæ•°æ®åº“æŒä¹…åŒ–å¯¹è±¡è¢«å¼•ç”¨ã€‚
    
- service æœåŠ¡è®¾è®¡ï¼›æŠŠä¸€äº›é‡æ ¸å¿ƒä¸šåŠ¡æ–¹åˆ° service é‡Œå®ç°ã€‚
    
- å¯¹è±¡è§£é‡Š
    
    - DTO æ•°æ®ä¼ è¾“å¯¹è±¡ (data transfer object)ï¼ŒDAOä¸ä¸šåŠ¡å¯¹è±¡æˆ–æ•°æ®è®¿é—®å¯¹è±¡çš„åŒºåˆ«æ˜¯ï¼šDTOçš„æ•°æ®çš„å˜å¼‚å­ä¸è®¿é—®å­ï¼ˆmutatorå’Œaccessorï¼‰ã€è¯­æ³•åˆ†æï¼ˆparserï¼‰ã€åºåˆ—åŒ–ï¼ˆserializerï¼‰æ—¶ä¸ä¼šæœ‰ä»»ä½•å­˜å‚¨ã€è·å–ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å¼‚å¸¸ã€‚å³DTOæ˜¯ç®€å•å¯¹è±¡ï¼Œä¸å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œä½†å¯åŒ…å«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»¥ç”¨äºä¼ è¾“æ•°æ®.

### åŸºç¡€å±‚-infrastructure
åŸºç¡€å±‚ä¾èµ–äº domain é¢†åŸŸå±‚ï¼Œå› ä¸ºåœ¨ domain å±‚å®šä¹‰äº†ä»“å‚¨æ¥å£éœ€è¦åœ¨åŸºç¡€å±‚å®ç°ã€‚è¿™æ˜¯ä¾èµ–å€’ç½®çš„ä¸€ç§è®¾è®¡æ–¹å¼ã€‚
**æä¾›åŸºç¡€çš„åŠŸèƒ½å’ŒæœåŠ¡ï¼ŒåŒ…æ‹¬ï¼šæ•°æ®åº“ï¼ŒRedisï¼ŒESç­‰ã€‚**

### æ¥å£å±‚-interfaces
å› ä¸ºå¾®æœåŠ¡ä¸­å¼•ç”¨çš„ RPC éœ€è¦å¯¹å¤–æä¾›æ¥å£çš„æè¿°ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ–¹åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦å¼•å…¥ Jar åŒ…ï¼Œè®©è°ƒç”¨æ–¹å¥½èƒ½ä¾èµ–æ¥å£çš„å®šä¹‰åšä»£ç†ã€‚
**å®ç°rpcçš„æ¥å£å®šä¹‰**ï¼Œå¼•å…¥åº”ç”¨å±‚æœåŠ¡ï¼Œå°è£…å…·ä½“çš„æ¥å£ã€‚ï¼ˆå„ä¸ªæ¨¡å—çš„æ¥å£ï¼‰

### RPCå®šä¹‰æ¥å£-trigger ï¼ˆrpcå±‚ï¼‰
è§¦å‘å™¨å±‚ï¼Œä¸€èˆ¬ä¹Ÿè¢«å«åš adapter é€‚é…å™¨å±‚ã€‚ç”¨äºæä¾›æ¥å£å®ç°ã€æ¶ˆæ¯æ¥æ”¶ã€ä»»åŠ¡æ‰§è¡Œç­‰ã€‚æ‰€ä»¥å¯¹äºè¿™æ ·çš„æ“ä½œï¼ŒæŠŠå®ƒå«åšè§¦å‘å™¨å±‚ã€‚
æè¿°RPCæ¥å£æ–‡ä»¶ï¼Œç”¨äºæ‰“åŒ…åå¤–éƒ¨å¼•å…¥POMé…ç½®ã€‚ï¼ˆå†…éƒ¨äº’ç›¸è°ƒç”¨çš„æ¥å£ï¼‰

## åˆ†å±‚å…³ç³»

![[Pasted image 20240612133022.png]]
# Chapter2ï¼šRPCæ¡†æ¶çš„è·‘é€š

## ä¸ºä»€ä¹ˆä½¿ç”¨dubboï¼Ÿ
dubboæ˜¯ä¸€æ¬¾é˜¿é‡Œè‡ªç ”çš„RPCæ¡†æ¶
1. å› ä¸ºdubboåº•å±‚é€šä¿¡æ˜¯Socketè€Œä¸æ˜¯httpæ‰€ä»¥é€šä¿¡æ•ˆç‡ä¼šæ›´é«˜
2. dubboæœ‰åˆ†å¸ƒå¼é«˜å¯ç”¨çš„è®¾è®¡ï¼Œåœ¨æŸç»„æœåŠ¡å®•æœºåä¼šè¢«ä»æ³¨å†Œä¸­å¿ƒæ‘˜é™¤ï¼Œä¹‹åæµé‡ä¼šæ‰“åˆ°å…¶ä»–çš„æœåŠ¡ä¸Š
ç±»æ¯”äºopenfeign
```
OpenFeignæ˜¯ä¸€ä¸ªåŸºäºRESTçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ï¼Œå®ƒå¯å¸®åŠ©å¼€å‘äººå‘˜å‘èµ·HTTPè¯·æ±‚å¹¶è°ƒç”¨è¿œç¨‹æœåŠ¡ã€‚å®ƒå¯ä»¥ç®€åŒ–ä¸è¿œç¨‹æœåŠ¡çš„é€šä¿¡ï¼Œå¹¶æä¾›äº†ä¸€ç§å£°æ˜æ€§çš„æ–¹å¼æ¥å®šä¹‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„äº¤äº’ã€‚
```
### dubboå¦‚ä½•ä½¿ç”¨
##### dubboç‰ˆæœ¬æ›´æ–°
**æ³¨æ„ï¼š
ç›®å‰é¡¹ç›®ä½¿ç”¨dubboç‰ˆæœ¬ä¸º2.7.15
å› ä¸ºåŸç‰ˆæœ¬dubboé¡¹ç›®ç‰ˆæœ¬å·²ç»ä¸å†ç»´æŠ¤@serviceæ³¨è§£ï¼Œæ­¤æ—¶å†ä½¿ç”¨å¹¿æ’­ç›´è¿æ¨¡å¼ä¼šæ‰¾ä¸åˆ°æœåŠ¡ç«¯
ï¼ˆåŸä»£ç ä¸­@Serviceè¢«æ ‡è®°å·²è¿‡æ—¶ï¼‰ä»è€ŒæŠ¥é”™**

dubboçš„ä½¿ç”¨åˆ†ä¸ºæ¥å£è°ƒç”¨æ–¹ä»¥åŠæ¥å£æä¾›æ–¹
#### æ¥å£æä¾›æ–¹
æä¾›æ¥å£çš„æè¿°ä¿¡æ¯ï¼šæ¥å£å®šä¹‰ä»¥åŠå†…éƒ¨æ–¹æ³•çš„å®šä¹‰
ä¸€èˆ¬åœ¨DDDç»“æ„ä¸­å®šä¹‰ä¸º
**apiï¼šDubboæ¥å£å®šä¹‰æ¨¡å—**ã€‚åªå®šä¹‰æ¥å£ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åŒ…å«ä¸€äº›å®šä¹‰ä¼ è¾“çš„dtoï¼Œè¿”å›ã€æ¥æ”¶ç±»å‹ç±»ï¼ˆTypesï¼‰ã€‚è¿™éƒ¨åˆ†ç»“æ„éœ€è¦å¯¹å¤–æä¾›jaråŒ…ï¼Œä¹Ÿå°±æ˜¯æ¥å£çš„æè¿°ä¿¡æ¯ï¼ˆåœ¨å¦ä¸€æ–¹è°ƒç”¨ä¹‹å‰éœ€è¦å…ˆinstallåˆ°æœ¬åœ°ä¸­å¤®ä»“åº“å»ï¼‰ã€‚
**ä½†æ˜¯éœ€è¦æ³¨æ„ï¼š**
```
- æ‰€æœ‰çš„ Dubbo æ¥å£ï¼Œå‡ºå…¥å‚ï¼Œé»˜è®¤éƒ½éœ€è¦ç»§æ‰¿ Serializable æ¥å£ã€‚ä¹Ÿå°±æ˜¯ UserReqDTOã€UserResDTOã€Response è¿™3ä¸ªç±»ï¼Œéƒ½å¾—ç»§æ‰¿ Serializable åºåˆ—åŒ–æ¥å£ã€‚
```
**appï¼šåº”ç”¨ç¨‹åºå¯åŠ¨æ¨¡å—ã€‚** springbootçš„é¡¹ç›®å¯åŠ¨å…¥å£
**triggerï¼šæ¥å£å®ç°æ¨¡å—ã€‚** æ­¤å¤„çš„æ¥å£å¯ç”¨æ˜¯å®é™…è°ƒç”¨çš„å‡½æ•°/ä»£ç çš„åœ°æ–¹ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ç°ä»£ç ï¼Œç±»æ¯”äºserviceå±‚çš„å®ç°
```java
@Slf4j
@DubboService(version = "1.0.0")
public class UserService implements IUserService {

    @Override
    public Response<UserResDTO> queryUserInfo(UserReqDTO reqDTO) {
        log.info("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ userId: {} reqStr: {}", reqDTO.getUserId(), JSON.toJSONString(reqDTO));
        try {
            // 1. æ¨¡æ‹ŸæŸ¥è¯¢ã€ä½ å¯ä»¥ä»æ•°æ®åº“æˆ–è€…Redisç¼“å­˜è·å–æ•°æ®ã€‘
            UserResDTO resDTO = UserResDTO.builder()
                    .userId(reqDTO.getUserId())
                    .userName("å°å‚…å“¥")
                    .userAge(20)
                    .build();

            // 2. è¿”å›ç»“æœ
            return Response.<UserResDTO>builder()
                    .code(Constants.ResponseCode.SUCCESS.getCode())
                    .info(Constants.ResponseCode.SUCCESS.getInfo())
                    .data(resDTO).build();
        } catch (Exception e) {
            log.error("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥ userId: {} reqStr: {}", reqDTO.getUserId(), JSON.toJSONString(reqDTO), e);
            return Response.<UserResDTO>builder()
                    .code(Constants.ResponseCode.UN_ERROR.getCode())
                    .info(Constants.ResponseCode.UN_ERROR.getInfo())
                    .build();
        }
    }

}
```

ä½†æ­¤æ—¶ä¸ºRPCè°ƒç”¨æ‰€ä»¥serviceéœ€è¦ä½¿ç”¨Dubboè‡ªå®šä¹‰çš„æ³¨è§£

##### å·¥ç¨‹é…ç½®yml
application.ymlï¼ˆä¸»å¯åŠ¨ç±»ä¸­çš„springbooté…ç½®æ–¹å¼ï¼‰
é¡¹ç›®ä½¿ç”¨dubboçš„é…ç½®ï¼š
1. å…¶ä¸­æœåŠ¡æ³¨å†Œå‘ç°ä½¿ç”¨zookeeperçš„ç›´è¿æµ‹è¯•æ¨¡å¼
2. åŒ…æ‰«æè¦æ‰«æåˆ°å¯¹å¤–æä¾›æœåŠ¡çš„jaråŒ…æ¥å£å®šä¹‰å¤„
```yml
dubbo:
  application:
    name: xfg-dev-tech-dubbo
    version: 1.0.0
  registry:
    address: zookeeper://127.0.0.1:2181 # N/A - æ— zookeeperå¯é…ç½® N/A èµ°ç›´è¿æ¨¡å¼æµ‹è¯•
  protocol:
    name: dubbo
    port: 20881
  scan:
    base-packages: cn.bugstack.dev.tech.dubbo.api

```
æˆ–è€…æ˜¯æ¶ˆè´¹è€…å’ŒæœåŠ¡ç«¯éƒ½ä½¿ç”¨æ— æ³¨å†Œä¸­å¿ƒçš„å¹¿æ’­æ¨¡å¼
```yml
# Dubbo å¹¿æ’­æ–¹å¼é…ç½®  
dubbo:  
  application:  
    name: Lottery  
    version: 1.0.0  
  registry:  
    address: N/A #multicast://224.5.6.7:1234  
  protocol:  
    name: dubbo  
    port: 8101  
  scan:  
    base-packages: com.lily.lottery.rpc
```
**æ³¨æ„**ï¼š
* base-packagesé…ç½®çš„æ˜¯springçº¦å®šæ‰«æçš„åŒ…ï¼Œdubboçš„æ¥å£æ¨¡å—è¦æƒ³è¢«æ‰«æåˆ°ï¼Œä¸»é¡¹ç›®çš„pomä¸­åº”è¯¥è¦**é—´æ¥æˆ–ç›´æ¥**çš„ä¾èµ–æ¥å£æ¨¡å—ã€‚

* springè®²ç©¶çº¦å®šå¤§äºé…ç½®ï¼ŒApplicationçš„åº”ç”¨çš„åŒ…ååº”è¯¥è¦æ¶µç›–è¦†ç›–åˆ°å…¶ä»–çš„åŒ…åã€‚ä¾‹å¦‚Applicationæ‰€åœ¨åŒ…åä¸º `com.lily.dev.dubbo` é‚£ä¹ˆapiæ¥å£çš„åŒ…åå±‚çº§åº”è¯¥æ¯”è¯¥å±‚çº§å¤šä¸€å±‚æˆ–è€…åŒå±‚çº§æ‰å¯æ‰«åˆ°`com.lily.dev.dubbo.api`ã€‚å¦‚æœæ­¤æ—¶Applicationæ‰€åœ¨åŒ…åä¸º `com.lily.dev.dubbo.a.b.c` é‚£ä¹ˆapiæ¥å£çš„åŒ…åå°†ä¸èƒ½å¤Ÿè¢«æ‰«æåˆ°ã€‚

* addressï¼šå¦‚æœé…ç½®çš„æ˜¯ N/A å°±æ˜¯ä¸èµ°ä»»ä½•æ³¨å†Œä¸­å¿ƒï¼Œå°±æ˜¯ä¸ªç›´è¿ï¼Œä¸»è¦ç”¨äºæœ¬åœ°éªŒè¯çš„ã€‚å¦‚æœä½ é…ç½®äº† zookeeper://127.0.0.1:2181 å°±éœ€è¦å…ˆå®‰è£…ä¸€ä¸ª zookeeper ã€‚å¦å¤–ï¼Œå³ä½¿é…ç½®äº†æ³¨å†Œä¸­å¿ƒçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ç›´è¿æµ‹è¯•ã€‚
#### åº”ç”¨æ„å»º
æ•´ä¸ªé¡¹ç›®æ‰§è¡Œinstallï¼ŒjaråŒ…å°±ä¼šè¿›å…¥æœ¬åœ°çš„Mavenä»“åº“ï¼Œæœ¬åœ°è°ƒç”¨å¯ä»¥ä½¿ç”¨è¯¥jaråŒ…ï¼›å…¶æ¬¡å°±å¯ä»¥é€šè¿‡deployå°†æœ¬åœ°çš„jaråŒ…å‘å¸ƒåˆ°ä¸­å¤®ä»“åº“ï¼Œå³ä½¿ä¸åœ¨æœ¬åœ°ç¯å¢ƒä¹Ÿå¯ä»¥ä½¿ç”¨
#### æœåŠ¡ä½¿ç”¨æ–¹
1. pomå¼•å…¥
```xml
<dependency>
    <groupId>com.lily</groupId>
    <artifactId>xxx-dubbo-api</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```
2. æ¶ˆè´¹é…ç½®
ä½¿ç”¨æ–¹ä¹Ÿéœ€è¦é…ç½®å¯¹åº”çš„dubboå±æ€§
```yml
dubbo:
  application:
    name: xfg-dev-tech-dubbo
    version: 1.0.0
  registry:
     address: zookeeper://127.0.0.1:2181
#    address: N/A
  protocol:
    name: dubbo
    port: 20881
```

3. ä»£ç è°ƒç”¨
```java
// ç›´è¿æ¨¡å¼ï¼›@DubboReference(interfaceClass = IUserService.class, url = "dubbo://127.0.0.1:20881", version = "1.0.0")
@DubboReference(interfaceClass = IUserService.class, version = "1.0.0")
private IUserService userService;

@Test
public void test_userService() {
    UserReqDTO reqDTO = UserReqDTO.builder().userId("10001").build();
    Response<UserResDTO> resDTO = userService.queryUserInfo(reqDTO);
    log.info("æµ‹è¯•ç»“æœ req: {} res: {}", JSON.toJSONString(reqDTO), JSON.toJSONString(resDTO));
}
```

- é…ç½®äº† zookeeper å°±ç”¨ç¬¬ä¸€ä¸ªï¼Œä»£ç ä¸­å¯¹åº”Â `@DubboReference(interfaceClass = IUserService.class, version = "1.0.0")`
- é…ç½®äº† N/A å°±ç”¨ç¬¬äºŒä¸ªï¼Œä»£ç ä¸­å¿…é¡»æŒ‡å®šç›´è¿ã€‚`@DubboReference(interfaceClass = IUserService.class, url = "dubbo://127.0.0.1:20881", version = "1.0.0")`
## é¡¹ç›®å®Œå–„
### åˆ›å»ºæŠ½å¥–æ´»åŠ¨è¡¨
ç”¨äºæµ‹è¯•ç®€å•çš„rpcæµç¨‹, ä½†æ˜¯æ³¨æ„ï¼Œæ’å…¥æ•°æ®æ—¶ä¼šå‘ç”Ÿä¹±ç é—®é¢˜ã€‚
æ´»åŠ¨è¡¨ï¼šæ˜¯ä¸€ä¸ªç”¨äºé…ç½®æŠ½å¥–æ´»åŠ¨çš„æ€»è¡¨ï¼Œç”¨äºå­˜æ”¾æ´»åŠ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šIDã€åç§°ã€æè¿°ã€æ—¶é—´ã€åº“å­˜ã€å‚ä¸æ¬¡æ•°ç­‰ã€‚
```sql
CREATE TABLE `activity` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
  `activity_id` bigint(20) NOT NULL COMMENT 'æ´»åŠ¨ID',
  `activity_name` varchar(64) CHARACTER SET utf8mb4 DEFAULT NULL COMMENT 'æ´»åŠ¨åç§°',
  `activity_desc` varchar(128) CHARACTER SET utf8mb4 DEFAULT NULL COMMENT 'æ´»åŠ¨æè¿°',
  `begin_date_time` datetime DEFAULT NULL COMMENT 'å¼€å§‹æ—¶é—´',
  `end_date_time` datetime DEFAULT NULL COMMENT 'ç»“æŸæ—¶é—´',
  `stock_count` int(11) DEFAULT NULL COMMENT 'åº“å­˜',
  `take_count` int(11) DEFAULT NULL COMMENT 'æ¯äººå¯å‚ä¸æ¬¡æ•°',
  `state` tinyint(2) DEFAULT NULL COMMENT 'æ´»åŠ¨çŠ¶æ€ï¼š1ç¼–è¾‘ã€2æå®¡ã€3æ’¤å®¡ã€4é€šè¿‡ã€5è¿è¡Œ(å®¡æ ¸é€šè¿‡åworkeræ‰«æçŠ¶æ€)ã€6æ‹’ç»ã€7å…³é—­ã€8å¼€å¯',
  `creator` varchar(64) CHARACTER SET utf8mb4 DEFAULT NULL COMMENT 'åˆ›å»ºäºº',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_activity_id` (`activity_id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='æ´»åŠ¨é…ç½®';
```
### å­æ¨¡å—ä¾èµ–é…ç½®
---

ç°æœ‰å·¥ç¨‹æ¨¡å—ä¾èµ–å…³ç³»ï¼š
- lottery-applicationï¼Œåº”ç”¨å±‚ï¼Œå¼•ç”¨ï¼š`domain`
- lottery-commonï¼Œé€šç”¨åŒ…ï¼Œå¼•ç”¨ï¼š`æ— `
- lottery-domainï¼Œé¢†åŸŸå±‚ï¼Œå¼•ç”¨ï¼š`infrastructure`
- lottery-infrastructureï¼ŒåŸºç¡€å±‚ï¼Œå¼•ç”¨ï¼š`æ— `
- lottery-interfacesï¼Œæ¥å£å±‚ï¼Œå¼•ç”¨ï¼š`application`ã€`rpc`
- lottery-rpcï¼ŒRPCæ¥å£å®šä¹‰å±‚ï¼Œå¼•ç”¨ï¼š`common`
---

æ­¤æ—¶é¡¹ç›®ç€é‡é…ç½®ä»¥ä¸‹ä¸‰ä¸ªæ¨¡å—
- lottery-infrastructure
- lottery-interfaces
- lottery-rpc
#### interfacesæ¥å£æ¨¡å—
##### æ¨¡å—ç»“æ„
å®šä¹‰äº†ä¸»å¯åŠ¨ç±»ï¼Œç”±äºè¯¥æ¨¡å—æ˜¯æ•´ä¸ªé¡¹ç›®çš„å‡ºå£ã€‚
- è¯¥æ¨¡å—å®ç°äº†RPCå±‚å®šä¹‰çš„æ¥å£
- åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰mybatisé…ç½®ï¼ˆåœ¨æ¥å£å®ç°ç±»ä¸­ä¼šé€šè¿‡mybatisè®¿é—®æ•°æ®ä»“ï¼‰ï¼Œé¡¹ç›®å¯åŠ¨ç«¯å£å·ï¼Œä»¥åŠdubboå¯¹åº”é…ç½®
- å¯¹åº”çš„éœ€è¦mybatisçš„ mapperé…ç½®æ–‡ä»¶
![[Pasted image 20240613210022.png]]
dubboå¯¹åº”çš„ymlé…ç½®
```yml
# Dubbo å¹¿æ’­æ–¹å¼é…ç½®
dubbo:
  application:
    name: Lottery
    version: 1.0.0
  registry:
    address: N/A #multicast://224.5.6.7:1234
  protocol:
    name: dubbo
    port: 20880
  scan:
    base-packages: com.lily.lottery.rpc
```
- å¹¿æ’­æ¨¡å¼çš„é…ç½®å”¯ä¸€åŒºåˆ«åœ¨äºæ³¨å†Œåœ°å€ï¼Œ`registry.address = multicast://224.5.6.7:1234`(æ­¤æ—¶ä¸ºæ³¨å†Œåœ°å€)ï¼ŒæœåŠ¡æä¾›è€…å’ŒæœåŠ¡è°ƒç”¨è€…éƒ½éœ€è¦é…ç½®ç›¸åŒçš„ğŸ“¢å¹¿æ’­åœ°å€ã€‚æˆ–è€…é…ç½®ä¸º N/A ç”¨äºç›´è¿æ¨¡å¼ä½¿ç”¨
- applicationï¼Œé…ç½®åº”ç”¨åç§°å’Œç‰ˆæœ¬
- protocolï¼Œé…ç½®çš„é€šä¿¡åè®®å’Œç«¯å£
- scanï¼Œç›¸å½“äº Spring ä¸­è‡ªåŠ¨æ‰«æåŒ…çš„åœ°å€ï¼Œå¯ä»¥æŠŠæ­¤åŒ…ä¸‹çš„æ‰€æœ‰ rpc æ¥å£éƒ½æ³¨å†Œåˆ°æœåŠ¡ä¸­
##### pomæ–‡ä»¶
`lottery-interfaces` ä½œä¸ºç³»ç»Ÿçš„ war åŒ…å·¥ç¨‹ï¼Œåœ¨æ„å»ºå·¥ç¨‹æ—¶å€™éœ€è¦ä¾èµ–äº POM ä¸­é…ç½®çš„ç›¸å…³ä¿¡æ¯ã€‚é‚£è¿™é‡Œå°±éœ€è¦æ³¨æ„ä¸‹ï¼Œä½œä¸º Lottery å·¥ç¨‹ä¸‹çš„ä¸» pom.xml éœ€è¦å®Œæˆå¯¹ SpringBoot çˆ¶æ–‡ä»¶çš„ä¾èµ–ï¼Œæ­¤å¤–è¿˜éœ€è¦å®šä¹‰ä¸€äº›ç”¨äºå…¶ä»–æ¨¡å—å¯ä»¥å¼•å…¥çš„é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼šjdkç‰ˆæœ¬ã€ç¼–ç æ–¹å¼ç­‰ã€‚è€Œå…¶ä»–å±‚åœ¨ä¾èµ–äºå·¥ç¨‹æ€» pom.xml åè¿˜éœ€è¦é…ç½®è‡ªå·±çš„ä¿¡æ¯ã€‚
- lottery-interfaces æ˜¯æ•´ä¸ªç¨‹åºçš„å‡ºå£ï¼Œä¹Ÿæ˜¯ç”¨äºæ„å»º War åŒ…çš„å·¥ç¨‹æ¨¡å—ï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°ä¸€ä¸ª `<packaging>war</packaging>` çš„é…ç½®ã€‚
- åœ¨ dependencies ä¼šåŒ…å«æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„ SpringBoot é…ç½®ï¼Œä¹Ÿä¼šåŒ…æ‹¬å¯¹å…¶ä»–å„ä¸ªæ¨¡å—çš„å¼•å…¥ã€‚
- åœ¨ build æ„å»ºé…ç½®ä¸Šè¿˜ä¼šçœ‹åˆ°ä¸€äº›å…³äºæµ‹è¯•åŒ…çš„å¤„ç†ï¼Œæ¯”å¦‚è¿™é‡ŒåŒ…æ‹¬äº†èµ„æºçš„å¼•å…¥ä¹Ÿå¯ä»¥åŒ…æ‹¬æ„å»ºæ—¶å€™è·³è¿‡æµ‹è¯•åŒ…çš„é…ç½®ã€‚
```xml
<artifactId>lottery-interfaces</artifactId>
<packaging>war</packaging>
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    ...
</dependencies>
<build>
    <finalName>Lottery</finalName>
    <resources>
        <resource>
            <directory>src/main/resources</directory>
            <filtering>true</filtering>
            <includes>
                <include>**/**</include>
            </includes>
        </resource>
    </resources>
    <testResources>
        <testResource>
            <directory>src/test/resources</directory>
            <filtering>true</filtering>
            <includes>
                <include>**/**</include>
            </includes>
        </testResource>
    </testResources>
    <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
        </plugin>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <source>8</source>
                <target>8</target>
            </configuration>
        </plugin>
    </plugins>
</build>
```
#### RPCæ¨¡å—
##### æ¨¡å—ç»“æ„
è¯¥æ¨¡å—æ˜¯æ¶ˆè´¹è€…è°ƒç”¨éœ€è¦ä¾èµ–çš„æ¨¡å—ï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªæ´»åŠ¨ç±»æ¥å£ä»¥åŠå¯¹åº”çš„ä¼ è¾“æ—¶çš„åŒ…è£…ç±»
æ¨¡å—.é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š
![[Pasted image 20240613205636.png]]
##### pomæ–‡ä»¶
```xml
<parent>
    <artifactId>Lottery</artifactId>
    <groupId>cn.itedus.lottery</groupId>
    <version>1.0-SNAPSHOT</version>
</parent>
<modelVersion>4.0.0</modelVersion>
<artifactId>lottery-rpc</artifactId>
<packaging>jar</packaging>
<dependencies>
    <dependency>
        <groupId>cn.itedus.lottery</groupId>
        <artifactId>lottery-common</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
<build>
    <finalName>lottery-rpc</finalName>
    <plugins>
        <!-- ç¼–è¯‘plugin -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <source>${jdk.version}</source>
                <target>${jdk.version}</target>
                <compilerVersion>1.8</compilerVersion>
            </configuration>
        </plugin>
    </plugins>
</build>
```

### å®šä¹‰å¼€å‘ RPC æ¥å£
**å¼€å‘æ¥å£**
```java
@DubboService
public class ActivityBooth implements IActivityBooth {

    @Resource
    private IActivityDao activityDao;

    @Override
    public ActivityRes queryActivityById(ActivityReq req) {

        Activity activity = activityDao.queryActivityById(req.getActivityId());

        ActivityDto activityDto = new ActivityDto();
        activityDto.setActivityId(activity.getActivityId());
        activityDto.setActivityName(activity.getActivityName());
        activityDto.setActivityDesc(activity.getActivityDesc());
        activityDto.setBeginDateTime(activity.getBeginDateTime());
        activityDto.setEndDateTime(activity.getEndDateTime());
        activityDto.setStockAllTotal(activity.getStockAllTotal());
        activityDto.setStockDayTotal(activity.getStockDayTotal());
        activityDto.setTakeAllCount(activity.getStockAllTotal());
        activityDto.setTakeDayCount(activity.getStockDayTotal());

        return new ActivityRes(new Result(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo()), activityDto);
    }

}
```

- ç”¨äºå®ç° RPC æ¥å£çš„å®ç°ç±» ActivityBooth ä¸Šæœ‰ä¸€ä¸ªæ³¨è§£ @DubboServiceï¼Œè¿™ä¸ªæ³¨è§£æ˜¯æ¥è‡ªäº Dubbo çš„ `org.apache.dubbo.config.annotation.Service`ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªåŒ…ä¸‹å«æœ‰æ­¤æ³¨è§£é…ç½®çš„ç±»å¯ä»¥è¢« Dubbo ç®¡ç†ã€‚
- åœ¨ queryActivityById åŠŸèƒ½å®ç°ä¸­ç›®å‰è¿˜æ¯”è¾ƒç²—ç³™ï¼Œä½†å¤§ä½“å¯ä»¥çœ‹å‡ºè¿™æ˜¯å¯¹æ•°æ®åº“çš„æ“ä½œä»¥åŠå¯¹ç»“æœçš„å°è£…ï¼Œæä¾› DTO çš„å¯¹è±¡å¹¶è¿”å› Res ç»“æœã€‚_ç›®å‰dtoçš„åˆ›å»ºåç»­å¯ä»¥ä½¿ç”¨é—¨é¢æ¨¡å¼å’Œå·¥å…·ç±»è¿›è¡Œå¤„ç†_
# æŠ½å¥–æ´»åŠ¨åº“è¡¨è®¾è®¡
### éœ€è¦å“ªäº›åº“è¡¨ï¼Ÿ
- æ´»åŠ¨é…ç½®ï¼Œactivityï¼šæä¾›æ´»åŠ¨çš„åŸºæœ¬é…ç½®
- ç­–ç•¥é…ç½®ï¼Œstrategyï¼šç”¨äºé…ç½®æŠ½å¥–ç­–ç•¥ï¼Œæ¦‚ç‡ã€ç©æ³•ã€åº“å­˜ã€å¥–å“
- ç­–ç•¥æ˜ç»†ï¼Œstrategy_detailï¼šæŠ½å¥–ç­–ç•¥çš„å…·ä½“æ˜ç»†é…ç½®
- å¥–å“é…ç½®ï¼Œawardï¼šç”¨äºé…ç½®å…·ä½“å¯ä»¥å¾—åˆ°çš„å¥–å“
- ç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•è¡¨ï¼Œuser_take_activityï¼šæ¯ä¸ªç”¨æˆ·å‚ä¸æ´»åŠ¨éƒ½ä¼šè®°å½•ä¸‹ä»–çš„å‚ä¸ä¿¡æ¯ï¼Œæ—¶é—´ã€æ¬¡æ•°
- ç”¨æˆ·æ´»åŠ¨å‚ä¸æ¬¡æ•°è¡¨ï¼Œuser_take_activity_countï¼šç”¨äºè®°å½•å½“å‰å‚ä¸äº†å¤šå°‘æ¬¡
- ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨ï¼Œuser_strategy_export_001~004ï¼šæœ€ç»ˆç­–ç•¥ç»“æœçš„ä¸€ä¸ªè®°å½•ï¼Œä¹Ÿå°±æ˜¯å¥–å“ä¸­å¥–ä¿¡æ¯çš„å†…å®¹

### 1. lottery.sql

#### æ´»åŠ¨ä¿¡æ¯è¡¨
```
create database lottery;

-- auto-generated definition
create table activity
(
    id            bigint auto_increment comment 'è‡ªå¢ID',
    activityId    bigint       null comment 'æ´»åŠ¨ID',
    activityName  varchar(64)  not null comment 'æ´»åŠ¨åç§°',
    activityDesc  varchar(128) null comment 'æ´»åŠ¨æè¿°',
    beginDateTime datetime     not null comment 'å¼€å§‹æ—¶é—´',
    endDateTime   datetime     not null comment 'ç»“æŸæ—¶é—´',
    stockCount    int          not null comment 'åº“å­˜',
    takeCount     int          null comment 'æ¯äººå¯å‚ä¸æ¬¡æ•°',
    state         int          null comment 'æ´»åŠ¨çŠ¶æ€ï¼šç¼–è¾‘ã€æå®¡ã€æ’¤å®¡ã€é€šè¿‡ã€è¿è¡Œã€æ‹’ç»ã€å…³é—­ã€å¼€å¯',
    creator       varchar(64)  not null comment 'åˆ›å»ºäºº',
    createTime    datetime     not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime    datetime     not null comment 'ä¿®æ”¹æ—¶é—´',
    constraint activity_id_uindex
        unique (id)
)
    comment 'æ´»åŠ¨é…ç½®';

alter table activity
    add primary key (id);

```

#### å¥–å“ä¿¡æ¯è¡¨
```
-- auto-generated definition
create table award
(
    id           bigint(11) auto_increment comment 'è‡ªå¢ID'
        primary key,
    awardId      bigint                             null comment 'å¥–å“ID',
    awardType    int(4)                             null comment 'å¥–å“ç±»å‹ï¼ˆæ–‡å­—æè¿°ã€å…‘æ¢ç ã€ä¼˜æƒ åˆ¸ã€å®ç‰©å¥–å“æš‚æ— ï¼‰',
    awardCount   int                                null comment 'å¥–å“æ•°é‡',
    awardName    varchar(64)                        null comment 'å¥–å“åç§°',
    awardContent varchar(128)                       null comment 'å¥–å“å†…å®¹ã€Œæ–‡å­—æè¿°ã€Keyã€ç ã€',
    createTime   datetime default CURRENT_TIMESTAMP null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime default CURRENT_TIMESTAMP null comment 'updateTime'
)
    comment 'å¥–å“é…ç½®';
```

#### æŠ½å¥–ç­–ç•¥è¡¨
```
-- auto-generated definition
create table strategy
(
    id           bigint(11) auto_increment comment 'è‡ªå¢ID'
        primary key,
    strategyId   bigint(11)   not null comment 'ç­–ç•¥ID',
    strategyDesc varchar(128) null comment 'ç­–ç•¥æè¿°',
    strategyMode int(4)       null comment 'ç­–ç•¥æ–¹å¼ã€Œ1:å•é¡¹æ¦‚ç‡ã€2:æ€»ä½“æ¦‚ç‡ã€',
    grantType    int(4)       null comment 'å‘æ”¾å¥–å“æ–¹å¼ã€Œ1:å³æ—¶ã€2:å®šæ—¶[å«æ´»åŠ¨ç»“æŸ]ã€3:äººå·¥ã€',
    grantDate    datetime     null comment 'å‘æ”¾å¥–å“æ—¶é—´',
    extInfo      varchar(128) null comment 'æ‰©å±•ä¿¡æ¯',
    createTime   datetime     null comment 'åˆ›å»ºæ—¶é—´',
    updateTime   datetime     null comment 'ä¿®æ”¹æ—¶é—´',
    constraint strategy_strategyId_uindex
        unique (strategyId)
)
    comment 'ç­–ç•¥é…ç½®';

-- auto-generated definition

```

#### æŠ½å¥–è¯¦æƒ…è¡¨
æ¯”å¦‚æŠ½å¥–æ—¶é€‰æ‹©çš„æŠ½å¥–ç­–ç•¥æ˜¯å“ªä¸ª
æ¯”å¦‚å¥–å“
```
create table strategy_detail  
(  
    id                bigint(11) auto_increment comment 'è‡ªå¢ID'  
        primary key,  
    strategyId        bigint(11)    not null comment 'ç­–ç•¥ID',  
    awardId           bigint(11)    null comment 'å¥–å“ID',  
    awardCount        int           null comment 'å¥–å“æ•°é‡',  
    awardRate         decimal(5, 2) null comment 'ä¸­å¥–æ¦‚ç‡',  
    createTime        datetime      null comment 'åˆ›å»ºæ—¶é—´',  
    updateTime        datetime      null comment 'ä¿®æ”¹æ—¶é—´',  
    awardSurplusCount int default 0 null comment 'å¥–å“å‰©ä½™åº“å­˜'  
)  
    comment 'æŠ½å¥–æƒ…å†µè¡¨';
```

### [](#2-lottery_01sql-lottery_02sql)2. lottery_01.sql ~ lottery_02.sql

```
create database lottery_01;

-- auto-generated definition
create table user_take_activity
(
    id           bigint    null,
    uId          tinytext  null,
    takeId       bigint    null,
    activityId   bigint    null,
    activityName tinytext  null,
    takeDate     timestamp null,
    takeCount    int       null,
    uuid         tinytext  null,
    createTime   timestamp null,
    updateTime   timestamp null
)
    comment 'ç”¨æˆ·å‚ä¸æ´»åŠ¨è®°å½•è¡¨';

-- auto-generated definition
create table user_take_activity_count
(
    id         bigint    null,
    uId        tinytext  null,
    activityId bigint    null,
    totalCount int       null,
    leftCount  int       null,
    createTime timestamp null,
    updateTime timestamp null
)
    comment 'ç”¨æˆ·æ´»åŠ¨å‚ä¸æ¬¡æ•°è¡¨';

-- auto-generated definition
create table user_strategy_export_001(id           bigint     null,uId          mediumtext null,activityId   bigint     null,orderId      bigint     null,strategyId   bigint     null,strategyType int        null,grantType    int        null,grantDate    timestamp  null,grantState   int        null,awardId      bigint     null,awardType    int        null,awardName    mediumtext null,awardContent mediumtext null,uuid         mediumtext null,createTime   timestamp  null,updateTime   timestamp  null) comment 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨';
create table user_strategy_export_002(id           bigint     null,uId          mediumtext null,activityId   bigint     null,orderId      bigint     null,strategyId   bigint     null,strategyType int        null,grantType    int        null,grantDate    timestamp  null,grantState   int        null,awardId      bigint     null,awardType    int        null,awardName    mediumtext null,awardContent mediumtext null,uuid         mediumtext null,createTime   timestamp  null,updateTime   timestamp  null) comment 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨';
create table user_strategy_export_003(id           bigint     null,uId          mediumtext null,activityId   bigint     null,orderId      bigint     null,strategyId   bigint     null,strategyType int        null,grantType    int        null,grantDate    timestamp  null,grantState   int        null,awardId      bigint     null,awardType    int        null,awardName    mediumtext null,awardContent mediumtext null,uuid         mediumtext null,createTime   timestamp  null,updateTime   timestamp  null) comment 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨';
create table user_strategy_export_004(id           bigint     null,uId          mediumtext null,activityId   bigint     null,orderId      bigint     null,strategyId   bigint     null,strategyType int        null,grantType    int        null,grantDate    timestamp  null,grantState   int        null,awardId      bigint     null,awardType    int        null,awardName    mediumtext null,awardContent mediumtext null,uuid         mediumtext null,createTime   timestamp  null,updateTime   timestamp  null) comment 'ç”¨æˆ·ç­–ç•¥è®¡ç®—ç»“æœè¡¨';

```

---

1. è¿™äº›åº“è¡¨æ˜¯ç”¨äºæ”¯æ’‘èµ·æŠ½å¥–ç³»ç»Ÿå¼€å‘çš„å¿…å¤‡è¡¨ï¼Œåç»­å¯èƒ½ä¼šéšç€åŠŸèƒ½çš„å¼€å‘åšé€‚å½“çš„è°ƒæ•´ã€‚
2. æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå›´ç»•è¿™äº›åº“è¡¨ä¸€ç‚¹ç‚¹å®ç°å„ä¸ªé¢†åŸŸçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼šæŠ½å¥–ç­–ç•¥é¢†åŸŸã€å¥–å“å‘æ”¾é¢†åŸŸã€æ´»åŠ¨ä¿¡æ¯é¢†åŸŸç­‰
# æŠ½å¥–æ¨¡å—å®ç°

## ä»£ç ç»“æ„
é¦–å…ˆæ˜¯domianæ¨¡å—ä¸­æŠ½å¥–æ¨¡å—çš„å®ç°
æŠ½å¥–ç³»ç»Ÿå·¥ç¨‹é‡‡ç”¨DDDæ¶æ„ + Moduleæ¨¡å—æ–¹å¼æ­å»ºï¼Œlottery-domain æ˜¯ä¸“é—¨ç”¨äºå¼€å‘é¢†åŸŸæœåŠ¡çš„æ¨¡å—ï¼Œä¸é™äºç›®å‰çš„æŠ½å¥–ç­–ç•¥åœ¨æ­¤æ¨¡å—ä¸‹å®ç°è¿˜æœ‰ä»¥åéœ€è¦å®ç°çš„**æ´»åŠ¨é¢†åŸŸã€è§„åˆ™å¼•æ“ã€ç”¨æˆ·æœåŠ¡**ç­‰éƒ½éœ€è¦åœ¨è¿™ä¸ªæ¨¡å—å®ç°å¯¹åº”çš„é¢†åŸŸåŠŸèƒ½ã€‚

strategy æ˜¯ç¬¬1ä¸ªåœ¨ domain ä¸‹å®ç°çš„æŠ½å¥–ç­–ç•¥é¢†åŸŸï¼Œåœ¨é¢†åŸŸåŠŸèƒ½å¼€å‘çš„æœåŠ¡ä¸‹ä¸»è¦å«æœ‰modelã€repositoryã€serviceä¸‰å—åŒºåŸŸï¼Œæ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»ä¸‹åœ¨æŠ½å¥–é¢†åŸŸä¸­è¿™ä¸‰å—åŒºåŸŸéƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚

- modelï¼Œç”¨äºæä¾›voã€reqã€res å’Œ aggregates èšåˆå¯¹è±¡ã€‚
- repositoryï¼Œæä¾›ä»“å‚¨æœåŠ¡ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å¯¹Mysqlã€Redisç­‰æ•°æ®çš„ç»Ÿä¸€åŒ…è£…ã€‚
- serviceï¼Œæ˜¯å…·ä½“çš„ä¸šåŠ¡é¢†åŸŸé€»è¾‘å®ç°å±‚ï¼Œåœ¨è¿™ä¸ªåŒ…ä¸‹å®šä¹‰äº†algorithmæŠ½å¥–ç®—æ³•å®ç°å’Œå…·ä½“çš„æŠ½å¥–ç­–ç•¥åŒ…è£… draw å±‚ï¼Œå¯¹å¤–æä¾›æŠ½å¥–æ¥å£ IDrawExec#doDrawExec
## æŠ½å¥–ç­–ç•¥ç®—æ³•
ä¸¤ç§æŠ½å¥–ç®—æ³•æè¿°ï¼Œåœºæ™¯A20%ã€B30%ã€C50%

- **æ€»ä½“æ¦‚ç‡**ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCå¥–å“çš„æ¦‚ç‡æŒ‰ç…§ `3:5` å‡åˆ†ï¼Œç›¸å½“äºBå¥–å“ä¸­å¥–æ¦‚ç‡ç”± `0.3` å‡ä¸º `0.375`
- **å•é¡¹æ¦‚ç‡**ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCä¿æŒç›®å‰ä¸­å¥–æ¦‚ç‡ï¼Œç”¨æˆ·æŠ½å¥–æ‰”æœ‰20%ä¸­ä¸ºAï¼Œå› Aåº“å­˜æŠ½ç©ºåˆ™ç»“æœå±•ç¤ºä¸ºæœªä¸­å¥–ã€‚_ä¸ºäº†è¿è¥æˆæœ¬ï¼Œé€šå¸¸è¿™ç§æƒ…å†µçš„ä½¿ç”¨çš„æ¯”è¾ƒå¤š_\

### æ–æ³¢é‚£å¥‘ç®—æ³•
ç”¨äºåˆå§‹åŒ–

### æ€»ä½“æ¦‚ç‡æŠ½å¥–
- é¦–å…ˆè¦ä»æ€»çš„ä¸­å¥–åˆ—è¡¨ä¸­æ’é™¤æ‰é‚£äº›è¢«æ’é™¤æ‰çš„å¥–å“ï¼Œè¿™äº›å¥–å“ä¼šæ¶‰åŠåˆ°æ¦‚ç‡çš„å€¼é‡æ–°è®¡ç®—ã€‚
- å¦‚æœæ’é™¤åå‰©ä¸‹çš„å¥–å“åˆ—è¡¨å°äºç­‰äº1ï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å›å¯¹åº”ä¿¡æ¯
- æ¥ä¸‹æ¥å°±ä½¿ç”¨éšæœºæ•°å·¥å…·ç”Ÿäº§ä¸€ä¸ª100å†…çš„éšå€¼ä¸å¥–å“åˆ—è¡¨ä¸­çš„å€¼è¿›è¡Œå¾ªç¯æ¯”å¯¹ï¼Œç®—æ³•æ—¶é—´å¤æ‚åº¦O(n)
ä»£ç 
```java
@Component("defaultRandomDrawAlgorithm")  
public class DefaultRandomDrawAlgorithm extends BaseAlgorithm {  
    //  
    /**  
     * éšæœºæŠ½å¥–  
     * çˆ¶ç±»ä¸­æœªå®ç°çš„æŠ½è±¡æ–¹æ³•  
     * @param strategyId ç­–ç•¥ID  
     * @param excludeAwardIds å·²ç»è¢«æŠ½å®Œçš„å¥–å“IDåˆ—è¡¨  
     *                        ä¸ç”¨äºæ„å»ºæ¦‚ç‡å…ƒç»„çš„å¥–å“ä¿¡æ¯  
     * @return å¥–å“ID  
     */    @Override  
    public String randomDraw(Long strategyId, List<String> excludeAwardIds) {  
  
        /**  
         * æ’é™¤å·²ç»è¢«æŠ½å®Œçš„å¥–å“IDï¼Œä¿å­˜å‰©ä¸‹çš„è¿˜å¯ä»¥æŠ½å¥–çš„ID  
         * è‹¥å…¨éƒ¨å¥–å“éƒ½è¢«æŠ½å®Œäº†ï¼Œåˆ™ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜æ²¡æœ‰è·å¥–  
         * å¦‚æœåªå‰©ä¸‹ä¸€ä¸ªå¥–å“äº†ï¼Œé‚£ä¹ˆä¹‹é—´è·å¾—è¯¥å¥–å“  
         * è‹¥æœ‰å¤šä¸ªæ’é™¤å¥–å“ï¼Œåˆ™æ–°å»ºæŠ½å¥–è§„åˆ™éšæœºæŠ½å–ä¸€ä¸ªå¥–å“  
         * todo: ä¼˜åŒ–  
         */  
        // åˆå§‹åŒ–å·®å¼‚åˆ†æ¯  
        BigDecimal differenceDenominator = BigDecimal.ZERO;  
        // åˆå§‹åŒ–éæŠ½å¥–å¥–å“åˆ—è¡¨  
        List<AwardRateInfo> differenceAwardRateList = new ArrayList<>();  
        // è·å–æ¦‚ç‡å…ƒç»„ä¸­æ‰€æœ‰çš„å¥–å“ç§ç±»  
        List<AwardRateInfo> awardRateInfos = awardRateInfoMap.get(strategyId);  
        // éå†æ‰€æœ‰å¥–å“ç§ç±»  
        for (AwardRateInfo awardRateInfo : awardRateInfos) {  
            // è·å–å¥–å“ID  
            String awardId = awardRateInfo.getAwardId();  
            // å¦‚æœå¥–å“è¿˜æ²¡æœ‰è¢«æŠ½å®Œåˆ™åŠ å…¥å·®å¼‚å¥–å“åˆ—è¡¨  
            if (!excludeAwardIds.contains(awardId)) {  
                differenceAwardRateList.add(awardRateInfo);  
                differenceDenominator = differenceDenominator.add(awardRateInfo.getAwardRate());  
            }  
        }  
        // å¦‚æœå·®å¼‚å¥–å“åˆ—è¡¨ä¸ºç©ºåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²  
        if (differenceAwardRateList.isEmpty()) return "";  
        // å¦‚æœå·®å¼‚å¥–å“åˆ—è¡¨åªæœ‰ä¸€ä¸ªåˆ™è¿”å›è¯¥å¥–å“ID  
        if (differenceAwardRateList.size() == 1) return differenceAwardRateList.get(0).getAwardId();  
        /**  
         * æ–°å»ºè§„åˆ™é‡æ–°åˆ†é…æ¦‚ç‡æŠ½å¥–  
         * ä»å·®å¼‚å¥–å“åˆ—è¡¨ä¸­éšæœºæŠ½å–å¥–å“  
         */  
        // è·å–éšæœºæ¦‚ç‡å€¼ä¸º0-100çš„éšæœºæ•°  
        SecureRandom secureRandom = new SecureRandom();  
        int randomVal = secureRandom.nextInt(100) + 1;  
        // å¾ªç¯è·å–å¥–å“  
        String awardId = "";  
        int cursorVal = 0;  
        for (AwardRateInfo awardRateInfo : differenceAwardRateList) {  
            // è®¡ç®—å¥–å“æ¦‚ç‡å€¼  
            // Divide the award rate by the difference denominator, multiply by 100, and round up to the nearest integer  
            int rateVal = awardRateInfo.getAwardRate().divide(differenceDenominator, 2, BigDecimal.ROUND_UP).multiply(new BigDecimal(100)).intValue();  
            // å¦‚æœéšæœºæ•°å°äºç­‰äºå½“å‰å¥–å“æ¦‚ç‡å€¼åˆ™è¿”å›è¯¥å¥–å“ID  
            if (randomVal <= (cursorVal + rateVal)) {  
                awardId = awardRateInfo.getAwardId();  
                break;  
            }  
            cursorVal += rateVal;  
        }  
        // æŠ½ä¸­å½“å‰å¥–å“ID  
        return awardId;  
    }  
}****
```


### å•é¡¹æ¦‚ç‡æŠ½å¥–

**ç®—æ³•æè¿°**ï¼šå•é¡¹æ¦‚ç‡ç®—æ³•ä¸æ¶‰åŠå¥–å“æ¦‚ç‡é‡æ–°è®¡ç®—çš„é—®é¢˜ï¼Œåˆ†é…å¥½çš„æ¦‚ç‡ç»“æœæ˜¯å¯ä»¥å›ºå®šä¸‹æ¥çš„
ä¸»è¦æ˜¯ç›´æ¥è·å–å’ŒæŸ¥è¯¢ä¹‹å‰çš„æ¦‚ç‡å…ƒç»„

```java
/**  
 * Created by lily via on 2024/6/15 14:59 * å•æ¬¡æŠ½å¥–éšæœºæŠ½å¥–ç®—æ³•å®ç°  
 * ç­–ç•¥æ¨¡å¼ä¸å·¥å‚æ¨¡å¼ç»“åˆ  
 *  
 * åœºæ™¯A20%ã€B30%ã€C50%  
 * æ€»ä½“æ¦‚ç‡ï¼šå¦‚æœAå¥–å“æŠ½ç©ºåï¼ŒBå’ŒCå¥–å“çš„æ¦‚ç‡æŒ‰ç…§ 3:5 å‡åˆ†ï¼Œ  
 * ç›¸å½“äºBå¥–å“ä¸­å¥–æ¦‚ç‡ç”± 0.3 å‡ä¸º 0.375  
 */@Component("singleRateRandomDrawAlgorithm")  
//@Primary  
public class SingleRateRandomDrawAlgorithm extends BaseAlgorithm {  
  
    /**  
     * @description: å•é¡¹éšæœºæ¦‚ç‡æŠ½å¥–  
     * @author Lily Via  
     * @date 2024/6/15 17:38  
     * @version 1.0  
     */    @Override  
    public String randomDraw(Long strategyId, List<String> excludeAwardIds) {  
        // è·å–ç­–ç•¥å¯¹åº”çš„å…ƒç¥–  
        String[] rateTuple = rateTupleMap.get(strategyId);  
        // todo: æ ¡éªŒrateTupleä¸ä¸ºç©º  
        assert rateTuple != null;  
        // ç”Ÿæˆéšæœºç´¢å¼•  
        int randomVal = new SecureRandom().nextInt(100) + 1;  
        // è½¬æ¢ä¸ºæ–æ³¢é‚£å¥‘æ•£åˆ—ç´¢å¼•  
        int idx = hashIdx(randomVal);  
        // æŸ¥è¯¢æ˜¯å¦ä¸­å¥–  
        String awardId = rateTuple[idx];  
        // å¦‚æœæŠ½ä¸­å¥–å“åœ¨æ’é™¤å¥–å“åˆ—è¡¨ä¸­åˆ™è¿”å›æœªä¸­å¥–ï¼ˆè¯´æ˜è¿™ä¸ªå¥–å“å·²ç»æŠ½å®Œï¼‰  
        if (excludeAwardIds.contains(awardId)) {  
            return "æœªä¸­å¥–";  
        }  
        return awardId;  
    }  
}
```


## æŠ½å¥–æ¨¡å—è®¾è®¡æ¨¡å¼

### æ¨¡æ¿æ¨¡å¼

### ç­–ç•¥æ¨¡å¼
